{% extends "base.html" %}

{% block core %}
<style>
.btn {
  display: inline-block;
  padding: 4px 10px;
  font-size: 12px;
  font-weight: 500;
  text-align: center;
  cursor: pointer;
  border: 1px solid transparent;
  border-radius: 4px;
  transition: all 0.15s ease-in-out;
}
.btn-outline-success {
  color: #28a745;
  background-color: transparent;
  border-color: #28a745;
}
.btn-outline-success:hover {
  color: #fff;
  background-color: #28a745;
}
.btn-outline-danger {
  color: #dc3545;
  background-color: transparent;
  border-color: #dc3545;
}
.btn-outline-danger:hover {
  color: #fff;
  background-color: #dc3545;
}
.btn-group {
  display: inline-flex;
  gap: 4px;
}
</style>

<div class="core_title">
  <h1><a href="{{ url("task", task.id) }}">{{ task.title }} ({{ task.name }})</a> - Add Model Solution</h1>
</div>
<p>Model solutions are reference solutions uploaded by admins to verify that the task's test data and scoring work correctly.</p>

{% set language_required = task.submission_format|any("endswith", ".%l") %}
{% set allow_partial = task.submission_format|length > 1 and not language_required %}

{% if allow_partial %}
<p><strong>You may submit any subset of outputs in a single submission.</strong></p>
{% endif %}

<div style="display: flex; gap: 40px; flex-wrap: wrap;">
<div>
<form enctype="multipart/form-data" action="{{ url("dataset", dataset.id, "model_solutions", "add") }}" method="POST">
  {{ xsrf_form_html|safe }}
  <table>
    <tr>
      <td>Name:</td>
      <td><input type="text" name="name" pattern="[^/\\*?<>|:&quot;]+" title="Cannot contain: / \ * ? < > | : &quot;" required /></td>
      <td style="font-size: 0.9em; color: #666;">(identifier for export, e.g., 'intended', 'bruteforce')</td>
    </tr>
    <tr>
      <td>Description:</td>
      <td><input type="text" name="description" required /></td>
    </tr>
{% if language_required %}
{% set allowed_langs = task.get_allowed_languages() or [] %}
    <tr>
      <td>Language:</td>
      <td>
        <select name="language">
          <option value="" disabled selected>-- Select Language --</option>
{% for lang in allowed_langs %}
          <option value="{{ lang }}">{{ lang }}</option>
{% endfor %}
        </select>
      </td>
    </tr>
{% endif %}
    <tr>
      <td>Expected Score Min:</td>
      <td><input type="number" step="0.01" name="expected_score_min" value="0.0" required /></td>
    </tr>
    <tr>
      <td>Expected Score Max:</td>
      <td><input type="number" step="0.01" name="expected_score_max" value="100.0" required /></td>
    </tr>
{% if subtasks %}
    <tr>
      <td colspan="2"><strong>Expected Subtask Scores:</strong></td>
    </tr>
    <tr>
      <td colspan="2">
        <table class="bordered" style="text-align:center; margin-top: 5px;">
          <thead>
            <tr>
              <th>Subtask</th>
              <th>Expected Min</th>
              <th>Expected Max</th>
              <th>Quick Set</th>
            </tr>
          </thead>
          <tbody>
{% for st in subtasks if st.max_score > 0 %}
            <tr>
              <td>{{ st.display_name }}</td>
              <td><input type="number" step="0.01" name="subtask_{{ st.idx }}_min" value="0" style="width: 80px;" class="subtask-min" data-form="form1" data-max-score="{{ st.max_score }}" /></td>
              <td><input type="number" step="0.01" name="subtask_{{ st.idx }}_max" value="{{ st.max_score }}" style="width: 80px;" class="subtask-max" data-form="form1" data-max-score="{{ st.max_score }}" /></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-danger btn-zero-score" data-idx="{{ st.idx }}" data-form="form1" title="Set to zero">0</button>
                  <button type="button" class="btn btn-outline-success btn-full-score" data-idx="{{ st.idx }}" data-form="form1" data-max-score="{{ st.max_score }}" title="Set to full score ({{ st.max_score }})">Full</button>
                </div>
              </td>
            </tr>
{% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <label>
          <input type="checkbox" class="calc-from-subtasks" data-form="form1" />
          Calculate score range from subtask table
        </label>
      </td>
    </tr>
{% endif %}
{% for filename in task.submission_format %}
    <tr>
      <td>{{ filename }}:</td>
      <td><input type="file" name="{{ filename }}" /></td>
    </tr>
{% endfor %}
  </table>
  <input type="submit" value="Add Model Solution">
  <input type="reset" value="Reset">
</form>
</div>

{% if allow_partial %}
<div>
<form enctype="multipart/form-data" action="{{ url("dataset", dataset.id, "model_solutions", "add") }}" method="POST">
  {{ xsrf_form_html|safe }}
  <table>
    <tr>
      <td>Name:</td>
      <td><input type="text" name="name" pattern="[^/\\*?<>|:&quot;]+" title="Cannot contain: / \ * ? < > | : &quot;" required /></td>
      <td style="font-size: 0.9em; color: #666;">(identifier for export, e.g., 'intended', 'bruteforce')</td>
    </tr>
    <tr>
      <td>Description:</td>
      <td><input type="text" name="description" required /></td>
    </tr>
    <tr>
      <td>Expected Score Min:</td>
      <td><input type="number" step="0.01" name="expected_score_min" value="0.0" required /></td>
    </tr>
    <tr>
      <td>Expected Score Max:</td>
      <td><input type="number" step="0.01" name="expected_score_max" value="100.0" required /></td>
    </tr>
{% if subtasks %}
    <tr>
      <td colspan="2"><strong>Expected Subtask Scores:</strong></td>
    </tr>
    <tr>
      <td colspan="2">
        <table class="bordered" style="text-align:center; margin-top: 5px;">
          <thead>
            <tr>
              <th>Subtask</th>
              <th>Expected Min</th>
              <th>Expected Max</th>
              <th>Quick Set</th>
            </tr>
          </thead>
          <tbody>
{% for st in subtasks if st.max_score > 0 %}
            <tr>
              <td>{{ st.display_name }}</td>
              <td><input type="number" step="0.01" name="subtask_{{ st.idx }}_min" value="0" style="width: 80px;" class="subtask-min" data-form="form2" data-max-score="{{ st.max_score }}" /></td>
              <td><input type="number" step="0.01" name="subtask_{{ st.idx }}_max" value="{{ st.max_score }}" style="width: 80px;" class="subtask-max" data-form="form2" data-max-score="{{ st.max_score }}" /></td>
              <td>
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-danger btn-zero-score" data-idx="{{ st.idx }}" data-form="form2" title="Set to zero">0</button>
                  <button type="button" class="btn btn-outline-success btn-full-score" data-idx="{{ st.idx }}" data-form="form2" data-max-score="{{ st.max_score }}" title="Set to full score ({{ st.max_score }})">Full</button>
                </div>
              </td>
            </tr>
{% endfor %}
          </tbody>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <label>
          <input type="checkbox" class="calc-from-subtasks" data-form="form2" />
          Calculate score range from subtask table
        </label>
      </td>
    </tr>
{% endif %}
    <tr>
      <td>submission.zip:</td>
      <td><input type="file" name="submission" required /></td>
    </tr>
  </table>
  <input type="submit" value="Add Model Solution">
  <input type="reset" value="Reset">
</form>
</div>
{% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full score button handler
    document.querySelectorAll('.btn-full-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var idx = this.dataset.idx;
            var formId = this.dataset.form;
            var maxScore = parseFloat(this.dataset.maxScore);
            var form = this.closest('form');
            var minInput = form.querySelector('input[name="subtask_' + idx + '_min"]');
            var maxInput = form.querySelector('input[name="subtask_' + idx + '_max"]');
            if (minInput) minInput.value = maxScore;
            if (maxInput) maxInput.value = maxScore;
            updateScoreRangeFromSubtasks(form);
        });
    });

    // Zero score button handler
    document.querySelectorAll('.btn-zero-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var idx = this.dataset.idx;
            var form = this.closest('form');
            var minInput = form.querySelector('input[name="subtask_' + idx + '_min"]');
            var maxInput = form.querySelector('input[name="subtask_' + idx + '_max"]');
            if (minInput) minInput.value = 0;
            if (maxInput) maxInput.value = 0;
            updateScoreRangeFromSubtasks(form);
        });
    });

    // Calculate from subtasks checkbox handler
    document.querySelectorAll('.calc-from-subtasks').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var form = this.closest('form');
            if (this.checked) {
                updateScoreRangeFromSubtasks(form);
                // Disable manual score inputs when auto-calculating
                var minInput = form.querySelector('input[name="expected_score_min"]');
                var maxInput = form.querySelector('input[name="expected_score_max"]');
                if (minInput) minInput.readOnly = true;
                if (maxInput) maxInput.readOnly = true;
            } else {
                var minInput = form.querySelector('input[name="expected_score_min"]');
                var maxInput = form.querySelector('input[name="expected_score_max"]');
                if (minInput) minInput.readOnly = false;
                if (maxInput) maxInput.readOnly = false;
            }
        });
    });

    // Update score range when subtask values change
    document.querySelectorAll('.subtask-min, .subtask-max').forEach(function(input) {
        input.addEventListener('input', function() {
            var form = this.closest('form');
            var checkbox = form.querySelector('.calc-from-subtasks');
            if (checkbox && checkbox.checked) {
                updateScoreRangeFromSubtasks(form);
            }
        });
    });

    function updateScoreRangeFromSubtasks(form) {
        var checkbox = form.querySelector('.calc-from-subtasks');
        if (!checkbox || !checkbox.checked) return;

        var minSum = 0;
        var maxSum = 0;
        form.querySelectorAll('.subtask-min').forEach(function(input) {
            minSum += parseFloat(input.value) || 0;
        });
        form.querySelectorAll('.subtask-max').forEach(function(input) {
            maxSum += parseFloat(input.value) || 0;
        });

        var minInput = form.querySelector('input[name="expected_score_min"]');
        var maxInput = form.querySelector('input[name="expected_score_max"]');
        if (minInput) minInput.value = minSum.toFixed(2);
        if (maxInput) maxInput.value = maxSum.toFixed(2);
    }
});
</script>
{% endblock core %}
