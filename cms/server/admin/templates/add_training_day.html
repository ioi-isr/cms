{% extends "base.html" %}

{% block core %}
<div class="core_title">
  <h1>Add Training Day to <a href="{{ url("training_program", training_program.id) }}">{{ training_program.name }}</a></h1>
</div>

<form action="{{ url("training_program", training_program.id, "training_days", "add") }}" method="POST" name="add_training_day">
  {{ xsrf_form_html|safe }}
  <table class="sub_table">
    <tr>
      <td>Name (codename)</td>
      <td><input type="text" name="name" required/></td>
      <td class="hint">A unique identifier for the training day contest</td>
    </tr>
    <tr>
      <td>Description</td>
      <td><input type="text" name="description"/></td>
      <td class="hint">Human-readable description (defaults to name if empty)</td>
    </tr>
    <tr>
      <td>
        <span class="info" title="When the training day starts. If not specified and groups have start times, defaults to the earliest group start time."></span>
        Start time ({{ timezone_name }})
      </td>
      <td><input type="datetime-local" name="start"/></td>
      <td class="hint">When the training day starts (optional, defaults to earliest group time)</td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Duration of the training day. If not specified and groups have durations, defaults to cover all group times."></span>
        Duration
      </td>
      <td>
        <input type="number" name="duration_hours" min="0" style="width: 60px;" placeholder="0"/> hours
        <input type="number" name="duration_minutes" min="0" max="59" style="width: 60px;" placeholder="0"/> minutes
      </td>
      <td class="hint">Duration of the training day (optional)</td>
    </tr>
  </table>

  <h2>Main Groups Configuration</h2>
  <p class="hint">Configure which student tags represent main groups for this training day. Students must have exactly one main group tag to participate. Leave empty if all students can participate.</p>

  <table class="sub_table" id="main-groups-table">
    <thead>
      <tr>
        <th>Tag Name</th>
        <th>Start Time ({{ timezone_name }})</th>
        <th>Duration</th>
        <th>Alphabetical Task Order</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="groups-tbody">
    </tbody>
  </table>

  <button type="button" id="add-group-btn" class="btn btn-small">+ Add Main Group</button>

  <br/><br/>
  <input type="submit" value="Create"/>
</form>

<script>
var allStudentTags = {{ all_student_tags | tojson }};
var groupRowIndex = 0;

function addGroupRow() {
    var tbody = document.getElementById('groups-tbody');
    var row = document.createElement('tr');
    row.id = 'group-row-' + groupRowIndex;

    var tagCell = document.createElement('td');
    var tagInput = document.createElement('input');
    tagInput.type = 'text';
    tagInput.name = 'group_tag_name[]';
    tagInput.placeholder = 'Select a student tag';
    tagInput.style.width = '160px';
    tagCell.appendChild(tagInput);
    row.appendChild(tagCell);

    var startCell = document.createElement('td');
    var startInput = document.createElement('input');
    startInput.type = 'datetime-local';
    startInput.name = 'group_start_time[]';
    startCell.appendChild(startInput);
    row.appendChild(startCell);

    var durationCell = document.createElement('td');
    var hoursInput = document.createElement('input');
    hoursInput.type = 'number';
    hoursInput.name = 'group_duration_hours[]';
    hoursInput.min = '0';
    hoursInput.style.width = '60px';
    hoursInput.placeholder = '0';
    durationCell.appendChild(hoursInput);
    durationCell.appendChild(document.createTextNode(' h '));
    var minutesInput = document.createElement('input');
    minutesInput.type = 'number';
    minutesInput.name = 'group_duration_minutes[]';
    minutesInput.min = '0';
    minutesInput.max = '59';
    minutesInput.style.width = '60px';
    minutesInput.placeholder = '0';
    durationCell.appendChild(minutesInput);
    durationCell.appendChild(document.createTextNode(' m'));
    row.appendChild(durationCell);

    var alphaCell = document.createElement('td');
    alphaCell.style.textAlign = 'center';

    // Add hidden input for stable group ID
    var groupIdInput = document.createElement('input');
    groupIdInput.type = 'hidden';
    groupIdInput.name = 'group_id[]';
    groupIdInput.value = groupRowIndex;
    alphaCell.appendChild(groupIdInput);

    var alphaInput = document.createElement('input');
    alphaInput.type = 'checkbox';
    alphaInput.name = 'group_alphabetical[]';
    alphaInput.value = groupRowIndex;
    alphaCell.appendChild(alphaInput);
    row.appendChild(alphaCell);

    var actionsCell = document.createElement('td');
    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-small';
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = function() { row.remove(); };
    actionsCell.appendChild(removeBtn);
    row.appendChild(actionsCell);

    tbody.appendChild(row);

    // Initialize Tagify on the new input
    if (typeof Tagify !== 'undefined') {
        var tagify = new Tagify(tagInput, {
            mode: 'select',
            whitelist: allStudentTags,
            enforceWhitelist: true,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: true
            },
            originalInputValueFormat: function(valuesArr) {
                return valuesArr.length ? valuesArr[0].value : '';
            }
        });
        tagify.DOM.scope.style.width = '160px';
    }

    groupRowIndex++;
}

document.getElementById('add-group-btn').addEventListener('click', addGroupRow);

// Re-index checkbox values before form submission to match visual order
document.querySelector('form[name="add_training_day"]').addEventListener('submit', function() {
    var checkboxes = document.querySelectorAll('#groups-tbody input[name="group_alphabetical[]"]');
    checkboxes.forEach(function(checkbox, index) {
        checkbox.value = index;
    });
});

</script>

<p>
  <a href="{{ url("training_program", training_program.id, "training_days") }}">Back to training days</a>
</p>
{% endblock core %}
