{% extends "base.html" %}

{% block core %}
<div class="content-constraint" style="max-width: 800px;">
    <!-- Header -->
    <div class="page-title">
        <h1>Add Training Day</h1>
        <div class="page-subtitle">Create a new training day for <a href="{{ url("training_program", training_program.id) }}">{{ training_program.name }}</a></div>
    </div>

    <!-- Form Card -->
    <div class="tp-form-card">
        <form action="{{ url("training_program", training_program.id, "training_days", "add") }}" method="POST" name="add_training_day">
            {{ xsrf_form_html|safe }}

            <div class="tp-form-section">
                <h3 class="tp-form-section-title">Basic Information</h3>

                <div class="tp-form-group">
                    <label class="tp-form-label" for="name">
                        Name (codename)
                        <span class="tp-form-required">*</span>
                    </label>
                    <input type="text" id="name" name="name" class="tp-form-input" placeholder="e.g., day1" required />
                    <div class="tp-form-hint">A unique identifier for the training day contest</div>
                </div>

                <div class="tp-form-group">
                    <label class="tp-form-label" for="description">Description</label>
                    <input type="text" id="description" name="description" class="tp-form-input" placeholder="e.g., Training Day 1 - Graphs" />
                    <div class="tp-form-hint">Human-readable description (defaults to name if empty)</div>
                </div>

                <div class="tp-form-row">
                    <div class="tp-form-group">
                        <label class="tp-form-label" for="start">
                            Start Time ({{ timezone_name }})
                            <span class="tp-form-info" title="When the training day starts. If not specified and groups have start times, defaults to the earliest group start time.">?</span>
                        </label>
                        <input type="datetime-local" id="start" name="start" class="tp-form-input" />
                        <div class="tp-form-hint">Optional, defaults to earliest group time</div>
                    </div>
                    <div class="tp-form-group">
                        <label class="tp-form-label" for="duration">
                            Duration
                            <span class="tp-form-info" title="Duration of the training day. If not specified and groups have durations, defaults to cover all group times.">?</span>
                        </label>
                        <div class="tp-form-duration">
                            <input type="number" id="duration_hours" name="duration_hours" min="0" class="tp-form-input tp-form-input-small" placeholder="0" />
                            <span class="tp-form-duration-label">hours</span>
                            <input type="number" id="duration_minutes" name="duration_minutes" min="0" max="59" class="tp-form-input tp-form-input-small" placeholder="0" />
                            <span class="tp-form-duration-label">minutes</span>
                        </div>
                        <div class="tp-form-hint">Optional</div>
                    </div>
                </div>
            </div>

            <div class="tp-form-section">
                <h3 class="tp-form-section-title">Main Groups Configuration</h3>
                <p class="tp-form-section-desc">Configure which student tags represent main groups for this training day. Students must have exactly one main group tag to participate. Leave empty if all students can participate.</p>

                <div class="tp-groups-table-container">
                    <table class="tp-groups-table" id="main-groups-table">
                        <thead>
                            <tr>
                                <th>Tag Name</th>
                                <th>Start Time ({{ timezone_name }})</th>
                                <th>Duration</th>
                                <th style="text-align: center;">Alphabetical Order</th>
                                <th style="width: 80px;"></th>
                            </tr>
                        </thead>
                        <tbody id="groups-tbody">
                        </tbody>
                    </table>
                </div>

                <button type="button" id="add-group-btn" class="tp-btn-secondary tp-btn-add-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Add Main Group
                </button>
            </div>

            <div class="tp-form-actions">
                <a href="{{ url("training_program", training_program.id, "training_days") }}" class="tp-btn-secondary">Cancel</a>
                <button type="submit" class="tp-btn-primary">Create Training Day</button>
            </div>
        </form>
    </div>
</div>

<style>
.tp-form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e7eb;
}
.tp-form-section:last-of-type {
    border-bottom: none;
    margin-bottom: 20px;
}
.tp-form-section-title {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 0 0 8px 0;
}
.tp-form-section-desc {
    font-size: 13px;
    color: #6b7280;
    margin: 0 0 20px 0;
}
.tp-form-info {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #e5e7eb;
    color: #6b7280;
    font-size: 11px;
    font-weight: 600;
    cursor: help;
    margin-left: 4px;
}
.tp-form-duration {
    display: flex;
    align-items: center;
    gap: 8px;
}
.tp-form-input-small {
    width: 80px !important;
}
.tp-form-duration-label {
    font-size: 13px;
    color: #6b7280;
}
.tp-groups-table-container {
    overflow-x: auto;
    margin-bottom: 15px;
}
.tp-groups-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}
.tp-groups-table th {
    text-align: left;
    padding: 10px 12px;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    font-weight: 600;
    color: #374151;
    font-size: 13px;
}
.tp-groups-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #e5e7eb;
    vertical-align: middle;
}
.tp-groups-table tbody tr:hover {
    background: #f9fafb;
}
.tp-groups-table input[type="text"],
.tp-groups-table input[type="datetime-local"],
.tp-groups-table input[type="number"] {
    padding: 8px 10px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 13px;
}
.tp-groups-table input[type="number"] {
    width: 50px;
}
.tp-groups-table .tp-group-duration {
    display: flex;
    align-items: center;
    gap: 4px;
}
.tp-groups-table .tp-group-duration span {
    font-size: 12px;
    color: #6b7280;
}
.tp-btn-add-group {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.tp-btn-remove {
    padding: 6px 12px;
    background: #fee2e2;
    color: #dc2626;
    border: none;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}
.tp-btn-remove:hover {
    background: #fecaca;
}
</style>

<script>
var allStudentTags = {{ all_student_tags | tojson }};
var groupRowIndex = 0;

function addGroupRow() {
    var tbody = document.getElementById('groups-tbody');
    var row = document.createElement('tr');
    row.id = 'group-row-' + groupRowIndex;

    var tagCell = document.createElement('td');
    var tagInput = document.createElement('input');
    tagInput.type = 'text';
    tagInput.name = 'group_tag_name[]';
    tagInput.placeholder = 'Select a student tag';
    tagInput.style.width = '160px';
    tagCell.appendChild(tagInput);
    row.appendChild(tagCell);

    var startCell = document.createElement('td');
    var startInput = document.createElement('input');
    startInput.type = 'datetime-local';
    startInput.name = 'group_start_time[]';
    startCell.appendChild(startInput);
    row.appendChild(startCell);

    var durationCell = document.createElement('td');
    var durationDiv = document.createElement('div');
    durationDiv.className = 'tp-group-duration';
    var hoursInput = document.createElement('input');
    hoursInput.type = 'number';
    hoursInput.name = 'group_duration_hours[]';
    hoursInput.min = '0';
    hoursInput.placeholder = '0';
    durationDiv.appendChild(hoursInput);
    var hLabel = document.createElement('span');
    hLabel.textContent = 'h';
    durationDiv.appendChild(hLabel);
    var minutesInput = document.createElement('input');
    minutesInput.type = 'number';
    minutesInput.name = 'group_duration_minutes[]';
    minutesInput.min = '0';
    minutesInput.max = '59';
    minutesInput.placeholder = '0';
    durationDiv.appendChild(minutesInput);
    var mLabel = document.createElement('span');
    mLabel.textContent = 'm';
    durationDiv.appendChild(mLabel);
    durationCell.appendChild(durationDiv);
    row.appendChild(durationCell);

    var alphaCell = document.createElement('td');
    alphaCell.style.textAlign = 'center';

    var groupIdInput = document.createElement('input');
    groupIdInput.type = 'hidden';
    groupIdInput.name = 'group_id[]';
    groupIdInput.value = groupRowIndex;
    alphaCell.appendChild(groupIdInput);

    var alphaInput = document.createElement('input');
    alphaInput.type = 'checkbox';
    alphaInput.name = 'group_alphabetical[]';
    alphaInput.value = groupRowIndex;
    alphaCell.appendChild(alphaInput);
    row.appendChild(alphaCell);

    var actionsCell = document.createElement('td');
    var removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'tp-btn-remove';
    removeBtn.textContent = 'Remove';
    removeBtn.onclick = function() { row.remove(); };
    actionsCell.appendChild(removeBtn);
    row.appendChild(actionsCell);

    tbody.appendChild(row);

    if (typeof Tagify !== 'undefined') {
        var tagify = new Tagify(tagInput, {
            mode: 'select',
            whitelist: allStudentTags,
            enforceWhitelist: true,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: true
            },
            originalInputValueFormat: function(valuesArr) {
                return valuesArr.length ? valuesArr[0].value : '';
            }
        });
        tagify.DOM.scope.style.width = '160px';
    }

    groupRowIndex++;
}

document.getElementById('add-group-btn').addEventListener('click', addGroupRow);

document.querySelector('form[name="add_training_day"]').addEventListener('submit', function() {
    var checkboxes = document.querySelectorAll('#groups-tbody input[name="group_alphabetical[]"]');
    checkboxes.forEach(function(checkbox, index) {
        checkbox.value = index;
    });
});
</script>

{% endblock core %}
