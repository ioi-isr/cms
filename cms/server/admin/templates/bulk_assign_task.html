{% extends "base.html" %}

{% block core %}
<h1>
  Assign Task to a Group in <a href="{{ url("training_program", training_program.id) }}">{{ training_program.name }}</a>
</h1>

<p>
  <a href="{{ url("training_program", training_program.id, "students") }}">Back to students list</a>
</p>

<style>
.tagify-tag-select { width: 200px; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var tagInput = document.querySelector('input[name="tag"]');
    if (tagInput && typeof Tagify !== 'undefined') {
        var whitelist = {{ all_student_tags | tojson }};
        var tagify = new Tagify(tagInput, {
            mode: 'select',
            whitelist: whitelist,
            enforceWhitelist: true,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: true
            },
            originalInputValueFormat: function(valuesArr) {
                return valuesArr.length ? valuesArr[0].value : '';
            }
        });
        tagify.DOM.scope.classList.add('tagify-tag-select');
    }
});
</script>

<h2 id="title_assign_task_to_group" class="toggling_on">Assign Task to a Group</h2>
<div id="assign_task_to_group">
  <p>
    This will assign the selected task to all students who have the specified tag.
    Students who already have the task assigned will be skipped.
  </p>
  <form enctype="multipart/form-data" action="{{ url("training_program", training_program.id, "bulk_assign_task") }}" method="POST">
    {{ xsrf_form_html|safe }}
    <table class="bordered">
      <tr>
        <td>
          <span class="info" title="Select a task to assign to students."></span>
          Task
        </td>
        <td>
          <select name="task_id" class="searchable-select">
            <option value="" selected disabled hidden>Select a task...</option>
            {% for task in all_tasks %}
            <option value="{{ task.id }}">{{ task.name }} - {{ task.title }}</option>
            {% endfor %}
          </select>
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Select a tag. All students with this tag will have the task assigned to them."></span>
          Student Tag
        </td>
        <td>
          <input type="text" name="tag" placeholder="Select a student tag" style="width: 200px;" />
        </td>
      </tr>
    </table>
    <input type="submit" value="Assign Task to Group" {% if not admin.permission_all %}disabled{% endif %} />
  </form>
  <div class="hr"></div>
</div>

<h2 id="title_available_tags" class="toggling_on">Available Tags</h2>
<div id="available_tags">
  {% if all_student_tags %}
  <p>The following tags are currently in use:</p>
  <ul>
    {% for tag in all_student_tags %}
    <li>{{ tag }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No student tags have been defined yet.</p>
  {% endif %}
  <div class="hr"></div>
</div>

{% endblock core %}
