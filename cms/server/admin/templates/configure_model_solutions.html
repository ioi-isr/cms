{% extends "base.html" %}

{% block core %}
<style>
.btn-group { display: inline-flex; }
.btn { 
  display: inline-block; 
  padding: 4px 10px; 
  font-size: 12px; 
  font-weight: 500;
  text-align: center; 
  cursor: pointer; 
  border: 1px solid transparent;
  border-radius: 4px;
  transition: all 0.15s ease-in-out;
}
.btn-success { 
  color: #fff; 
  background-color: #28a745; 
  border-color: #28a745; 
}
.btn-success:hover { 
  background-color: #218838; 
  border-color: #1e7e34; 
}
.btn-danger { 
  color: #fff; 
  background-color: #dc3545; 
  border-color: #dc3545; 
}
.btn-danger:hover { 
  background-color: #c82333; 
  border-color: #bd2130; 
}
.btn-outline-success {
  color: #28a745;
  background-color: transparent;
  border-color: #28a745;
}
.btn-outline-success:hover {
  color: #fff;
  background-color: #28a745;
}
.btn-outline-danger {
  color: #dc3545;
  background-color: transparent;
  border-color: #dc3545;
}
.btn-outline-danger:hover {
  color: #fff;
  background-color: #dc3545;
}
.btn-primary {
  color: #fff;
  background-color: #007bff;
  border-color: #007bff;
}
.btn-primary:hover {
  background-color: #0069d9;
  border-color: #0062cc;
}
.btn-secondary {
  color: #fff;
  background-color: #6c757d;
  border-color: #6c757d;
}
.btn-secondary:hover {
  background-color: #5a6268;
  border-color: #545b62;
}
.form-control {
  display: block;
  padding: 4px 8px;
  font-size: 14px;
  border: 1px solid #ced4da;
  border-radius: 4px;
}
.form-control:focus {
  border-color: #80bdff;
  outline: 0;
  box-shadow: 0 0 0 2px rgba(0,123,255,.25);
}
.form-check-input {
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.card {
  border: 1px solid #dee2e6;
  border-radius: 8px;
  margin-bottom: 20px;
  background: #fff;
}
.card-header {
  padding: 12px 16px;
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  border-radius: 7px 7px 0 0;
  font-weight: 600;
}
.card-body {
  padding: 16px;
}
.alert {
  padding: 12px 16px;
  border-radius: 4px;
  margin-bottom: 16px;
}
.alert-info {
  color: #0c5460;
  background-color: #d1ecf1;
  border: 1px solid #bee5eb;
}
.alert-warning {
  color: #856404;
  background-color: #fff3cd;
  border: 1px solid #ffeeba;
}
.subtask-group {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  margin: 4px;
}
.subtask-group-label {
  font-weight: 600;
  font-size: 12px;
  color: #495057;
  margin-right: 4px;
  white-space: nowrap;
}
.subtask-input {
  width: 55px;
  padding: 3px 6px;
  font-size: 13px;
  border: 1px solid #ced4da;
  border-radius: 3px;
  text-align: center;
}
.subtask-input:focus {
  border-color: #80bdff;
  outline: 0;
  box-shadow: 0 0 0 2px rgba(0,123,255,.25);
}
.solution-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  padding: 12px;
  border-bottom: 1px solid #dee2e6;
  gap: 8px;
}
.solution-row:last-child {
  border-bottom: none;
}
.solution-row.needs-config {
  background-color: #fff3cd;
}
.solution-name {
  font-weight: 600;
  min-width: 100px;
  font-size: 14px;
}
.solution-subtasks {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 4px;
  flex: 1;
}
.solution-actions {
  display: flex;
  align-items: center;
  gap: 8px;
}
.auto-calc-label {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 12px;
  color: #6c757d;
  cursor: pointer;
}
</style>

<div class="core_title">
  <h1>Configure Model Solutions</h1>
</div>

<div class="alert alert-info">
  The following model solutions need configuration. Please set the expected score ranges for each solution.
</div>

<form action="{{ url("task", task.id, "model_solutions", "configure") }}" method="POST">
  {{ xsrf_form_html|safe }}

  <div class="card">
    <div class="card-header">Overall Score Ranges</div>
    <div class="card-body" style="padding: 0;">
      <table class="bordered" style="width: 100%; margin: 0;">
        <thead>
          <tr>
            <th style="padding: 10px;">Name</th>
            <th style="padding: 10px;">Language</th>
            <th style="padding: 10px;">Description</th>
            <th style="padding: 10px;">Expected Min</th>
            <th style="padding: 10px;">Expected Max</th>
            <th style="padding: 10px;">Status</th>
          </tr>
        </thead>
        <tbody>
{% for sol in model_solutions %}
          <tr{% if sol.needs_config %} class="needs-config" style="background-color: #fff3cd;"{% endif %}>
            <td style="padding: 10px;">
              <strong>{{ sol.name }}</strong>
              <input type="hidden" name="sol_{{ sol.id }}_id" value="{{ sol.id }}" />
            </td>
            <td style="padding: 10px;">{{ sol.language or 'auto-detect' }}</td>
            <td style="padding: 10px;">
              <input type="text" name="sol_{{ sol.id }}_description" value="{{ sol.description }}" placeholder="Optional description" class="form-control" style="width: 200px;" />
            </td>
            <td style="padding: 10px;">
              <input type="number" step="0.01" name="sol_{{ sol.id }}_score_min" value="{{ sol.expected_score_min }}" class="form-control" style="width: 80px;" />
            </td>
            <td style="padding: 10px;">
              <input type="number" step="0.01" name="sol_{{ sol.id }}_score_max" value="{{ sol.expected_score_max }}" class="form-control" style="width: 80px;" />
            </td>
            <td style="padding: 10px; color: {% if sol.needs_config %}#856404{% else %}#28a745{% endif %}; font-weight: 500;">
              {% if sol.needs_config %}Needs Config{% else %}Configured{% endif %}
            </td>
          </tr>
{% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% if subtasks %}
  <div class="card">
    <div class="card-header">Subtask Expected Scores</div>
    <div class="card-body">
      <p style="margin-bottom: 16px; color: #6c757d;">Configure expected scores per subtask. Use the buttons to quickly set scores:</p>
      
{% for sol in model_solutions %}
      <div class="solution-row{% if sol.needs_config %} needs-config{% endif %}" data-sol-id="{{ sol.id }}">
        <div class="solution-name">{{ sol.name }}</div>
        <div class="solution-subtasks">
{% for st in subtasks if st.max_score > 0 %}
          <div class="subtask-group">
            <span class="subtask-group-label">{{ st.display_name }}</span>
            <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_min" 
                   value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].min }}{% else %}0{% endif %}" 
                   class="subtask-input subtask-min" data-sol-id="{{ sol.id }}" placeholder="Min" title="Min (max: {{ st.max_score }})" />
            <span style="color: #6c757d;">-</span>
            <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_max" 
                   value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].max }}{% else %}{{ st.max_score }}{% endif %}" 
                   class="subtask-input subtask-max" data-sol-id="{{ sol.id }}" placeholder="Max" title="Max (max: {{ st.max_score }})" />
            <div class="btn-group">
              <button type="button" class="btn btn-outline-danger btn-zero-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" title="Set to zero">0</button>
              <button type="button" class="btn btn-outline-success btn-full-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" data-max-score="{{ st.max_score }}" title="Set to full score ({{ st.max_score }})">Full</button>
            </div>
          </div>
{% endfor %}
        </div>
        <div class="solution-actions">
          <label class="auto-calc-label">
            <input type="checkbox" class="form-check-input calc-from-subtasks" data-sol-id="{{ sol.id }}" />
            Auto-calc
          </label>
        </div>
      </div>
{% endfor %}
    </div>
  </div>
{% endif %}

  <div style="margin: 20px 0; display: flex; gap: 10px;">
    <button type="submit" class="btn btn-primary">Save Configuration</button>
    <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url("task", task.id) }}'">Skip</button>
  </div>
</form>

<div class="alert alert-warning">
  <strong>Note:</strong> Solutions highlighted in yellow have default values and may need configuration.
  You can also configure them later from the task page.
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full score button handler (F button)
    document.querySelectorAll('.btn-full-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var maxScore = parseFloat(this.dataset.maxScore);
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = maxScore;
            if (maxInput) maxInput.value = maxScore;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Zero score button handler (0 button)
    document.querySelectorAll('.btn-zero-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = 0;
            if (maxInput) maxInput.value = 0;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Calculate from subtasks checkbox handler
    document.querySelectorAll('.calc-from-subtasks').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var solId = this.dataset.solId;
            if (this.checked) {
                updateScoreRangeFromSubtasks(solId);
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = true;
                if (maxInput) maxInput.readOnly = true;
            } else {
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = false;
                if (maxInput) maxInput.readOnly = false;
            }
        });
    });

    // Update score range when subtask values change
    document.querySelectorAll('.subtask-min, .subtask-max').forEach(function(input) {
        input.addEventListener('input', function() {
            var solId = this.dataset.solId;
            var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
            if (checkbox && checkbox.checked) {
                updateScoreRangeFromSubtasks(solId);
            }
        });
    });

    function updateScoreRangeFromSubtasks(solId) {
        var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
        if (!checkbox || !checkbox.checked) return;

        var minSum = 0;
        var maxSum = 0;
        document.querySelectorAll('.subtask-min[data-sol-id="' + solId + '"]').forEach(function(input) {
            minSum += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('.subtask-max[data-sol-id="' + solId + '"]').forEach(function(input) {
            maxSum += parseFloat(input.value) || 0;
        });

        var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
        var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
        if (minInput) minInput.value = minSum.toFixed(2);
        if (maxInput) maxInput.value = maxSum.toFixed(2);
    }
});
</script>
{% endblock core %}
