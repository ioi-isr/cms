{% extends "base.html" %}

{% block core %}
<div class="core_title">
  <h1>Configure Model Solutions</h1>
</div>

<p>The following model solutions need configuration. Please set the expected score ranges for each solution.</p>

<form action="{{ url("task", task.id, "model_solutions", "configure") }}" method="POST">
  {{ xsrf_form_html|safe }}

  <table class="bordered" style="margin: 20px 0;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Language</th>
        <th>Description</th>
        <th>Expected Score Min</th>
        <th>Expected Score Max</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
{% for sol in model_solutions %}
      <tr{% if sol.needs_config %} style="background-color: #fff3cd;"{% endif %}>
        <td>
          <strong>{{ sol.name }}</strong>
          <input type="hidden" name="sol_{{ sol.id }}_id" value="{{ sol.id }}" />
        </td>
        <td>{{ sol.language or 'auto-detect' }}</td>
        <td>
          <input type="text" name="sol_{{ sol.id }}_description" value="{{ sol.description }}" placeholder="Optional description" style="width: 200px;" />
        </td>
        <td>
          <input type="number" step="0.01" name="sol_{{ sol.id }}_score_min" value="{{ sol.expected_score_min }}" style="width: 80px;" />
        </td>
        <td>
          <input type="number" step="0.01" name="sol_{{ sol.id }}_score_max" value="{{ sol.expected_score_max }}" style="width: 80px;" />
        </td>
        <td style="color: {% if sol.needs_config %}orange{% else %}green{% endif %};">
          {% if sol.needs_config %}Needs Config{% else %}Configured{% endif %}
        </td>
      </tr>
{% endfor %}
    </tbody>
  </table>

{% if subtasks %}
  <h2>Subtask Expected Scores</h2>
  <p>Configure expected scores per subtask:</p>
  
  <table class="bordered" style="margin: 20px 0;">
    <thead>
      <tr>
        <th>Solution</th>
{% for st in subtasks if st.max_score > 0 %}
        <th colspan="2">{{ st.display_name }} (max {{ st.max_score }})</th>
{% endfor %}
      </tr>
      <tr>
        <th></th>
{% for st in subtasks if st.max_score > 0 %}
        <th>Min</th>
        <th>Max</th>
        <th>Set</th>
{% endfor %}
        <th>Auto-calc</th>
      </tr>
    </thead>
    <tbody>
{% for sol in model_solutions %}
      <tr{% if sol.needs_config %} style="background-color: #fff3cd;"{% endif %} data-sol-id="{{ sol.id }}">
        <td><strong>{{ sol.name }}</strong></td>
{% for st in subtasks if st.max_score > 0 %}
        <td>
          <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_min" 
                 value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].min }}{% else %}0{% endif %}" 
                 style="width: 60px;" class="subtask-min" data-sol-id="{{ sol.id }}" />
        </td>
        <td>
          <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_max" 
                 value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].max }}{% else %}{{ st.max_score }}{% endif %}" 
                 style="width: 60px;" class="subtask-max" data-sol-id="{{ sol.id }}" />
        </td>
        <td>
          <button type="button" class="btn-full-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" data-max-score="{{ st.max_score }}" style="padding: 1px 4px; font-size: 0.8em;">F</button>
          <button type="button" class="btn-zero-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" style="padding: 1px 4px; font-size: 0.8em;">0</button>
        </td>
{% endfor %}
        <td>
          <input type="checkbox" class="calc-from-subtasks" data-sol-id="{{ sol.id }}" title="Calculate score range from subtask table" />
        </td>
      </tr>
{% endfor %}
    </tbody>
  </table>
{% endif %}

  <div style="margin: 20px 0;">
    <input type="submit" value="Save Configuration">
    <input type="button" value="Skip" onclick="window.location.href='{{ url("task", task.id) }}'">
  </div>
</form>

<div style="margin-top: 20px; padding: 10px; background-color: #e7f3ff; border: 1px solid #b6d4fe;">
  <strong>Note:</strong> Solutions highlighted in yellow have default values and may need configuration.
  You can also configure them later from the task page.
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full score button handler (F button)
    document.querySelectorAll('.btn-full-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var maxScore = parseFloat(this.dataset.maxScore);
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = maxScore;
            if (maxInput) maxInput.value = maxScore;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Zero score button handler (0 button)
    document.querySelectorAll('.btn-zero-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = 0;
            if (maxInput) maxInput.value = 0;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Calculate from subtasks checkbox handler
    document.querySelectorAll('.calc-from-subtasks').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var solId = this.dataset.solId;
            if (this.checked) {
                updateScoreRangeFromSubtasks(solId);
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = true;
                if (maxInput) maxInput.readOnly = true;
            } else {
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = false;
                if (maxInput) maxInput.readOnly = false;
            }
        });
    });

    // Update score range when subtask values change
    document.querySelectorAll('.subtask-min, .subtask-max').forEach(function(input) {
        input.addEventListener('input', function() {
            var solId = this.dataset.solId;
            var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
            if (checkbox && checkbox.checked) {
                updateScoreRangeFromSubtasks(solId);
            }
        });
    });

    function updateScoreRangeFromSubtasks(solId) {
        var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
        if (!checkbox || !checkbox.checked) return;

        var minSum = 0;
        var maxSum = 0;
        document.querySelectorAll('.subtask-min[data-sol-id="' + solId + '"]').forEach(function(input) {
            minSum += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('.subtask-max[data-sol-id="' + solId + '"]').forEach(function(input) {
            maxSum += parseFloat(input.value) || 0;
        });

        var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
        var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
        if (minInput) minInput.value = minSum.toFixed(2);
        if (maxInput) maxInput.value = maxSum.toFixed(2);
    }
});
</script>
{% endblock core %}
