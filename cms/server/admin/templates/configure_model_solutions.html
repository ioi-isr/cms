{% extends "base.html" %}
{% import "macro/model_solution_subtasks.html" as ms %}

{% block core %}
{% include "fragments/model_solution_styles.html" %}

<div class="core_title">
  <h1>Configure Model Solutions</h1>
</div>

<div class="ms-alert ms-alert-info">
  The following model solutions need configuration. Please set the expected score ranges for each solution.
</div>

<form action="{{ url("task", task.id, "model_solutions", "configure") }}" method="POST">
  {{ xsrf_form_html|safe }}

  <div class="ms-card">
    <div class="ms-card-header">Overall Score Ranges</div>
    <div class="ms-card-body" style="padding: 0;">
      <table class="bordered" style="width: 100%; margin: 0;">
        <thead>
          <tr>
            <th style="padding: 10px;">Name</th>
            <th style="padding: 10px;">Language</th>
            <th style="padding: 10px;">Description</th>
            <th style="padding: 10px;">Expected Min</th>
            <th style="padding: 10px;">Expected Max</th>
            <th style="padding: 10px;">Status</th>
          </tr>
        </thead>
        <tbody>
{% for sol in model_solutions %}
          <tr{% if sol.needs_config %} class="needs-config" style="background-color: #fff3cd;"{% endif %}>
            <td style="padding: 10px;">
              <strong>{{ sol.name }}</strong>
              <input type="hidden" name="sol_{{ sol.id }}_id" value="{{ sol.id }}" />
            </td>
            <td style="padding: 10px;">{{ sol.language or 'auto-detect' }}</td>
            <td style="padding: 10px;">
              <input type="text" name="sol_{{ sol.id }}_description" value="{{ sol.description }}" placeholder="Optional description" class="ms-form-control" style="width: 200px;" />
            </td>
            <td style="padding: 10px;">
              <input type="number" step="0.01" name="sol_{{ sol.id }}_score_min" value="{{ sol.expected_score_min }}" class="ms-form-control" style="width: 80px;" />
            </td>
            <td style="padding: 10px;">
              <div style="display: flex; flex-direction: column; gap: 6px;">
                <input type="number" step="0.01" name="sol_{{ sol.id }}_score_max" value="{{ sol.expected_score_max }}" class="ms-form-control" style="width: 80px;" />
{% if subtasks %}
                <label class="ms-auto-calc-label" style="margin-top: 4px;">
                  <input type="checkbox" class="ms-form-check-input calc-from-subtasks" data-sol-id="{{ sol.id }}" />
                  Calculate score range from subtask table
                </label>
{% endif %}
              </div>
            </td>
            <td style="padding: 10px; color: {% if sol.needs_config %}#856404{% else %}#28a745{% endif %}; font-weight: 500;">
              {% if sol.needs_config %}Needs Config{% else %}Configured{% endif %}
            </td>
          </tr>
{% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% if subtasks %}
  <div class="ms-card">
    <div class="ms-card-header">Subtask Expected Scores</div>
    <div class="ms-card-body">
      <p style="margin-bottom: 16px; color: #6c757d;">Configure expected scores per subtask. Use the buttons to quickly set scores:</p>
      
{% for sol in model_solutions %}
      <div class="ms-solution-row{% if sol.needs_config %} needs-config{% endif %}" data-sol-id="{{ sol.id }}">
        <div class="ms-solution-name">{{ sol.name }}</div>
        <div class="ms-solution-subtasks">
{% for st in subtasks if st.max_score > 0 %}
          <div class="ms-subtask-group">
            <span class="ms-subtask-group-label">{{ st.display_name }}</span>
            <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_min" 
                   value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].min }}{% else %}0{% endif %}" 
                   class="ms-subtask-input subtask-min" data-sol-id="{{ sol.id }}" placeholder="Min" title="Min (max: {{ st.max_score }})" />
            <span style="color: #6c757d;">-</span>
            <input type="number" step="0.01" name="sol_{{ sol.id }}_st_{{ st.idx }}_max" 
                   value="{% if sol.subtask_expected_scores and sol.subtask_expected_scores[st.idx|string] %}{{ sol.subtask_expected_scores[st.idx|string].max }}{% else %}{{ st.max_score }}{% endif %}" 
                   class="ms-subtask-input subtask-max" data-sol-id="{{ sol.id }}" placeholder="Max" title="Max (max: {{ st.max_score }})" />
            <div class="ms-btn-group">
              <button type="button" class="ms-btn ms-btn-outline-danger btn-zero-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" title="Set to zero">0</button>
              <button type="button" class="ms-btn ms-btn-outline-success btn-full-score" data-sol-id="{{ sol.id }}" data-st-idx="{{ st.idx }}" data-max-score="{{ st.max_score }}" title="Set to full score ({{ st.max_score }})">Full</button>
            </div>
          </div>
{% endfor %}
        </div>
      </div>
{% endfor %}
    </div>
  </div>
{% endif %}

  <div style="margin: 20px 0; display: flex; gap: 10px;">
    <button type="submit" class="ms-btn ms-btn-primary">Save Configuration</button>
    <button type="button" class="ms-btn ms-btn-secondary" onclick="window.location.href='{{ url("task", task.id) }}'">Skip</button>
  </div>
</form>

<div class="ms-alert ms-alert-warning">
  <strong>Note:</strong> Solutions highlighted in yellow have default values and may need configuration.
  You can also configure them later from the task page.
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full score button handler (F button)
    document.querySelectorAll('.btn-full-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var maxScore = parseFloat(this.dataset.maxScore);
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = maxScore;
            if (maxInput) maxInput.value = maxScore;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Zero score button handler (0 button)
    document.querySelectorAll('.btn-zero-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var solId = this.dataset.solId;
            var stIdx = this.dataset.stIdx;
            var minInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_min"]');
            var maxInput = document.querySelector('input[name="sol_' + solId + '_st_' + stIdx + '_max"]');
            if (minInput) minInput.value = 0;
            if (maxInput) maxInput.value = 0;
            updateScoreRangeFromSubtasks(solId);
        });
    });

    // Calculate from subtasks checkbox handler
    document.querySelectorAll('.calc-from-subtasks').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var solId = this.dataset.solId;
            if (this.checked) {
                updateScoreRangeFromSubtasks(solId);
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = true;
                if (maxInput) maxInput.readOnly = true;
            } else {
                var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
                var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
                if (minInput) minInput.readOnly = false;
                if (maxInput) maxInput.readOnly = false;
            }
        });
    });

    // Update score range when subtask values change
    document.querySelectorAll('.subtask-min, .subtask-max').forEach(function(input) {
        input.addEventListener('input', function() {
            var solId = this.dataset.solId;
            var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
            if (checkbox && checkbox.checked) {
                updateScoreRangeFromSubtasks(solId);
            }
        });
    });

    function updateScoreRangeFromSubtasks(solId) {
        var checkbox = document.querySelector('.calc-from-subtasks[data-sol-id="' + solId + '"]');
        if (!checkbox || !checkbox.checked) return;

        var minSum = 0;
        var maxSum = 0;
        document.querySelectorAll('.subtask-min[data-sol-id="' + solId + '"]').forEach(function(input) {
            minSum += parseFloat(input.value) || 0;
        });
        document.querySelectorAll('.subtask-max[data-sol-id="' + solId + '"]').forEach(function(input) {
            maxSum += parseFloat(input.value) || 0;
        });

        var minInput = document.querySelector('input[name="sol_' + solId + '_score_min"]');
        var maxInput = document.querySelector('input[name="sol_' + solId + '_score_max"]');
        if (minInput) minInput.value = minSum.toFixed(2);
        if (maxInput) maxInput.value = maxSum.toFixed(2);
    }
});
</script>
{% endblock core %}
