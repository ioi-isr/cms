{% extends "base.html" %}

{% block js_init %}
{% if is_training_day %}
// Initialize Tagify for task visibility tags
function initTaskVisibilityTagify() {
    var existingTags = {{ all_student_tags | tojson }};
    
    document.querySelectorAll('.task-visibility-tags').forEach(function(input) {
        var taskId = input.dataset.taskId;
        
        var tagify = new Tagify(input, {
            delimiters: ",",
            maxTags: 20,
            placeholder: "All students",
            whitelist: existingTags,
            enforceWhitelist: true,
            dropdown: {
                maxItems: 20,
                classname: "tags-look",
                enabled: 0,
                closeOnSelect: true
            },
            editTags: false,
            originalInputValueFormat: function(valuesArr) {
                return valuesArr.map(function(item) {
                    return item.value;
                }).join(', ');
            }
        });
        
        // Auto-save on change with debounce
        var saveTimeout = null;
        function saveVisibilityTags() {
            var tags = input.value;
            var formData = new FormData();
            formData.append('visible_to_tags', tags);
            formData.append('_xsrf', document.querySelector('input[name="_xsrf"]').value);
            
            fetch('{{ url("contest", contest.id, "task_visibility") }}/' + taskId, {
                method: 'POST',
                body: formData
            }).then(function(response) {
                if (!response.ok) {
                    console.error('Failed to save visibility tags');
                }
            }).catch(function(error) {
                console.error('Error saving visibility tags:', error);
            });
        }
        
        tagify.on('add', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveVisibilityTags, 500);
        });
        tagify.on('remove', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveVisibilityTags, 500);
        });
    });
}
initTaskVisibilityTagify();
{% endif %}
{% endblock js_init %}

{% block core %}
<div class="core_title">
  <h1>Tasks list of <a href="{{ url("contest", contest.id) }}">{{ contest.name }}</a></h1>
</div>

{% if is_training_day %}
<p><em>This contest is a training day. Tasks are managed through the training day, not the contest directly.</em></p>
{% endif %}

{% if contest.start <= timestamp %}
<span style="color: red;">Warning: the contest is visible to contestants, tasks added can be seen</span>
{% endif %}

<form action="{{ url("contest", contest.id, "tasks", "add") }}" method="POST">
  {{ xsrf_form_html|safe }}
  Add a new task{% if is_training_day %} from training program{% endif %}:
  <select name="task_id" class="searchable-select">
    <option value="" selected disabled hidden>Select a new task...</option>
    {% for t in unassigned_tasks %}
    <option value="{{ t.id }}">
      {{ t.name }}
    </option>
    {% endfor %}
  </select>
  <input type="submit"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="Add task" />
</form>

<form action="{{ url("contest", contest.id, "tasks") }}" method="POST">
  {{ xsrf_form_html|safe }}
  Remove selected task from the {% if is_training_day %}training day{% else %}contest{% endif %}:
  <input type="submit" name="operation"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="{% if is_training_day %}Remove from training day{% else %}Remove from contest{% endif %}" />

  <br>

  Move selected task:
  <input type="submit" name="operation"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="to the top" />
  <input type="submit" name="operation"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="up by 1" />
  <input type="submit" name="operation"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="down by 1" />
  <input type="submit" name="operation"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="to the bottom" />
  <table class="bordered">
    <thead>
      <tr>
        <th></th>
        <th>Name</th>
        <th>Title</th>
{% if is_training_day %}
        <th>Visible to</th>
{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for t in contest.get_tasks() %}
      <tr>
        <td>
          <input type="radio" name="task_id" value="{{ t.id }}"/>
        </td>
        <td><a href="{{ url("task", t.id) }}">{{ t.name }}</a></td>
        <td>{{ t.title }}</td>
{% if is_training_day %}
        <td style="min-width: 200px;">
          <input type="text" class="task-visibility-tags" data-task-id="{{ t.id }}" value="{{ t.visible_to_tags|join(', ') }}"/>
        </td>
{% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>
{% endblock core %}
