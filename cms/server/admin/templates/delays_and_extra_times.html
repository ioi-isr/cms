{% extends "base.html" %}
{% import 'macro/delay_request.html' as macro_delay_request with context %}

{% block js_init %}

utils.show_page("pending_delay_requests", 1);
utils.show_page("all_delay_requests", 1);

{% endblock js_init %}

{% block core %}

<style>
/* Status row colors for attendance tracking */
tr.pre-contest {
  background-color: #e8ddff !important; /* Light purple - contest not started */
}

tr.can-start {
  background-color: #fffacd !important; /* Light yellow - can still start */
}

tr.in-contest {
  background-color: #d1ecf1 !important; /* Light blue - currently in contest */
}

tr.finished {
  background-color: #d4edda !important; /* Light green - participated and finished */
}

tr.missed {
  background-color: #f8d7da !important; /* Light red - missed opportunity */
}

.status-badge {
  display: inline-block;
  padding: 2px 6px;
  margin-left: 8px;
  font-size: 11px;
  font-weight: bold;
  border-radius: 3px;
  background-color: #666;
  color: white;
}

.status-icon {
  margin-right: 4px;
}

tr.pre-contest .status-badge {
  background-color: #6f42c1; /* Purple */
}

tr.can-start .status-badge {
  background-color: #ffc107; /* Yellow/amber */
}

tr.in-contest .status-badge {
  background-color: #17a2b8; /* Blue */
}

tr.finished .status-badge {
  background-color: #28a745; /* Green */
}

tr.missed .status-badge {
  background-color: #dc3545; /* Red */
}

/* Subtle link styling for usernames in the table - override body.admin a color */
a.username-link,
a.username-link:link,
a.username-link:visited {
  color: #222 !important;
  text-decoration: none;
}

a.username-link:hover {
  text-decoration: underline;
}
</style>

<div class="core_title">
  <h1>Attendance</h1>
  <p class="muted">All times shown in {{ timezone_name }}</p>
</div>

{% if delay_requests != [] %}
<h2 id="title_pending_delay_requests_section" class="toggling_on">Pending Delay Requests</h2>
<div id="pending_delay_requests_section">
<div id="pending_delay_requests" class="notifications">
  <div id="page_selector_pending_delay_requests"></div>
  <div id="paged_content_pending_delay_requests">
  {% for req in delay_requests %}
    {% if req.status == 'pending' %}
      {{ macro_delay_request.delay_request(req) }}
    {% endif %}
  {% endfor %}
  </div>
</div>
</div>
{% endif %}

<h2 id="title_admin_configure_delay_section" class="toggling_on">Set Delay for User</h2>
<div id="admin_configure_delay_section">
  <p class="muted">Configure a delayed start time for a user. This will create an approved delay request and set the user's delay time.</p>
  <form action="{{ url("contest", contest.id, "delays_and_extra_times", "admin_configure") }}" method="POST" class="form-horizontal" style="margin-top: 10px;">
    {{ xsrf_form_html|safe }}
    <div class="control-group">
      <label class="control-label" for="participation_id">User</label>
      <div class="controls">
        <select name="participation_id" id="participation_id" required>
          <option value="">-- Select a user --</option>
          {% for item in participation_statuses %}
            {% set participation = item.participation %}
            <option value="{{ participation.id }}">{{ participation.user.first_name }} {{ participation.user.last_name }} ({{ participation.user.username }})</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="control-group">
      <label class="control-label" for="requested_start_time">Start Time</label>
      <div class="controls">
        <input type="datetime-local" name="requested_start_time" id="requested_start_time" required>
        <span class="help-inline">Contest starts at {{ contest.start|format_datetime }}</span>
      </div>
    </div>
    <div class="control-group">
      <label class="control-label" for="reason">Reason</label>
      <div class="controls">
        <textarea name="reason" id="reason" rows="2" style="width: 400px;" required placeholder="Brief reason for the delay"></textarea>
      </div>
    </div>
    <div class="control-group">
      <div class="controls">
        <button type="submit" class="btn btn-primary">
          <i class="icon-time icon-white"></i> Set Delay
        </button>
      </div>
    </div>
  </form>
</div>

<h2 id="title_participations_section" class="toggling_on">All Participations</h2>
<div id="participations_section">
  <div class="btn-group" style="margin-top: 10px;">
    <a href="{{ url("contest", contest.id, "delays_and_extra_times", "export") }}" class="btn btn-info">
      <i class="icon-download-alt icon-white"></i> Export CSV
    </a>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "remove_all") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove all delays and extra times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-warning">
        <i class="icon-remove icon-white"></i> Remove All Delays & Extra Times
      </button>
    </form>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "erase_start_times") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to erase all starting times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-danger">
        <i class="icon-trash icon-white"></i> Erase All Start Times
      </button>
    </form>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "reset_ip_addresses") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to reset all IP addresses for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-danger">
        <i class="icon-trash icon-white"></i> Reset All IP Addresses
      </button>
    </form>
  </div>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>User</th>
      <th>Username</th>
      <th>Delay Time (seconds)</th>
      <th>Planned Start Time</th>
      <th>Actual Start Time</th>
      <th>IP Address</th>
      <th>Extra Time (seconds)</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for item in participation_statuses %}
    {% set participation = item.participation %}
    <tr class="{{ item.status_class }}">
      <td>
        <a href="{{ url("contest", contest.id, "user", participation.user.id, "edit") }}" class="username-link">{{ participation.user.first_name }} {{ participation.user.last_name }}</a>
      </td>
      <td><a href="{{ url("contest", contest.id, "user", participation.user.id, "edit") }}" class="username-link">{{ participation.user.username }}</a></td>
      <td>{{ participation.delay_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 %}
          {{ (contest.start + participation.delay_time)|format_datetime }}
        {% else %}
          {{ contest.start|format_datetime }}
        {% endif %}
      </td>
      <td>
        {% if participation.starting_time %}
          {{ participation.starting_time|format_datetime }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if participation.starting_ip_addresses %}
          {{ participation.starting_ip_addresses }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ participation.extra_time.total_seconds()|int }}</td>
      <td>
        {% if item.status_label %}
          <span class="status-badge">
            {% if item.status_class == "pre-contest" %}
              <span class="status-icon">⏳</span>
            {% elif item.status_class == "can-start" %}
              <span class="status-icon">▶</span>
            {% elif item.status_class == "in-contest" %}
              <span class="status-icon">⏱</span>
            {% elif item.status_class == "finished" %}
              <span class="status-icon">✓</span>
            {% elif item.status_class == "missed" %}
              <span class="status-icon">⛔</span>
            {% endif %}
            {{ item.status_label }}
          </span>
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 or participation.extra_time.total_seconds() > 0 %}
        <form action="{{ url("contest", contest.id, "participation", participation.id, "remove_delay_and_extra_time") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-warning btn-small">
            {% if participation.delay_time.total_seconds() == 0 %}
              Remove extra time 
            {% elif participation.extra_time.total_seconds() == 0 %}
              Remove delay
            {% else %}
              Remove delay and extra time
            {% endif %}
          </button>
        </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>

{% if delay_requests != [] %}
<h2 id="title_all_delay_requests_section" class="toggling_on">All Delay Requests</h2>
<div id="all_delay_requests_section">
<div id="all_delay_requests" class="notifications">
  <div id="page_selector_all_delay_requests"></div>
  <div id="paged_content_all_delay_requests">
  {% for req in delay_requests %}
    {{ macro_delay_request.delay_request(req, show_buttons=False) }}
  {% endfor %}
  </div>
</div>
</div>
{% endif %}

{% endblock core %}
