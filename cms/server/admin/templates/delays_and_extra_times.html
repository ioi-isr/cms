{% extends "base.html" %}

{% block js_init %}

utils.show_page("pending_delay_requests", 1);
utils.show_page("all_delay_requests", 1);

{% endblock js_init %}

{% block core %}

<style>
/* Status row colors for attendance tracking */
tr.pre-contest {
  background-color: #e8ddff !important; /* Light purple - contest not started */
}

tr.can-start {
  background-color: #fffacd !important; /* Light yellow - can still start */
}

tr.in-progress {
  background-color: #d4edda !important; /* Light green - currently in contest */
}

tr.finished {
  background-color: #d1ecf1 !important; /* Light blue - participated and finished */
}

tr.missed {
  background-color: #f8d7da !important; /* Light red - missed opportunity */
}

.status-badge {
  display: inline-block;
  padding: 2px 6px;
  margin-left: 8px;
  font-size: 11px;
  font-weight: bold;
  border-radius: 3px;
  background-color: #666;
  color: white;
}

.status-icon {
  margin-right: 4px;
}

tr.pre-contest .status-badge {
  background-color: #6f42c1; /* Purple */
}

tr.can-start .status-badge {
  background-color: #ffc107; /* Yellow/amber */
}

tr.in-progress .status-badge {
  background-color: #28a745; /* Green */
}

tr.finished .status-badge {
  background-color: #17a2b8; /* Blue */
}

tr.missed .status-badge {
  background-color: #dc3545; /* Red */
}
</style>

<div class="core_title">
  <h1>Attendance</h1>
  <p class="muted">All times shown in UTC</p>
</div>

{% if delay_requests != [] %}
<h2 id="title_pending_delay_requests_section" class="toggling_on">Pending Delay Requests</h2>
<div id="pending_delay_requests_section">
<div id="pending_delay_requests" class="notifications">
  <div id="page_selector_pending_delay_requests"></div>
  <div id="paged_content_pending_delay_requests">
  {% for req in delay_requests %}
    {% if req.status == 'pending' %}
    <div class="notification">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Current Delay:</strong> {{ req.participation.delay_time.total_seconds()|int }} seconds<br>
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
      <div class="notification_buttons">
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "approve") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-success">Approve</button>
        </form>
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "reject") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-danger">Reject</button>
        </form>
      </div>
    </div>
    {% endif %}
  {% endfor %}
  </div>
</div>
</div>
{% endif %}

<h2 id="title_participations_section" class="toggling_on">All Participations</h2>
<div id="participations_section">
  <div class="btn-group" style="margin-top: 10px;">
    <a href="{{ url("contest", contest.id, "delays_and_extra_times", "export") }}" class="btn btn-info">
      <i class="icon-download-alt icon-white"></i> Export CSV
    </a>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "remove_all") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove all delays and extra times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-warning">
        <i class="icon-remove icon-white"></i> Remove All Delays & Extra Times
      </button>
    </form>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "erase_start_times") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to erase all starting times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-danger">
        <i class="icon-trash icon-white"></i> Erase All Start Times
      </button>
    </form>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "reset_ip_addresses") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to reset all IP addresses for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-danger">
        <i class="icon-trash icon-white"></i> Reset All IP Addresses
      </button>
    </form>
  </div>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>User</th>
      <th>Username</th>
      <th>Delay Time (seconds)</th>
      <th>Planned Start Time</th>
      <th>Actual Start Time</th>
      <th>IP Address</th>
      <th>Extra Time (seconds)</th>
      <th>Status</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for item in participation_statuses %}
    {% set participation = item.participation %}
    <tr class="{{ item.status_class }}">
      <td>
        {{ participation.user.first_name }} {{ participation.user.last_name }}
      </td>
      <td>{{ participation.user.username }}</td>
      <td>{{ participation.delay_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 %}
          {{ (contest.start + participation.delay_time)|format_datetime }}
        {% else %}
          {{ contest.start|format_datetime }}
        {% endif %}
      </td>
      <td>
        {% if participation.starting_time %}
          {{ participation.starting_time|format_datetime }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if participation.starting_ip_addresses %}
          {{ participation.starting_ip_addresses }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ participation.extra_time.total_seconds()|int }}</td>
      <td>
        {% if item.status_label %}
          <span class="status-badge">
            {% if item.status_class == "pre-contest" %}
              <span class="status-icon">⏳</span>
            {% elif item.status_class == "can-start" %}
              <span class="status-icon">▶</span>
            {% elif item.status_class == "in-progress" %}
              <span class="status-icon">⏱</span>
            {% elif item.status_class == "finished" %}
              <span class="status-icon">✓</span>
            {% elif item.status_class == "missed" %}
              <span class="status-icon">⛔</span>
            {% endif %}
            {{ item.status_label }}
          </span>
        {% else %}
          -
        {% endif %}
      </td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 or participation.extra_time.total_seconds() > 0 %}
        <form action="{{ url("contest", contest.id, "participation", participation.id, "remove_delay_and_extra_time") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-warning btn-small">
            {% if participation.delay_time.total_seconds() == 0 %}
              Remove extra time 
            {% elif participation.extra_time.total_seconds() == 0 %}
              Remove delay
            {% else %}
              Remove delay and extra time
            {% endif %}
          </button>
        </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>

{% if delay_requests != [] %}
<h2 id="title_all_delay_requests_section" class="toggling_on">All Delay Requests</h2>
<div id="all_delay_requests_section">
<div id="all_delay_requests" class="notifications">
  <div id="page_selector_all_delay_requests"></div>
  <div id="paged_content_all_delay_requests">
  {% for req in delay_requests %}
    <div class="notification {% if req.status == 'approved' %}notification_success{% elif req.status == 'rejected' %}notification_error{% endif %}">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Status:</strong> {{ req.status }}<br>
          {% if req.processed_timestamp %}
          <strong>Processed:</strong> {{ req.processed_timestamp|format_datetime }}<br>
          {% endif %}
          {% if req.admin %}
          <strong>Processed by:</strong> {{ req.admin.name }}<br>
          {% endif %}
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
</div>
{% endif %}

{% endblock core %}
