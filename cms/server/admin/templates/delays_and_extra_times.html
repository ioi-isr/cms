{% extends "base.html" %}

{% block js_init %}

utils.show_page("delays_and_extra_times", 1);

{% endblock js_init %}
{% block core %}

<div class="core_title">
  <h1>Delays and Extra Times</h1>
</div>

{% if delay_requests != [] %}
<h2>Pending Delay Requests</h2>
<div id="delay_requests" class="notifications">
  <div id="page_selector_delay_requests"></div>
  <div id="paged_content_delay_requests">
  {% for req in delay_requests %}
    {% if req.status == 'pending' %}
    <div class="notification">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Current Delay:</strong> {{ req.participation.delay_time.total_seconds()|int }} seconds<br>
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
      <div class="notification_buttons">
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "approve") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-success">Approve</button>
        </form>
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "reject") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-danger">Reject</button>
        </form>
      </div>
    </div>
    {% endif %}
  {% endfor %}
  </div>
</div>

<h2>All Delay Requests</h2>
<div id="all_delay_requests" class="notifications">
  <div id="page_selector_all_delay_requests"></div>
  <div id="paged_content_all_delay_requests">
  {% for req in delay_requests %}
    <div class="notification {% if req.status == 'approved' %}notification_success{% elif req.status == 'rejected' %}notification_error{% endif %}">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Status:</strong> {{ req.status }}<br>
          {% if req.processed_timestamp %}
          <strong>Processed:</strong> {{ req.processed_timestamp|format_datetime }}<br>
          {% endif %}
          {% if req.admin %}
          <strong>Processed by:</strong> {{ req.admin.name }}<br>
          {% endif %}
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
{% endif %}

<h2>All Participations - Delays and Extra Times</h2>
<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>User</th>
      <th>Username</th>
      <th>Starting Time</th>
      <th>Delay Time (seconds)</th>
      <th>Planned Start Time</th>
      <th>Extra Time (seconds)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for participation in participations %}
    <tr>
      <td>{{ participation.user.first_name }} {{ participation.user.last_name }}</td>
      <td>{{ participation.user.username }}</td>
      <td>
        {% if participation.starting_time %}
          {{ participation.starting_time|format_datetime }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ participation.delay_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 %}
          {{ (contest.start + participation.delay_time)|format_datetime }}
        {% else %}
          {{ contest.start|format_datetime }}
        {% endif %}
      </td>
      <td>{{ participation.extra_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 or participation.extra_time.total_seconds() > 0 %}
        <form action="{{ url("contest", contest.id, "participation", participation.id, "remove_delay_and_extra_time") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-warning btn-small">Remove</button>
        </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

{% endblock core %}
