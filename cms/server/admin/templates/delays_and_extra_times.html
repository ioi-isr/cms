{% extends "base.html" %}

{% block js_init %}

utils.show_page("pending_delay_requests", 1);
utils.show_page("all_delay_requests", 1);

{% endblock js_init %}
{% block core %}

<div class="core_title">
  <h1>Delays and Extra Times</h1>
  <p class="muted">All times shown in UTC</p>
</div>

{% if delay_requests != [] %}
<h2 id="title_pending_delay_requests_section" class="toggling_on">Pending Delay Requests</h2>
<div id="pending_delay_requests_section">
<div id="pending_delay_requests" class="notifications">
  <div id="page_selector_pending_delay_requests"></div>
  <div id="paged_content_pending_delay_requests">
  {% for req in delay_requests %}
    {% if req.status == 'pending' %}
    <div class="notification">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Current Delay:</strong> {{ req.participation.delay_time.total_seconds()|int }} seconds<br>
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
      <div class="notification_buttons">
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "approve") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-success">Approve</button>
        </form>
        <form action="{{ url("contest", contest.id, "delay_request", req.id, "reject") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-danger">Reject</button>
        </form>
      </div>
    </div>
    {% endif %}
  {% endfor %}
  </div>
</div>
</div>

<h2 id="title_participations_section" class="toggling_on">All Participations - Delays and Extra Times</h2>
<div id="participations_section">
  <div class="btn-group" style="margin-top: 10px;">
    <a href="{{ url("contest", contest.id, "delays_and_extra_times", "export") }}" class="btn btn-info">
      <i class="icon-download-alt icon-white"></i> Export CSV
    </a>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "remove_all") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to remove all delays and extra times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-warning">
        <i class="icon-remove icon-white"></i> Remove All Delays & Extra Times
      </button>
    </form>
    <form action="{{ url("contest", contest.id, "delays_and_extra_times", "erase_start_times") }}" method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to erase all starting times for all participants?');">
      {{ xsrf_form_html|safe }}
      <button type="submit" class="btn btn-danger">
        <i class="icon-trash icon-white"></i> Erase All Start Times
      </button>
    </form>
  </div>

<table class="table table-striped table-bordered">
  <thead>
    <tr>
      <th>User</th>
      <th>Username</th>
      <th>Starting Time</th>
      <th>Delay Time (seconds)</th>
      <th>Planned Start Time</th>
      <th>Extra Time (seconds)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
  {% for participation in participations %}
    <tr>
      <td>{{ participation.user.first_name }} {{ participation.user.last_name }}</td>
      <td>{{ participation.user.username }}</td>
      <td>
        {% if participation.starting_time %}
          {{ participation.starting_time|format_datetime }}
        {% else %}
          -
        {% endif %}
      </td>
      <td>{{ participation.delay_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 %}
          {{ (contest.start + participation.delay_time)|format_datetime }}
        {% else %}
          {{ contest.start|format_datetime }}
        {% endif %}
      </td>
      <td>{{ participation.extra_time.total_seconds()|int }}</td>
      <td>
        {% if participation.delay_time.total_seconds() > 0 or participation.extra_time.total_seconds() > 0 %}
        <form action="{{ url("contest", contest.id, "participation", participation.id, "remove_delay_and_extra_time") }}" method="POST" style="display: inline;">
          {{ xsrf_form_html|safe }}
          <button type="submit" class="btn btn-warning btn-small">Remove</button>
        </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</div>

<h2 id="title_all_delay_requests_section" class="toggling_on">All Delay Requests</h2>
<div id="all_delay_requests_section">
<div id="all_delay_requests" class="notifications">
  <div id="page_selector_all_delay_requests"></div>
  <div id="paged_content_all_delay_requests">
  {% for req in delay_requests %}
    <div class="notification {% if req.status == 'approved' %}notification_success{% elif req.status == 'rejected' %}notification_error{% endif %}">
      <div class="notification_msg">
        <div class="notification_timestamp">
          {{ req.request_timestamp|format_datetime }}
        </div>
        <div class="notification_subject">
          <strong>User:</strong> {{ req.participation.user.first_name }} {{ req.participation.user.last_name }} ({{ req.participation.user.username }})
        </div>
        <div class="notification_text">
          <strong>Requested Start Time:</strong> {{ req.requested_start_time|format_datetime }}<br>
          <strong>Status:</strong> {{ req.status }}<br>
          {% if req.processed_timestamp %}
          <strong>Processed:</strong> {{ req.processed_timestamp|format_datetime }}<br>
          {% endif %}
          {% if req.admin %}
          <strong>Processed by:</strong> {{ req.admin.name }}<br>
          {% endif %}
          <strong>Reason:</strong> {{ req.reason }}
        </div>
      </div>
    </div>
  {% endfor %}
  </div>
</div>
</div>
{% endif %}

{% endblock core %}
