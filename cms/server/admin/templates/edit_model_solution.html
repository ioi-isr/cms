{% extends "base.html" %}
{% import "macro/model_solution_subtasks.html" as ms %}

{% block core %}
{% include "fragments/model_solution_styles.html" %}

<div class="core_title">
  <h1><a href="{{ url("task", task.id) }}">{{ task.title }} ({{ task.name }})</a> - Edit Model Solution</h1>
</div>
<form action="{{ url("model_solution", meta.id, "edit") }}" method="POST">
  {{ xsrf_form_html|safe }}
  <table>
    <tr>
      <td>Name:</td>
      <td><input type="text" name="name" value="{{ meta.name }}" pattern="[^/\\*?<>|:&quot;]+" title="Cannot contain: / \ * ? < > | : &quot; or .." required /></td>
      <td style="font-size: 0.9em; color: #666;">(identifier for export; changing may affect re-import matching)</td>
    </tr>
    <tr>
      <td>Description:</td>
      <td><input type="text" name="description" value="{{ meta.description }}" required /></td>
    </tr>
    <tr>
      <td>Expected Score Min:</td>
      <td><input type="number" step="0.01" name="expected_score_min" value="{{ meta.expected_score_min }}" class="ms-form-control" style="width: 100px;" required /></td>
    </tr>
    <tr>
      <td>Expected Score Max:</td>
      <td><input type="number" step="0.01" name="expected_score_max" value="{{ meta.expected_score_max }}" class="ms-form-control" style="width: 100px;" required /></td>
    </tr>
{% if subtasks %}
    <tr>
      <td></td>
      <td>{{ ms.auto_calc_checkbox() }}</td>
    </tr>
    <tr>
      <td colspan="2"><strong>Expected Subtask Scores:</strong></td>
    </tr>
    <tr>
      <td colspan="2">
        {{ ms.subtask_table(subtasks, none, meta.subtask_expected_scores) }}
      </td>
    </tr>
{% endif %}
  </table>
  <input type="submit" value="Update">
  <input type="reset" value="Reset">
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Full score button handler
    document.querySelectorAll('.btn-full-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var idx = this.dataset.idx;
            var maxScore = parseFloat(this.dataset.maxScore);
            var form = this.closest('form');
            var minInput = form.querySelector('input[name="subtask_' + idx + '_min"]');
            var maxInput = form.querySelector('input[name="subtask_' + idx + '_max"]');
            if (minInput) minInput.value = maxScore;
            if (maxInput) maxInput.value = maxScore;
            updateScoreRangeFromSubtasks(form);
        });
    });

    // Zero score button handler
    document.querySelectorAll('.btn-zero-score').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var idx = this.dataset.idx;
            var form = this.closest('form');
            var minInput = form.querySelector('input[name="subtask_' + idx + '_min"]');
            var maxInput = form.querySelector('input[name="subtask_' + idx + '_max"]');
            if (minInput) minInput.value = 0;
            if (maxInput) maxInput.value = 0;
            updateScoreRangeFromSubtasks(form);
        });
    });

    // Calculate from subtasks checkbox handler
    document.querySelectorAll('.calc-from-subtasks').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            var form = this.closest('form');
            if (this.checked) {
                updateScoreRangeFromSubtasks(form);
                var minInput = form.querySelector('input[name="expected_score_min"]');
                var maxInput = form.querySelector('input[name="expected_score_max"]');
                if (minInput) minInput.readOnly = true;
                if (maxInput) maxInput.readOnly = true;
            } else {
                var minInput = form.querySelector('input[name="expected_score_min"]');
                var maxInput = form.querySelector('input[name="expected_score_max"]');
                if (minInput) minInput.readOnly = false;
                if (maxInput) maxInput.readOnly = false;
            }
        });
    });

    // Update score range when subtask values change
    document.querySelectorAll('.subtask-min, .subtask-max').forEach(function(input) {
        input.addEventListener('input', function() {
            var form = this.closest('form');
            var checkbox = form.querySelector('.calc-from-subtasks');
            if (checkbox && checkbox.checked) {
                updateScoreRangeFromSubtasks(form);
            }
        });
    });

    function updateScoreRangeFromSubtasks(form) {
        var checkbox = form.querySelector('.calc-from-subtasks');
        if (!checkbox || !checkbox.checked) return;

        var minSum = 0;
        var maxSum = 0;
        form.querySelectorAll('.subtask-min').forEach(function(input) {
            minSum += parseFloat(input.value) || 0;
        });
        form.querySelectorAll('.subtask-max').forEach(function(input) {
            maxSum += parseFloat(input.value) || 0;
        });

        var minInput = form.querySelector('input[name="expected_score_min"]');
        var maxInput = form.querySelector('input[name="expected_score_max"]');
        if (minInput) minInput.value = minSum.toFixed(2);
        if (maxInput) maxInput.value = maxSum.toFixed(2);
    }
});
</script>
{% endblock core %}
