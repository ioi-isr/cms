{#
  Histogram modal component for score distribution visualization.
  
  This fragment provides:
  - Modal HTML structure
  - CSS styles for the histogram
  - JavaScript functions for rendering histograms
  
  Usage:
  1. Include this fragment in your template
  2. Call initHistogramModal() on document ready
  3. Call openHistogramModal(scores, title, type, contextId, maxPossibleScore) to show histogram
  
  Parameters for openHistogramModal:
  - scores: Array of {studentId, score} objects
  - title: Title for the histogram
  - type: 'task' or 'training_day' (affects max score calculation)
  - contextId: ID for context (training day ID for filtering)
  - maxPossibleScore: Maximum possible score for the histogram
#}

{% macro histogram_modal_html() %}
<div id="histogramModal" class="histogram-modal" style="display: none;">
  <div class="histogram-modal-content">
    <div class="histogram-modal-header">
      <h2 id="histogramTitle">Score Distribution</h2>
      <button class="histogram-close-btn" onclick="closeHistogramModal()">&times;</button>
    </div>
    <div class="histogram-filter-row" id="histogramFilterRow" style="display: none;">
      <label for="histogramTagsFilter">Filter by student tags:</label>
      <input type="text" id="histogramTagsFilter" style="min-width: 300px;" placeholder="Select tags to filter..." />
    </div>
    <div class="histogram-chart-container">
      <div id="histogramBars" class="histogram-bars"></div>
    </div>
    <div id="histogramStats" class="histogram-stats"></div>
    <div class="histogram-text-section">
      <div class="histogram-text-header">
        <span>Text Data (for copying)</span>
        <button class="copy-btn" onclick="copyHistogramData()">Copy to Clipboard</button>
      </div>
      <textarea id="histogramTextData" readonly rows="10"></textarea>
    </div>
  </div>
</div>
{% endmacro %}

{% macro histogram_styles() %}
<style>
.histogram-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.histogram-modal-content {
    background: white;
    border-radius: 12px;
    padding: 24px;
    max-width: 800px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.histogram-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #e5e7eb;
}

.histogram-modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #111827;
}

.histogram-close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #6b7280;
    padding: 4px 8px;
    border-radius: 4px;
}

.histogram-close-btn:hover {
    background: #f3f4f6;
    color: #111827;
}

.histogram-filter-row {
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.histogram-filter-row label {
    font-weight: 500;
    color: #374151;
    white-space: nowrap;
}

.histogram-chart-container {
    background: #f9fafb;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 16px;
}

.histogram-bars {
    display: flex;
    align-items: flex-end;
    justify-content: space-around;
    height: 200px;
    gap: 4px;
}

.histogram-bar-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    min-width: 30px;
}

.histogram-bar-wrapper {
    width: 100%;
    height: 160px;
    display: flex;
    align-items: flex-end;
    justify-content: center;
}

.histogram-bar {
    width: 80%;
    min-height: 2px;
    border-radius: 4px 4px 0 0;
    transition: height 0.3s ease;
}

.histogram-label {
    font-size: 0.7rem;
    color: #6b7280;
    margin-top: 8px;
    text-align: center;
    word-break: break-all;
}

.histogram-count {
    font-size: 0.75rem;
    font-weight: 600;
    color: #374151;
    margin-top: 2px;
}

.histogram-stats {
    background: #f3f4f6;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #374151;
    margin-bottom: 16px;
}

.histogram-text-section {
    border-top: 1px solid #e5e7eb;
    padding-top: 16px;
}

.histogram-text-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.histogram-text-header span {
    font-weight: 500;
    color: #374151;
}

.copy-btn {
    background: var(--tp-primary, #0F766E);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
}

.copy-btn:hover {
    background: var(--tp-primary-hover, #0d6963);
}

#histogramTextData {
    width: 100%;
    font-family: monospace;
    font-size: 0.8rem;
    padding: 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    resize: vertical;
}

.histogram-icon {
    cursor: pointer;
    margin-left: 4px;
    opacity: 0.6;
    font-size: 0.9em;
}

.histogram-icon:hover {
    opacity: 1;
}
</style>
{% endmacro %}

{% macro histogram_scripts(student_data_json='{}', enable_tag_filter=false, all_student_tags_json='[]') %}
<script>
(function() {
    var histogramModal = null;
    var histogramTagify = null;
    var currentHistogramData = null;
    var studentData = {{ student_data_json | safe }};
    var enableTagFilter = {{ 'true' if enable_tag_filter else 'false' }};
    var allStudentTags = {{ all_student_tags_json | safe }};

    window.initHistogramModal = function() {
        histogramModal = document.getElementById('histogramModal');
        if (!histogramModal) return;

        // Show/hide filter row based on configuration
        var filterRow = document.getElementById('histogramFilterRow');
        if (filterRow) {
            filterRow.style.display = enableTagFilter ? 'flex' : 'none';
        }

        // Initialize tagify for histogram filter if enabled
        if (enableTagFilter) {
            var histogramTagsInput = document.getElementById('histogramTagsFilter');
            if (histogramTagsInput && typeof Tagify !== 'undefined') {
                histogramTagify = new Tagify(histogramTagsInput, {
                    delimiters: ",",
                    whitelist: allStudentTags,
                    enforceWhitelist: true,
                    editTags: false,
                    dropdown: { enabled: 0, maxItems: 20, closeOnSelect: true },
                    originalInputValueFormat: function(valuesArr) {
                        return valuesArr.map(function(item) { return item.value; }).join(', ');
                    }
                });
                histogramTagify.on('change', function() {
                    if (currentHistogramData) {
                        window.renderHistogram(currentHistogramData.scores, currentHistogramData.title, currentHistogramData.type);
                    }
                });
            }
        }

        // Close modal on backdrop click
        histogramModal.addEventListener('click', function(e) {
            if (e.target === histogramModal) {
                window.closeHistogramModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && histogramModal.style.display === 'flex') {
                window.closeHistogramModal();
            }
        });
    };

    window.openHistogramModal = function(scores, title, type, contextId, maxPossibleScore) {
        if (!histogramModal) return;
        currentHistogramData = { 
            scores: scores, 
            title: title, 
            type: type, 
            contextId: contextId, 
            maxPossibleScore: (maxPossibleScore === undefined || maxPossibleScore === null) ? 100 : maxPossibleScore 
        };
        document.getElementById('histogramTitle').textContent = title + ' - Score Distribution';

        if (histogramTagify) {
            histogramTagify.removeAllTags();
        }

        histogramModal.style.display = 'flex';
        window.renderHistogram(scores, title, type);
    };

    window.closeHistogramModal = function() {
        if (histogramModal) {
            histogramModal.style.display = 'none';
        }
        currentHistogramData = null;
    };

    function getFilteredScores(scores) {
        if (!enableTagFilter || !histogramTagify) {
            return scores;
        }

        var filterTags = [];
        var tagifyValue = histogramTagify.value;
        if (tagifyValue && tagifyValue.length > 0) {
            filterTags = tagifyValue.map(function(t) { return t.value; });
        }

        if (filterTags.length === 0) {
            return scores;
        }

        return scores.filter(function(item) {
            var studentInfo = studentData[item.studentId];
            if (!studentInfo || !studentInfo.tags || studentInfo.tags.length === 0) return false;
            return filterTags.every(function(tag) {
                return studentInfo.tags.indexOf(tag) !== -1;
            });
        });
    }

    window.renderHistogram = function(scores, title, type) {
        var filteredScores = getFilteredScores(scores);
        var scoreValues = filteredScores.map(function(s) { return s.score; });

        // Sort scores high to low
        scoreValues.sort(function(a, b) { return b - a; });

        var maxPossibleScore = currentHistogramData ? currentHistogramData.maxPossibleScore : 100;

        // Build histogram buckets dynamically based on max possible score
        var buckets = {};
        var bucketLabels = {};
        var bucketOrder = [];

        // Guard against division by zero when maxPossibleScore is 0
        if (maxPossibleScore === 0) {
            maxPossibleScore = 1;
        }

        if (maxPossibleScore <= 15) {
            var maxInt = Math.ceil(maxPossibleScore);

            for (var i = 0; i <= maxInt; i++) {
                var key = i.toString();
                buckets[key] = 0;
                bucketLabels[key] = key;
                bucketOrder.push(key);
            }

            scoreValues.forEach(function(score) {
                var rounded = Math.round(score);
                if (rounded > maxInt) rounded = maxInt;
                if (rounded < 0) rounded = 0;
                buckets[rounded.toString()]++;
            });
        } else {
            var bucketSize = maxPossibleScore / 10;
            var lastBucketThreshold = maxPossibleScore * 0.9;

            buckets['0'] = 0;
            bucketLabels['0'] = '0';
            bucketOrder.push('0');

            for (var i = 1; i <= 9; i++) {
                var upperBound = Math.round(i * bucketSize);
                var lowerBound = Math.round((i - 1) * bucketSize);
                var key = upperBound.toString();
                buckets[key] = 0;
                bucketLabels[key] = '(' + lowerBound + ',' + upperBound + ']';
                bucketOrder.push(key);
            }

            var lastKey = Math.round(maxPossibleScore).toString();
            buckets[lastKey] = 0;
            bucketLabels[lastKey] = '>' + Math.round(lastBucketThreshold);
            bucketOrder.push(lastKey);

            scoreValues.forEach(function(score) {
                if (score === 0) {
                    buckets['0']++;
                } else if (score > lastBucketThreshold) {
                    buckets[lastKey]++;
                } else {
                    var bucketIndex = Math.ceil(score / bucketSize);
                    if (bucketIndex < 1) bucketIndex = 1;
                    if (bucketIndex > 9) bucketIndex = 9;
                    var bucketKey = Math.round(bucketIndex * bucketSize).toString();
                    buckets[bucketKey]++;
                }
            });
        }

        // Render histogram bars
        var histogramBars = document.getElementById('histogramBars');
        var maxCount = Math.max.apply(null, Object.values(buckets)) || 1;
        var totalStudents = scoreValues.length;

        var barsHtml = '';
        bucketOrder.forEach(function(bucketKey, index) {
            var count = buckets[bucketKey] || 0;
            var percentage = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0;
            var barHeight = maxCount > 0 ? (count / maxCount) * 100 : 0;
            var hue = (index / (bucketOrder.length - 1)) * 120;

            barsHtml += '<div class="histogram-bar-container">' +
                '<div class="histogram-bar-wrapper">' +
                '<div class="histogram-bar" style="height: ' + barHeight + '%; background-color: hsl(' + hue + ', 75%, 60%);" title="' + count + ' students (' + percentage + '%)"></div>' +
                '</div>' +
                '<div class="histogram-label">' + bucketLabels[bucketKey] + '</div>' +
                '<div class="histogram-count">' + count + '</div>' +
                '</div>';
        });
        histogramBars.innerHTML = barsHtml;

        // Calculate median
        var median = 0;
        if (scoreValues.length > 0) {
            var sorted = scoreValues.slice().sort(function(a, b) { return a - b; });
            var mid = Math.floor(sorted.length / 2);
            if (sorted.length % 2 === 0) {
                median = (sorted[mid - 1] + sorted[mid]) / 2;
            } else {
                median = sorted[mid];
            }
        }

        // Update stats
        document.getElementById('histogramStats').innerHTML =
            '<strong>Total students:</strong> ' + totalStudents +
            ' | <strong>Max possible:</strong> ' + Math.round(maxPossibleScore) +
            (scoreValues.length > 0 ? ' | <strong>Average:</strong> ' + (scoreValues.reduce(function(a, b) { return a + b; }, 0) / scoreValues.length).toFixed(1) +
            ' | <strong>Median:</strong> ' + median.toFixed(1) +
            ' | <strong>Max:</strong> ' + Math.max.apply(null, scoreValues).toFixed(1) +
            ' | <strong>Min:</strong> ' + Math.min.apply(null, scoreValues).toFixed(1) : '');

        // Build text data for copying
        var textData = title + ' - Score Distribution\n';
        textData += '================================\n\n';
        textData += 'Statistics:\n';
        textData += 'Total: ' + totalStudents + '\n';
        textData += 'Max possible score: ' + Math.round(maxPossibleScore) + '\n';
        if (scoreValues.length > 0) {
            textData += 'Average: ' + (scoreValues.reduce(function(a, b) { return a + b; }, 0) / scoreValues.length).toFixed(1) + '\n';
            textData += 'Median: ' + median.toFixed(1) + '\n';
            textData += 'Max: ' + Math.max.apply(null, scoreValues).toFixed(1) + '\n';
            textData += 'Min: ' + Math.min.apply(null, scoreValues).toFixed(1) + '\n';
        }
        textData += '\nScores (high to low):\n';

        var scoreGroups = {};
        scoreValues.forEach(function(score) {
            var roundedScore = score.toFixed(1);
            scoreGroups[roundedScore] = (scoreGroups[roundedScore] || 0) + 1;
        });

        var sortedScoreKeys = Object.keys(scoreGroups).sort(function(a, b) { return parseFloat(b) - parseFloat(a); });
        sortedScoreKeys.forEach(function(score) {
            var count = scoreGroups[score];
            var pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0;
            textData += score + ': ' + count + ' student' + (count !== 1 ? 's' : '') + ' (' + pct + '%)\n';
        });

        textData += '\nHistogram buckets:\n';
        var reverseBucketOrder = bucketOrder.slice().reverse();
        reverseBucketOrder.forEach(function(bucketKey) {
            var count = buckets[bucketKey] || 0;
            var pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(1) : 0;
            textData += bucketLabels[bucketKey] + ': ' + count + ' (' + pct + '%)\n';
        });

        document.getElementById('histogramTextData').value = textData;
    };

    window.copyHistogramData = function() {
        var textArea = document.getElementById('histogramTextData');
        var textToCopy = textArea.value;
        var btn = document.querySelector('.copy-btn');
        var originalText = btn.textContent;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(textToCopy).then(function() {
                btn.textContent = 'Copied!';
                setTimeout(function() {
                    btn.textContent = originalText;
                }, 2000);
            }).catch(function() {
                textArea.select();
                document.execCommand('copy');
                btn.textContent = 'Copied!';
                setTimeout(function() {
                    btn.textContent = originalText;
                }, 2000);
            });
        } else {
            textArea.select();
            document.execCommand('copy');
            btn.textContent = 'Copied!';
            setTimeout(function() {
                btn.textContent = originalText;
            }, 2000);
        }
    };

    // Auto-initialize on document ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', window.initHistogramModal);
    } else {
        window.initHistogramModal();
    }
})();
</script>
{% endmacro %}
