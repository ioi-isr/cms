{% if contest.training_day is not none %}
<h2>Main Groups Configuration</h2>
<p class="hint">Configure which student tags represent main groups for this training day. Students must have exactly one main group tag to participate.</p>

<style>
.tagify-tag-select { width: 160px; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var tagInput = document.querySelector('input[name="tag_name"]');
    if (tagInput && typeof Tagify !== 'undefined') {
        var whitelist = {{ all_student_tags | tojson }};
        var tagify = new Tagify(tagInput, {
            mode: 'select',
            whitelist: whitelist,
            enforceWhitelist: true,
            editTags: false,
            dropdown: {
                maxItems: 20,
                enabled: 0,
                closeOnSelect: true
            },
            originalInputValueFormat: function(valuesArr) {
                return valuesArr.length ? valuesArr[0].value : '';
            }
        });
        tagify.DOM.scope.classList.add('tagify-tag-select');
    }
});

function removeMainGroup(url) {
    if (!confirm('Remove this main group?')) {
        return;
    }
    var xsrfInput = document.querySelector('input[name="_xsrf"]');
    if (!xsrfInput) {
        alert('Missing XSRF token');
        return;
    }
    var formData = new FormData();
    formData.append('_xsrf', xsrfInput.value);
    fetch(url, {
        method: 'POST',
        body: formData
    }).then(function(response) {
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to remove main group');
        }
    }).catch(function(error) {
        alert('Error: ' + error);
    });
}
</script>

{% if contest.training_day.groups|length > 0 %}
<form action="{{ url("contest", contest.id, "training_day_groups", "update") }}" method="POST" id="update-groups-form">
  {{ xsrf_form_html|safe }}
  <table class="sub_table" id="main-groups-table">
    <thead>
      <tr>
        <th>Tag Name</th>
        <th>Start Time ({{ timezone_name }})</th>
        <th>Duration</th>
        <th>Alphabetical Task Order</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for group in contest.training_day.groups %}
      <tr>
        <td>
          {{ group.tag_name }}
          <input type="hidden" name="group_id[]" value="{{ group.id }}"/>
        </td>
        <td>
          <input type="datetime-local" name="start_time[]" value="{{ group.start_time|format_datetime_input(timezone) if group.start_time else '' }}"/>
        </td>
        <td>
          {% set duration_seconds = (group.end_time - group.start_time).total_seconds() if group.start_time and group.end_time else 0 %}
          {% set duration_hours = (duration_seconds // 3600)|int %}
          {% set duration_minutes = ((duration_seconds % 3600) // 60)|int %}
          <input type="number" name="duration_hours[]" min="0" style="width: 60px;" value="{{ duration_hours if duration_seconds > 0 else '' }}" placeholder="0"/> h
          <input type="number" name="duration_minutes[]" min="0" max="59" style="width: 60px;" value="{{ duration_minutes if duration_seconds > 0 else '' }}" placeholder="0"/> m
        </td>
        <td style="text-align: center;">
          <input type="checkbox" name="alphabetical_{{ group.id }}" {{ "checked" if group.alphabetical_task_order else "" }}/>
        </td>
        <td>
          <button type="button" class="btn btn-danger btn-small" onclick="removeMainGroup('{{ url("contest", contest.id, "training_day_group", group.id, "remove") }}');"{% if not admin.permission_all %} disabled{% endif %}>Remove</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <input type="submit" value="Save Group Changes"{% if not admin.permission_all %} disabled{% endif %}/>
</form>
{% else %}
<table class="sub_table" id="main-groups-table">
  <thead>
    <tr>
      <th>Tag Name</th>
      <th>Start Time ({{ timezone_name }})</th>
      <th>Duration</th>
      <th>Alphabetical Task Order</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="5" style="text-align: center; color: #666;">No main groups configured. All students can participate.</td>
    </tr>
  </tbody>
</table>
{% endif %}

<h3>Add Main Group</h3>
<form action="{{ url("contest", contest.id, "training_day_group", "add") }}" method="POST">
  {{ xsrf_form_html|safe }}
  <table class="sub_table">
    <tr>
      <td>
        <span class="info" title="The student tag that identifies this main group."></span>
        Tag Name
      </td>
      <td><input type="text" name="tag_name" required placeholder="Select a student tag" style="width: 160px;"/></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Custom start time for this group in contest timezone (optional). Leave empty to use contest default."></span>
        Start Time ({{ timezone_name }})
      </td>
      <td><input type="datetime-local" name="start_time"/></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Duration for this group (optional). Leave empty to use contest default."></span>
        Duration
      </td>
      <td>
        <input type="number" name="duration_hours" min="0" style="width: 60px;" placeholder="0"/> hours
        <input type="number" name="duration_minutes" min="0" max="59" style="width: 60px;" placeholder="0"/> minutes
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="If checked, tasks will be displayed alphabetically by name instead of custom order."></span>
        <label for="alphabetical_task_order">Alphabetical Task Order</label>
      </td>
      <td>
        <input type="checkbox" id="alphabetical_task_order" name="alphabetical_task_order"/>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <input type="submit" value="Add Group"{% if not admin.permission_all %} disabled{% endif %}/>
      </td>
    </tr>
  </table>
</form>
{% endif %}
