{% extends "base.html" %}

{% block core %}
<h1>
  Score Progress for <a href="{{ url("user", participation.user.id) }}">{{ participation.user.username }}</a> in <a href="{{ url("contest", contest.id) }}">{{ contest.name }}</a>
</h1>

<p>
  <a href="{{ url("contest", contest.id, "user", participation.user.id, "edit") }}">Back to participation</a>
</p>

<h2>Score History by Task</h2>

{% for task_id, task_data in task_history.items() %}
<div class="task_history">
  <h3>{{ task_data.task_title }} ({{ task_data.task_name }})</h3>
  {% if task_data.history %}
  <table class="bordered">
    <thead>
      <tr>
        <th>Time</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in task_data.history %}
      <tr>
        <td>{{ entry.timestamp | format_datetime }}</td>
        <td>{{ entry.score }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No score history for this task.</p>
  {% endif %}
</div>
{% endfor %}

<h2>Score History Charts</h2>

{% for task in contest.tasks %}
<div class="chart_container" style="margin-bottom: 30px;">
  <h3>{{ task.title }} ({{ task.name }})</h3>
  <canvas id="scoreCanvas_{{ task.id }}" width="700" height="200"></canvas>
</div>
{% endfor %}

<h3>Total Score</h3>
<canvas id="scoreCanvas_total" width="700" height="200"></canvas>

<script src="{{ url("static", "js", "Chart.js") }}"></script>
<script>
(function() {
  var taskHistoryJson = {{ task_history_json | tojson | safe }};
  var contestStart = {{ contest.start.timestamp() }};
  var contestEnd = {{ contest.stop.timestamp() }};
  var tasks = {{ contest.tasks | map(attribute='id') | list | tojson | safe }};
  var taskMaxScores = {
    {% for task in contest.tasks %}
    {{ task.id }}: {{ task.max_score }},
    {% endfor %}
  };
  var taskNames = {
    {% for task in contest.tasks %}
    {{ task.id }}: "{{ task.name }}",
    {% endfor %}
  };

  var intervals = [[contestStart, contestEnd]];

  for (var i = 0; i < tasks.length; i++) {
    var taskId = tasks[i];
    var canvas = document.getElementById('scoreCanvas_' + taskId);
    if (!canvas) continue;

    var taskData = taskHistoryJson[taskId];
    var history = [];
    if (taskData && taskData.history) {
      for (var j = 0; j < taskData.history.length; j++) {
        var entry = taskData.history[j];
        history.push([entry.timestamp, entry.score, 0]);
      }
    }

    var maxScore = taskMaxScores[taskId] || 100;
    Chart.draw_chart(
      canvas,
      0, maxScore,
      0, 0,
      intervals,
      history,
      [102, 102, 238],
      [maxScore * 0.25, maxScore * 0.5, maxScore * 0.75]
    );
  }

  var totalCanvas = document.getElementById('scoreCanvas_total');
  if (totalCanvas) {
    var allHistory = [];
    var currentScores = {};
    for (var i = 0; i < tasks.length; i++) {
      currentScores[tasks[i]] = 0;
    }

    var allEvents = [];
    for (var taskId in taskHistoryJson) {
      var taskData = taskHistoryJson[taskId];
      if (taskData && taskData.history) {
        for (var j = 0; j < taskData.history.length; j++) {
          var entry = taskData.history[j];
          allEvents.push({
            timestamp: entry.timestamp,
            taskId: parseInt(taskId),
            score: entry.score
          });
        }
      }
    }

    allEvents.sort(function(a, b) { return a.timestamp - b.timestamp; });

    for (var i = 0; i < allEvents.length; i++) {
      var event = allEvents[i];
      currentScores[event.taskId] = event.score;
      var totalScore = 0;
      for (var taskId in currentScores) {
        totalScore += currentScores[taskId];
      }
      allHistory.push([event.timestamp, totalScore, 0]);
    }

    var totalMaxScore = 0;
    for (var taskId in taskMaxScores) {
      totalMaxScore += taskMaxScores[taskId];
    }
    if (totalMaxScore === 0) totalMaxScore = 100;

    Chart.draw_chart(
      totalCanvas,
      0, totalMaxScore,
      0, 0,
      intervals,
      allHistory,
      [102, 102, 238],
      [totalMaxScore * 0.25, totalMaxScore * 0.5, totalMaxScore * 0.75]
    );
  }
})();
</script>

{% endblock core %}
