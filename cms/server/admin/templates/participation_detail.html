{% extends "base.html" %}

{% block core %}
<h1>
  Score Progress for <a href="{{ url("user", participation.user.id) }}">{{ participation.user.username }}</a> in <a href="{{ url("contest", contest.id) }}">{{ contest.name }}</a>
</h1>

<p>
  <a href="{{ url("contest", contest.id, "user", participation.user.id, "edit") }}">Back to participation</a>
</p>

<h2>Score History by Task</h2>

{% for task_id, task_data in task_history.items() %}
<div class="task_history">
  <h3>{{ task_data.task_title }} ({{ task_data.task_name }})</h3>
  {% if task_data.history %}
  <table class="bordered">
    <thead>
      <tr>
        <th>Time</th>
        <th>Score</th>
      </tr>
    </thead>
    <tbody>
      {% for entry in task_data.history %}
      <tr>
        <td>{{ entry.timestamp | format_datetime }}</td>
        <td>{{ entry.score }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <p>No score history for this task.</p>
  {% endif %}
</div>
{% endfor %}

<h2>Score History Chart</h2>
<div id="score_chart">
  <canvas id="scoreCanvas" width="800" height="400"></canvas>
</div>

<script>
(function() {
  var taskHistory = {{ task_history | tojson | safe }};
  var canvas = document.getElementById('scoreCanvas');
  var ctx = canvas.getContext('2d');
  
  // Collect all data points
  var allPoints = [];
  var colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c'];
  var colorIndex = 0;
  var taskColors = {};
  
  for (var taskId in taskHistory) {
    var task = taskHistory[taskId];
    taskColors[taskId] = colors[colorIndex % colors.length];
    colorIndex++;
    
    for (var i = 0; i < task.history.length; i++) {
      allPoints.push({
        timestamp: task.history[i].timestamp,
        score: task.history[i].score,
        taskId: taskId,
        taskName: task.task_name
      });
    }
  }
  
  if (allPoints.length === 0) {
    ctx.font = '16px Arial';
    ctx.fillText('No score history available', 10, 50);
    return;
  }
  
  // Sort by timestamp
  allPoints.sort(function(a, b) { return a.timestamp - b.timestamp; });
  
  // Find min/max
  var minTime = allPoints[0].timestamp;
  var maxTime = allPoints[allPoints.length - 1].timestamp;
  var maxScore = 0;
  for (var i = 0; i < allPoints.length; i++) {
    if (allPoints[i].score > maxScore) maxScore = allPoints[i].score;
  }
  if (maxScore === 0) maxScore = 100;
  
  // Draw axes
  var padding = 50;
  var chartWidth = canvas.width - padding * 2;
  var chartHeight = canvas.height - padding * 2;
  
  ctx.beginPath();
  ctx.moveTo(padding, padding);
  ctx.lineTo(padding, canvas.height - padding);
  ctx.lineTo(canvas.width - padding, canvas.height - padding);
  ctx.stroke();
  
  // Draw points and lines for each task
  for (var taskId in taskHistory) {
    var task = taskHistory[taskId];
    var color = taskColors[taskId];
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    
    var prevX = null, prevY = null;
    for (var i = 0; i < task.history.length; i++) {
      var point = task.history[i];
      var x = padding + ((point.timestamp - minTime) / (maxTime - minTime || 1)) * chartWidth;
      var y = canvas.height - padding - (point.score / maxScore) * chartHeight;
      
      // Draw point
      ctx.beginPath();
      ctx.arc(x, y, 4, 0, 2 * Math.PI);
      ctx.fill();
      
      // Draw line from previous point
      if (prevX !== null) {
        ctx.beginPath();
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(x, y);
        ctx.stroke();
      }
      
      prevX = x;
      prevY = y;
    }
  }
  
  // Draw legend
  var legendY = padding;
  for (var taskId in taskHistory) {
    var task = taskHistory[taskId];
    var color = taskColors[taskId];
    ctx.fillStyle = color;
    ctx.fillRect(canvas.width - padding + 10, legendY, 15, 15);
    ctx.fillStyle = '#000';
    ctx.font = '12px Arial';
    ctx.fillText(task.task_name, canvas.width - padding + 30, legendY + 12);
    legendY += 20;
  }
})();
</script>

{% endblock core %}
