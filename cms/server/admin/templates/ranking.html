{% extends "base.html" %}
{% macro task_html(status) -%}
    {%- if not status.can_access -%}
        <span class="indicator">ğŸš«</span><span class="score-only">{{ status.score }}{% if status.partial %}*{% endif %}</span>
    {%- elif not status.has_submissions -%}
        {%- if not status.has_opened -%}
            <span class="indicator">ğŸ™ˆ</span><span class="score-only">{{ status.score }}{% if status.partial %}*{% endif %}</span>
        {%- else -%}
            <span class="indicator">ğŸ’¤</span><span class="score-only">{{ status.score }}{% if status.partial %}*{% endif %}</span>
        {%- endif -%}
    {%- elif not status.has_opened -%}
        <span class="indicator">âš ï¸</span>{{ status.score }}{% if status.partial %}*{% endif %}<span class="indicator">ğŸ™ˆâš ï¸</span>
    {%- else -%}
        {{ status.score }}{% if status.partial %}*{% endif %}
    {%- endif -%}
{%- endmacro %}

{% block core %}
<style>
  #ranking-table .score-only { display: none; }
  #ranking-table.hide-indicators .indicator { display: none; }
  #ranking-table.hide-indicators .score-only { display: inline; }
</style>
<div class="core_title">
  <h1>Ranking</h1>
</div>
Download as <a href="{{ url("contest", contest.id, "ranking", "csv") }}">csv</a>, <a href="{{ url("contest", contest.id, "ranking", "txt") }}">text</a>.
<label style="margin-left: 20px;"><input type="checkbox" id="show-indicators" checked> Show indicators</label>
<table id="ranking-table" class="bordered">
  <thead>
    <tr>
      <th>Username</th>
      <th>User</th>
      {% if show_teams %}
      <th>Team</th>
      {% endif %}
      {% for task in contest.get_tasks() %}
      <th data-sort-settings="numeric reversed"><a href="{{ url("task", task.id) }}">{{ task.name }}</a></th>
      {% endfor %}
      <th data-sort-settings="numeric reversed">Global</th>
    </tr>
  </thead>
  <tbody>
    {# This template assumes participations have two fields in addition to those in the DB: #}
    {# - task_statuses: the per-task status info for rendering; #}
    {# - total_score: the total score for the contest. #}
    {% for p in contest.participations %}
      {% if not p.hidden %}
    <tr>
      <td><a href="{{ url("contest", contest.id, "user", p.user.id, "edit") }}">{{ p.user.username }}</a> <a href="{{ url("contest", contest.id, "user", p.user.id, "detail") }}" title="View score/rank history">[history]</a></td>
      <td>{{ "%s %s"|format(p.user.first_name, p.user.last_name) }}</td>
      {% if show_teams %}
        {% if p.team %}
        <td><a href="{{ url("team", p.team_id) }}">{{ p.team.name }}</a></td>
        {% else %}
        <td></td>
        {% endif %}
      {% endif %}
      {% for status in p.task_statuses %}
      <td>{{ task_html(status) }}</td>
      {% endfor %}
      {% set total_score, partial = p.total_score %}
      <td {%- if partial %} class="partial" {%- endif -%}>{{ total_score }}</td>
    </tr>
      {% endif %}
    {% endfor %}
  </tbody>
</table>
<script>
  $(document).ready(function() {
    CMS.AWSUtils.init_table_sort($("#ranking-table"), true, -1);
    
    $("#show-indicators").on("change", function() {
      if (this.checked) {
        $("#ranking-table").removeClass("hide-indicators");
      } else {
        $("#ranking-table").addClass("hide-indicators");
      }
    });
  })
</script>
{% endblock core %}
