{% import "macro/reevaluation_buttons.html" as macro_reevaluation_buttons %}

{% extends "base.html" %}

{% block js_init %}

function showTaskTypeOption(dataset_id) {
    var selector = $("select[name=task_type_" + dataset_id + "]")[0];
    $(".TaskTypeOptions_" + dataset_id + ":visible").hide("fast");
    $("#TaskType" + selector.options[selector.selectedIndex].value + "Options_" + dataset_id).show("fast")
    updateRealPrecOptions(dataset_id);
};

{% for dataset in task.datasets %}
showTaskTypeOption({{ dataset.id }});
$("select[name=task_type_{{ dataset.id }}]").change(function() {
    showTaskTypeOption({{ dataset.id }});
});
{% endfor %}

function updateRealPrecOptions(dataset_id) {
  var visible = $(".TaskTypeOptions_" + dataset_id + ":visible");
  visible.each(function() {
    var table = $(this);
    var evalSelect = table.find("select[name$='_output_eval']");
    if (evalSelect.length == 0) return;
    var val = evalSelect.val();
    var row = table.find("tr.param_row[data-param-short='realprec_exp']");
    if (val === 'realprecision') {
      row.show();
    } else {
      row.hide();
    }
  });
}

$(document).ready(function() {
  {% for dataset in task.datasets %}
  $(".TaskTypeOptions_{{ dataset.id }} select[name$='_output_eval']").change(function(){
    updateRealPrecOptions({{ dataset.id }});
  });
  $(".multi_delete_checkbox_{{ dataset.id }}").change(function() {
    updateMultiDeleteMaster({{ dataset.id }});
  });
  {% endfor %}
});

window.toggleMultipleDeleteMode = function(dataset_id) {
  var cells = $(".multi_delete_col_" + dataset_id);
  var toggleLink = $("#toggle_multi_delete_" + dataset_id);
  var actionContainer = $("#multi_delete_actions_" + dataset_id);
  var deleteButton = $("#delete_selected_" + dataset_id);
  var cancelLink = $("#cancel_multi_delete_" + dataset_id);
  var currentlyVisible = cells.first().is(":visible");
  if (currentlyVisible) {
    cells.hide();
    actionContainer.hide();
    deleteButton.hide();
    cancelLink.hide();
    toggleLink.show();
    $(".multi_delete_checkbox_" + dataset_id).prop("checked", false);
    $("#multi_delete_master_" + dataset_id).prop("checked", false);
  } else {
    cells.show();
    actionContainer.show();
    deleteButton.show();
    cancelLink.show();
    toggleLink.hide();
  }
};

window.toggleSelectAllTestcases = function(dataset_id, masterCheckbox) {
  $(".multi_delete_checkbox_" + dataset_id).prop("checked", masterCheckbox.checked);
  window.updateMultiDeleteMaster(dataset_id);
};

window.deleteSelectedTestcases = function(dataset_id, url) {
  var checkboxes = $(".multi_delete_checkbox_" + dataset_id + ":checked");
  if (checkboxes.length === 0) {
    alert("No testcases selected.");
    return;
  }
  if (!confirm("Are you sure you want to delete the selected testcases from this dataset?")) {
    return;
  }

  var data = [];
  checkboxes.each(function() {
    data.push("testcase_id=" + encodeURIComponent($(this).val()));
  });

  $.ajax({
    url: url,
    type: "POST",
    data: data.join("&"),
    headers: {"X-XSRFToken": get_cookie("_xsrf")},
    success: function(redirect_url) {
      if (redirect_url) {
        window.location.replace(redirect_url);
      }
    }
  });
};

window.updateMultiDeleteMaster = function(dataset_id) {
  var master = $("#multi_delete_master_" + dataset_id);
  if (master.length === 0) return;
  var checkboxes = $(".multi_delete_checkbox_" + dataset_id);
  var total = checkboxes.length;
  if (total === 0) {
    master.prop("checked", false);
    return;
  }
  var checked = checkboxes.filter(":checked").length;
  master.prop("checked", checked === total);
};

{% endblock js_init %}

{% block core %}

<div class="core_title">
  <h1>{{ task.title }} ({{ task.name }})</h1>
</div>

<h2 id="title_submissions" class="toggling_on">Submissions</h2>
<div id="submissions">

  {% if submissions|length == 0 %}
  <p>No submissions for this task yet.</p>
  {% else %}
    <a href="{{ url("dataset", task.active_dataset_id) }}">
      {% if submissions|length == 1 %}
      1 submission
      {% else %}
      {{ submissions|length }} submissions
      {% endif %}
    </a>
  {% endif %}
  <div class="hr"></div>
</div>

<!-- We use "multipart/form-data" to have Tornado distinguish between missing and empty values. -->
<form enctype="multipart/form-data" action="{{ url("task", task.id) }}" method="POST" style="display:inline;">
  {{ xsrf_form_html|safe }}
  <h2 id="title_task_configuration" class="toggling_on">Task configuration</h2>
  <div id="task_configuration">
    <table>
      <tr><td colspan=2><h2>Task information</h2></td></tr>
      <tr>
        <td>
          <span class="info" title="A short name for the task, preferably using only letters, numbers and underscores."></span>
          Name
        </td>
        <td><input type="text" name="name" value="{{ task.name }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The title of the task as seen by the contestants."></span>
          Title
        </td>
        <td><input type="text" name="title" value="{{ task.title }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The index of the task within the contest, if the task is associated with a contest."></span>
          Position
        </td>
        <td>{{ task.num }}</td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The statements of this task, by language code. Primary statements are shown prominently to contestants."></span>
          Statements
{% if admin.permission_all %}
          [<a href="{{ url("task", task.id, "statements", "add") }}">add</a>]
{% endif %}
        </td>
        <td>
          {% if task.statements|length == 0 %}
          No statements uploaded yet
          {% else %}
          <table>
            <tbody>
            {% for statement in task.statements.values() %}
              <tr>
                <td><a href="{{ url("file", statement.digest, task.name + "_" + statement.language + ".pdf") }}">Statement for language "{{ statement.language }}"</a></td>
                <td>
                  <label>
                    <input type="checkbox" name="primary_statement_{{ statement.language }}" {% if statement.language in primary_statements %}checked{% endif %} />
                    Primary?
                  </label>
                </td>
                <td><a onclick="CMS.AWSUtils.ajax_delete('{{ url("task", task.id, "statement", statement.id) }}'); ">Delete</a></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Attachments for this task. Contestant can view and download attachments from the task page."></span>
          Attachments
{% if admin.permission_all %}
          [<a href="{{ url("task", task.id, "attachments", "add") }}">add</a>]
{% endif %}
        </td>
        <td>
          {% if task.attachments|length == 0 %}
            No attachments.
          {% else %}
            {% for attachment in task.attachments.values() %}
              <div class="attachment">
                <a href="{{ url("file", attachment.digest, attachment.filename) }}">{{ attachment.filename }}</a>
                - <a onclick="CMS.AWSUtils.ajax_delete('{{ url("task", task.id, "attachment", attachment.id) }}'); ">Delete</a>
              </div>
            {% endfor %}
          {% endif %}
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="A comma-separated list with the names of the files that need to be submitted (with the language extensions changed to %l).
                                    The task type dictates the submission format. Consult the task type documentation to know the requirements."></span>
          Submission format
        </td>
        <td>
          <input type="text" name="submission_format" value="{{ task.submission_format|join(", ") }}"/>
        </td>
        {% if task.active_dataset.task_type == "OutputOnly" %}
        <td>
          <a onclick="CMS.AWSUtils.ajax_post('{{ url("task", task.id, "default_submission_format") }}');">Default</a>
        </td>
        {% endif %}
      </tr>
      <tr>
        <td>
          <span class="info" title="Programming languages that contestants can use to solve this task.
                                    If none are selected, all contest languages are allowed.
                                    Otherwise, only the selected languages are allowed."></span>
          Allowed programming languages
        </td>
        <td class="wrapping-options">
          {% for lang in LANGUAGES %}
            <label><input type="checkbox" name="allowed_languages" value="{{ lang.name }}" {{ "checked" if task.allowed_languages is not none and lang.name in task.allowed_languages else "" }}>{{ lang.name }}</label>
          {% endfor %}
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="With 'restricted' contestants only see limited technical information about each testcase; with 'full' they see more details, but malicious contestants might use this data to get some information about the test data."></span>
          Feedback level
        </td>
        <td>
          <select name="feedback_level">
            <option value={{ FEEDBACK_LEVEL_OI_RESTRICTED }} {{ "selected" if task.feedback_level == FEEDBACK_LEVEL_OI_RESTRICTED else "" }}>OI Restricted</option>
            <option value={{ FEEDBACK_LEVEL_RESTRICTED }} {{ "selected" if task.feedback_level == FEEDBACK_LEVEL_RESTRICTED else "" }}>Restricted</option>
            <option value={{ FEEDBACK_LEVEL_FULL }} {{ "selected" if task.feedback_level == FEEDBACK_LEVEL_FULL else "" }}>Full</option>
          </select>
        </td>
      </tr>
      <tr><td colspan=2><h2>Tokens parameters (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Configuring%20a%20contest.html#feedback-to-contestants" target="_blank">documentation</a>)</h2></td></tr>
      <tr>
        <td>
          <span class="info" title="Select 'disabled' to remove tokens completely for this task, 'infinite' for allowing any number of tokens for this task, or 'finite' to specify the amount with the following parameters.
                                    If you prefer to control tokens at the task level, select 'infinite' here."></span>
          Token mode
        </td>
        <td>
          <select name="token_mode">
            <option value="{{ TOKEN_MODE_DISABLED }}" {{ "selected" if task.token_mode == TOKEN_MODE_DISABLED else "" }}>Disabled</option>
            <option value="{{ TOKEN_MODE_FINITE }}" {{ "selected" if task.token_mode == TOKEN_MODE_FINITE else "" }}>Finite</option>
            <option value="{{ TOKEN_MODE_INFINITE }}" {{ "selected" if task.token_mode == TOKEN_MODE_INFINITE else "" }}>Infinite</option>
          </select>
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The maximum number of tokens a contestant can use in this task.
                                    It is used only if tokens are finite."></span>
          Maximum number of tokens
        </td>
        <td><input type="text" name="token_max_number" value="{{ task.token_max_number if task.token_max_number is not none else "" }}" /></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The minimum amount of time (in seconds) that a contestant needs to wait for this task after using a token before being able to use another.
                                    It is used only if tokens are finite."></span>
          Minimum interval between tokens
        </td>
        <td><input type="text" name="token_min_interval" value="{{ task.token_min_interval.total_seconds()|int }}" /></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The number of tokens that a contestant has available for this task when their contest time starts.
                                    It is used only if tokens are finite."></span>
          Initial number of tokens
        </td>
        <td><input type="text" name="token_gen_initial" value="{{ task.token_gen_initial }}" /></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The number of tokens that are generated periodically for this task.
                                    It is used only if tokens are finite."></span>
          Token generation number
        </td>
        <td><input type="text" name="token_gen_number" value="{{ task.token_gen_number }}" /></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The amount of time (in minutes) between two token generation events for this task.
                                    It is used only if tokens are finite."></span>
          Token generation period
        </td>
        <td><input type="text" name="token_gen_interval" value="{{ task.token_gen_interval.total_seconds()|int // 60 }}" /></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Maximum number of tokens for this task available to a contestant at any given time during the contest.
                                    It is used only if tokens are finite."></span>
          Maximum accumulated tokens
        </td>
        <td><input type="text" name="token_gen_max" value="{{ task.token_gen_max if task.token_gen_max is not none else "" }}" /></td>
      </tr>

      <tr><td colspan=2><h2>Limits</h2></td></tr>
      <tr>
        <td>
          <span class="info" title="Maximum number of submissions each contestant can submit for this task, for the whole contest.
                                    Leave empty for no limits."></span>
          Maximum number of submissions
        </td>
        <td><input type="text" name="max_submission_number" value="{{ task.max_submission_number if task.max_submission_number is not none else "" }}"></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Maximum number of user tests each contestant can submit for this task, for the whole contest.
                                    Leave empty for no limits."></span>
          Maximum number of user tests
        </td>
        <td><input type="text" name="max_user_test_number" value="{{ task.max_user_test_number if task.max_user_test_number is not none else "" }}"></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The minimum amount of time (in seconds) for this task that a contestant needs to wait after a submission before being able to submit another.
                                    Leave empty for no limits."></span>
          Minimum interval between submissions
        </td>
        <td><input type="text" name="min_submission_interval" value="{{ task.min_submission_interval.total_seconds()|int if task.min_submission_interval is not none else "" }}"></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="The minimum amount of time (in seconds) for this task that a contestant needs to wait after a user test before being able to send another.
                                    Leave empty for no limits."></span>
          Minimum interval between user tests
        </td>
        <td><input type="text" name="min_user_test_interval" value="{{ task.min_user_test_interval.total_seconds()|int if task.min_user_test_interval is not none else "" }}"></td>
      </tr>

      <tr><td colspan=2><h2>Score options</h2></td></tr>
      <tr>
        <td>
          <span class="info" title="The number of decimal places the scores will be rounded to.
                                    Example: '2' to allow 98.76."></span>
          Score decimal places
        </td>
        <td><input type="text" name="score_precision" value="{{ task.score_precision }}"></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="How the score for the task is computed from the score of each submission."></span>
          Score mode
        </td>
        <td>
          <select name="score_mode">
            <option value="{{ SCORE_MODE_MAX_TOKENED_LAST }}" {{ "selected" if task.score_mode == SCORE_MODE_MAX_TOKENED_LAST else "" }}>Use best among tokened and last submissions (IOI 2010-2012)</option>
            <option value="{{ SCORE_MODE_MAX }}" {{ "selected" if task.score_mode == SCORE_MODE_MAX else "" }}>Use best among all submissions (IOI 2013-2016)</option>
            <option value="{{ SCORE_MODE_MAX_SUBTASK }}" {{ "selected" if task.score_mode == SCORE_MODE_MAX_SUBTASK else "" }}>Use the sum over each subtask of the best result for that subtask across all submissions (IOI 2017-)</option>
          </select>
        </td>
      </tr>
    </table>
    <div class="hr"></div>
  </div>

<!-- Datasets -->

  <h2 id="title_datasets" class="toggling_on">Datasets</h2>
  <div id="datasets">
    <p>
{% if task.datasets|length == 0 %}
    No datasets have been created for this task.<br/>
{% endif %}
{% if admin.permission_all %}
    <a href="{{ url("task", task.id, "add_dataset") }}">Create a new dataset</a><br/>
{% endif %}
    </p>

{% for dataset in task.datasets|sort(attribute="description") %}

  <h3 id="title_dataset_{{ dataset.id }}" class="toggling_on">Dataset: {{ dataset.description }}{{ dataset|format_dataset_attrs }}</h3>
  <div id="dataset_{{ dataset.id }}" class="task_dataset">

    <p>
{% if admin.permission_all %}
      {% if dataset is sameas (task.active_dataset) %}
      [Make Live ...]
      {% else %}
      <a href="{{ url("dataset", dataset.id, "activate") }}">[Make Live ...]</a>
      {% endif %}
      <a href="{{ url("dataset", dataset.id, "clone") }}">[Clone]</a>
      <a href="{{ url("dataset", dataset.id, "rename") }}">[Rename]</a>
      {% if dataset is sameas (task.active_dataset) %}
      [Delete]
      {% else %}
      <a href="{{ url("dataset", dataset.id, "delete") }}">[Delete]</a>
      {% endif %}
      {% if dataset is not sameas (task.active_dataset) %}
        <a onclick="CMS.AWSUtils.ajax_post('{{ url("dataset", dataset.id, "autojudge") }}');">[{% if dataset.autojudge %}Disable{% else %}Enable{% endif %} background judging]</a>
      {% endif %}
{% endif %}
      <a href="{{ url("dataset", dataset.id) }}">[View results]</a>
    </p>

  <!-- Task type and score type settings -->

    <h4 id="title_task_type_{{ dataset.id }}" class="toggling_on">Dataset configuration</h4>

    {% if dataset.task_type not in TASK_TYPES %}
    <script type="text/javascript">
      $(document).ready(function() {
      utils.display_notification("notification",
          0,
          "Task type `{{ dataset.task_type }}' not found.",
          "Please select another task type, " +
          "or make the original one available and refresh the page " +
          "without updating the task to avoid losing the parameters.");
      });
    </script>
    {% endif %}

    {% if dataset.score_type not in SCORE_TYPES %}
    <script type="text/javascript">
      $(document).ready(function() {
      utils.display_notification("notification",
          0,
          "Score type `{{ dataset.score_type }}' not found.",
          "Please select another score type, " +
          "or make the original one available and refresh the page " +
          "without updating the task to avoid losing the parameters.");
      });
    </script>
    {% endif %}

    <div id="task_type_{{ dataset.id }}" class="task_dataset_params">
      <table>

        <tr><td colspan=2><h3>Limits</h3></td></tr>
        <tr>
          <td>
            <span class="info" title="Total maximum time for each evaluation, in seconds."></span>
            Time limit
          </td>
          <td><input type="text" name="time_limit_{{ dataset.id }}" value="{{ dataset.time_limit if dataset.time_limit is not none else "" }}"/> second(s)</td>
        </tr>
        <tr>
          <td>
            <span class="info" title="Total maximum memory usage for each evaluation, in MiB (2^20 bytes)."></span>
            Memory limit
          </td>
          <td><input type="text" name="memory_limit_{{ dataset.id }}" value="{{ dataset.memory_limit // (1024 * 1024) if dataset.memory_limit is not none else "" }}"/> MiB</td>
        </tr>

        <tr><td colspan=2><h3>Task type settings (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Task%20types.html" target="_blank">documentation</a>)</h3></td></tr>
        <tr>
          <td>
            <span class="info" title="Please see the task type documentation."></span>
            Task type
          </td>
          <td>

            <select name="task_type_{{ dataset.id }}">
              {% for task_type_name, task_type in TASK_TYPES.items() %}
              <option value="{{ task_type_name }}" {% if dataset.task_type == task_type_name %}selected{% endif %}>{{ task_type_name }}</option>
              {% endfor %}
            </select>
          {% set parameters = dataset.task_type_parameters %}

          {% for task_type_name, task_type in TASK_TYPES.items() %}
          <table class="TaskTypeOptions TaskTypeOptions_{{ dataset.id }} bordered" id="TaskType{{ task_type_name }}Options_{{ dataset.id }}" style="display: none;">
            {% for i in range(task_type.ACCEPTED_PARAMETERS|length) %}
              {% set param_def = task_type.ACCEPTED_PARAMETERS[i] %}
              {% set parameter_value = parameters[i] if dataset.task_type == task_type_name and parameters is not none and i < parameters|length else none %}
              <tr class="param_row" data-param-short="{{ param_def.short_name }}">
                <td>{{ param_def.name }}</td>
                <td>
                  {{ param_def.render("TaskTypeOptions_%d_%s_"|format(dataset.id, task_type_name), parameter_value)|safe }}
                </td>
              </tr>
            {% endfor %}
          </table>
          {% endfor %}

          </td>
        </tr>
        <tr>
          <td>
            <span class="info" title="Managers for this task. Managers are sources, headers, libraries or binaries used during the evaluation."></span>
            Managers
{% if admin.permission_all %}
            [<a href="{{ url("dataset", dataset.id, "managers", "add") }}">add</a>]
{% endif %}
          </td>
          <td>
            {% if dataset.managers|length == 0 %}
              No managers.
            {% else %}
              {# Determine if source files for checker/manager exist; if so, hide compiled counterparts #}
              {% set flags = namespace(checker_src=False, manager_src=False) %}
              {% for m in dataset.managers.values() %}
                {% if m.filename.startswith('checker.') %}{% set flags.checker_src = True %}{% endif %}
                {% if m.filename.startswith('manager.') %}{% set flags.manager_src = True %}{% endif %}
              {% endfor %}
              {% for manager in dataset.managers.values() %}
                {% if (manager.filename == 'checker' and flags.checker_src) or (manager.filename == 'manager' and flags.manager_src) %}
                  {# hide compiled when source is present #}
                {% else %}
                <div class="manager">
                  <a href="{{ url("file", manager.digest, manager.filename) }}">{{ manager.filename }}</a>
                  - <a onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "manager", manager.id, "delete") }}');">Delete</a>
                </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </td>
        </tr>

        <tr><td colspan=2><h3>Score type settings (<a href="http://cms.readthedocs.org/en/{{ rtd_version }}/Score%20types.html" target="_blank">documentation</a>)</h3></td></tr>
        <tr>
          <td>
            <span class="info" title="Please see the score type documentation."></span>
            Score Type
          </td>
          <td>
            <select name="score_type_{{ dataset.id }}">
              {% for score_type_name, score_type in SCORE_TYPES.items() %}
              <option value="{{ score_type_name }}" {% if dataset.score_type == score_type_name %}selected{% endif %}>{{ score_type_name }}</option>
              {% endfor %}
            </select>
          </td>
        </tr>
        <tr>
          <td>
            <span class="info" title="Please see the score type documentation."></span>
            Score Parameters
          </td>
          <td><textarea name="score_type_parameters_{{ dataset.id }}">{{ dataset.score_type_parameters|tojson|forceescape }}</textarea></td>
        </tr>
      </table>

      {% if subtask_info.get(dataset.id) %}
      {% set ds_ns = namespace(total_not_validated=0,
                               has_validators=false,
                               not_validated_codenames=[]) %}
      {% for subtask in subtask_info[dataset.id] %}
        {% set validator = dataset.subtask_validators.get(subtask.idx) %}
        {% if validator %}
          {% set ds_ns.has_validators = true %}
          {% if validator.validation_results %}
            {% set results_codenames = [] %}
            {% for r in validator.validation_results %}
              {% set _ = results_codenames.append(r.testcase.codename) %}
            {% endfor %}
            {% for tc_codename, tc in dataset.testcases|dictsort(by="key") %}
              {% if tc_codename not in results_codenames and tc_codename not in ds_ns.not_validated_codenames %}
                {% set _ = ds_ns.not_validated_codenames.append(tc_codename) %}
              {% endif %}
            {% endfor %}
          {% else %}
            {% for tc_codename, tc in dataset.testcases|dictsort(by="key") %}
              {% if tc_codename not in ds_ns.not_validated_codenames %}
                {% set _ = ds_ns.not_validated_codenames.append(tc_codename) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
      {% endfor %}
      {% set ds_ns.total_not_validated = ds_ns.not_validated_codenames|length %}
      <h4>Subtask Validators<span class="info" title="Upload validators to verify testcases meet subtask requirements. Validators receive input and output files and return exit code 0 if valid."></span>
      </h4>
      {% if ds_ns.total_not_validated > 0 %}
      <p style="color: orange;"><strong>Warning:</strong> {{ ds_ns.total_not_validated }} testcase(s) have not been validated. Click "rerun validators" to validate them.</p>
      [<a href="javascript:void(0);" onclick="document.getElementById('rerun_validators_form_{{ dataset.id }}').submit();">rerun validators</a>]
      {% endif %}
      <table class="bordered subtask-validators">
        <thead>
          <tr>
            <th>Subtask</th>
            <th>Validator</th>
            <th>Tests</th>
            <th>Additional Tests Passed</th>
          </tr>
        </thead>
        <tbody>
          {% for subtask in subtask_info[dataset.id] %}
          {% set validator = dataset.subtask_validators.get(subtask.idx) %}
          {% set ns = namespace(subtask_tc_count=0, other_tc_count=0, subtask_passed=0, subtask_failed=0, subtask_error=0, subtask_not_validated=0, other_passed=0) %}
          {% if testcase_subtasks.get(dataset.id) %}
            {% for tc_codename, tc_subtasks in testcase_subtasks[dataset.id].items() %}
              {% if subtask.idx in tc_subtasks %}
                {% set ns.subtask_tc_count = ns.subtask_tc_count + 1 %}
              {% else %}
                {% set ns.other_tc_count = ns.other_tc_count + 1 %}
              {% endif %}
            {% endfor %}
          {% endif %}
          {% if validator and validator.validation_results %}
            {% set results_by_tc = {} %}
            {% for r in validator.validation_results %}
              {% set _ = results_by_tc.update({r.testcase.codename: r}) %}
            {% endfor %}
            {% if testcase_subtasks.get(dataset.id) %}
              {% for tc_codename, tc_subtasks in testcase_subtasks[dataset.id].items() %}
                {% if subtask.idx in tc_subtasks %}
                  {% if results_by_tc.get(tc_codename) %}
                    {% if results_by_tc[tc_codename].passed %}
                      {% set ns.subtask_passed = ns.subtask_passed + 1 %}
                    {% elif results_by_tc[tc_codename].exit_status in ['ok', 'nonzero return', none] %}
                      {% set ns.subtask_failed = ns.subtask_failed + 1 %}
                    {% else %}
                      {% set ns.subtask_error = ns.subtask_error + 1 %}
                    {% endif %}
                  {% else %}
                    {% set ns.subtask_not_validated = ns.subtask_not_validated + 1 %}
                  {% endif %}
                {% else %}
                  {% if results_by_tc.get(tc_codename) and results_by_tc[tc_codename].passed %}
                    {% set ns.other_passed = ns.other_passed + 1 %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endif %}
          <tr>
            <td>{{ subtask.display_name }}</td>
            <td>
              {% if admin.permission_all %}
              {# File input uses form attribute to associate with validator form placed outside the main task form #}
              <input id="validator_file_{{ dataset.id }}_{{ subtask.idx }}" type="file" name="validator" style="display: none;" form="validator_form_{{ dataset.id }}_{{ subtask.idx }}" onchange="document.getElementById('validator_form_{{ dataset.id }}_{{ subtask.idx }}').submit();" />
              {% endif %}
              {% if validator %}
                <a href="javascript:void(0);" onclick="utils.show_file('{{ validator.filename }}','{{ url("file", validator.digest, validator.filename) }}')">{{ validator.filename }}</a>
                {% if validator.executable_digest is none %}
                  <span style="color: red;">(compilation failed)</span>
                {% endif %}
                {% if admin.permission_all %}
                [<a href="javascript:void(0);" onclick="document.getElementById('validator_file_{{ dataset.id }}_{{ subtask.idx }}').click();">replace</a>]
                [<a href="javascript:void(0);" onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "validator", validator.id, "delete") }}');">delete</a>]
                {% endif %}
              {% else %}
                <span style="color: red; font-weight: bold;">No validator</span>
                {% if admin.permission_all %}
                [<a href="javascript:void(0);" onclick="document.getElementById('validator_file_{{ dataset.id }}_{{ subtask.idx }}').click();">add</a>]
                {% endif %}
              {% endif %}
            </td>
            <td>
              {{ ns.subtask_tc_count }}
              {% if validator and validator.validation_results|length > 0 %}
                ({% if ns.subtask_failed == 0 and ns.subtask_error == 0 and ns.subtask_not_validated == 0 %}
                  <span style="color: green;">all {{ ns.subtask_passed }} passed</span>
                {% else %}
                  {% set has_prev = false %}
                  {% if ns.subtask_passed > 0 %}<span style="color: green;">{{ ns.subtask_passed }} passed</span>{% set has_prev = true %}{% endif %}
                  {% if ns.subtask_failed > 0 %}{% if has_prev %}, {% endif %}<span style="color: red;">{{ ns.subtask_failed }} failed</span>{% set has_prev = true %}{% endif %}
                  {% if ns.subtask_error > 0 %}{% if has_prev %}, {% endif %}<span style="color: orange;">{{ ns.subtask_error }} error</span>{% set has_prev = true %}{% endif %}
                  {% if ns.subtask_not_validated > 0 %}{% if has_prev %}, {% endif %}<span style="color: gray;">{{ ns.subtask_not_validated }} not validated</span>{% endif %}
                {% endif %})
              {% elif validator %}
                (<em>not validated</em>)
              {% endif %}
              [<a href="{{ url("dataset", dataset.id, "subtask", subtask.idx, "details") }}">details</a>]
            </td>
            <td>
              {% if validator and validator.validation_results|length > 0 %}
                {{ ns.other_passed }} / {{ ns.other_tc_count }}
              {% elif validator %}
                <em>Not validated</em>
              {% else %}
                -
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% endif %}

      <div class="hr"></div>
    </div>

  <!-- Model Solutions for this dataset -->

  <h4 id="title_model_solutions_{{ dataset.id }}" class="toggling_on">Model Solutions<span class="info" title="Model solutions are reference solutions uploaded by admins to verify that the task's test data and scoring work correctly."></span>
{% if admin.permission_all %}
    [<a href="{{ url("dataset", dataset.id, "model_solutions", "add") }}">add</a>]
{% endif %}
  </h4>
    <div id="model_solutions_{{ dataset.id }}" class="task_dataset_model_solutions">
{% if admin.permission_all and dataset.model_solution_metas|length > 0 %}
      <p>
        <strong>Reevaluate all model solutions:</strong>
        <button onclick="confirm('Do you really want to reevaluate all model solutions?') && cmsrpc_request(
                         'EvaluationService', 0,
                         'invalidate_model_solutions', {
                         'dataset_id': {{ dataset.id }},
                         'level': 'compilation'},
                         function(response) { utils.redirect_if_ok('{{ url("task", task.id) }}', response); }
                         );"
                title="Compilation" >C</button>
        <button onclick="confirm('Do you really want to reevaluate all model solutions?') && cmsrpc_request(
                         'EvaluationService', 0,
                         'invalidate_model_solutions', {
                         'dataset_id': {{ dataset.id }},
                         'level': 'evaluation'},
                         function(response) { utils.redirect_if_ok('{{ url("task", task.id) }}', response); }
                         );"
                title="Evaluation" >E</button>
        <button onclick="confirm('Do you really want to reevaluate all model solutions?') && cmsrpc_request(
                         'ScoringService', 0,
                         'invalidate_model_solutions', {
                         'dataset_id': {{ dataset.id }}},
                         function(response) { utils.redirect_if_ok('{{ url("task", task.id) }}', response); }
                         );"
                title="Score" >S</button>
      </p>
{% endif %}
      <table class="bordered" style="text-align:center">
        <thead>
          <tr>
            <th>#</th>
            <th>Description</th>
            <th>Language</th>
            <th>Expected Score Range</th>
            <th>Actual Score</th>
            <th>In Range?</th>
            <th>Status</th>
            <th>Comment</th>
            <th>Reevaluate</th>
            <th>Ops</th>
          </tr>
        </thead>
        <tbody>
          {% if dataset.model_solution_metas|length == 0 %}
          <tr>
            <td colspan="10">No model solutions yet</td>
          </tr>
          {% else %}
          {% for meta in dataset.model_solution_metas %}
          {% set submission = meta.submission %}
          {% set msr = submission.get_result(dataset) %}
          <tr id="model_solution_{{ meta.id }}">
            <td style="font-weight:bold;">{{ loop.index }}</td>
            <td><a href="{{ url("model_solution", meta.id) }}">{{ meta.description }}</a></td>
            <td>{{ submission.language if submission.language else "N/A" }}</td>
            <td>{{ "%.2f"|format(meta.expected_score_min) }} - {{ "%.2f"|format(meta.expected_score_max) }}</td>
            <td>
              {% if msr and msr.score is not none %}
              {{ "%.2f"|format(msr.score) }}
              {% else %}
              N/A
              {% endif %}
            </td>
            <td>
              {% set score_in_range = meta.is_score_in_range() %}
              {% if score_in_range is none %}
              <span style="color: gray;">Not scored</span>
              {% elif score_in_range %}
              <span style="color: green;">✓ Yes</span>
              {% else %}
              <span style="color: red;">✗ No</span>
              {% endif %}
            </td>
            <td>
              {% if msr is none %}
              Not evaluated
              {% elif not msr.compiled() %}
              Compiling...
              {% elif msr.compilation_failed() %}
              Compilation failed
              {% elif not msr.evaluated() %}
              Evaluating...
              {% elif not msr.scored() %}
              Scoring...
              {% else %}
              Scored
              {% endif %}
            </td>
            <td>
              {{ submission.comment if submission.comment else "" }}
            </td>
            <td>
            {{ macro_reevaluation_buttons.reevaluation_buttons(
                 admin.permission_all,
                 url("task", task.id),
                 submission_id=submission.id,
                 dataset_id=dataset.id) }}
            </td>
            <td>
              <a href="{{ url("model_solution", meta.id, "edit") }}">Edit</a>
{% if admin.permission_all %}
              | <a onclick="CMS.AWSUtils.ajax_delete('{{ url("model_solution", meta.id, "delete") }}');">Delete</a>
{% endif %}
            </td>
          </tr>
          {% endfor %}
          {% endif %}
        </tbody>
      </table>

{% if dataset.id in subtask_info and dataset.model_solution_metas|length > 0 %}
      <h5 style="margin-top: 20px;">Subtask Score Validation</h5>
      <table class="bordered" style="text-align:center">
        <thead>
          <tr>
            <th>Model Solution</th>
{% for st in subtask_info[dataset.id] %}
            <th>{{ st.display_name }}</th>
{% endfor %}
          </tr>
        </thead>
        <tbody>
{% for meta in dataset.model_solution_metas %}
{% set msr = meta.submission.get_result(dataset) %}
{% if msr and msr.scored() %}
          <tr>
            <td><a href="{{ url("model_solution", meta.id) }}">{{ meta.description }}</a></td>
{% for st in subtask_info[dataset.id] %}
{% if st.max_score == 0 %}
{% set outcomes = meta.get_subtask_testcase_outcomes(st.idx) %}
            <td>
{% if outcomes %}
              <span style="font-family: monospace;">{{ outcomes|safe }}</span>
{% else %}
              <span style="color: gray;">N/A</span>
{% endif %}
            </td>
{% else %}
{% set status = meta.get_subtask_score_status(st.idx) %}
{% set actual = meta.get_subtask_actual_score(st.idx) %}
{% set st_key = st.idx|string %}
{% set expected_min = meta.subtask_expected_scores[st_key].min if meta.subtask_expected_scores and st_key in meta.subtask_expected_scores else None %}
{% set expected_max = meta.subtask_expected_scores[st_key].max if meta.subtask_expected_scores and st_key in meta.subtask_expected_scores else None %}
            <td>
{% if status == "not_configured" %}
              <span style="color: gray;">Not configured</span>
{% elif status == "in_range" %}
              <span style="color: green;">✓ {{ "%.1f"|format(actual) }} ({{ "%.1f"|format(expected_min) }}-{{ "%.1f"|format(expected_max) }})</span>
{% elif status == "out_of_range" %}
              <span style="color: red;">✗ {{ "%.1f"|format(actual) }} ({{ "%.1f"|format(expected_min) }}-{{ "%.1f"|format(expected_max) }})</span>
{% else %}
              <span style="color: gray;">N/A</span>
{% endif %}
            </td>
{% endif %}
{% endfor %}
          </tr>
{% endif %}
{% endfor %}
        </tbody>
      </table>
{% endif %}
      <div class="hr"></div>
    </div>

  <!-- Test cases for this dataset -->

  <h4 id="title_testcases_{{ dataset.id }}" class="toggling_on">Test cases</h4>
    <div id="testcases_{{ dataset.id }}" class="task_dataset_testcases">

      <!-- Generators section -->
      <div class="generators_section" style="margin-bottom: 20px;">
        <strong>Generators</strong>
{% if admin.permission_all %}
        [<a href="{{ url("dataset", dataset.id, "generators", "add") }}">add</a>]
{% endif %}
        <div style="margin-top: 5px;">
        {% if dataset.generators|length == 0 %}
          No generators.
        {% else %}
          <table class="bordered" style="text-align:center; margin-top: 10px;">
            <thead>
              <tr>
                <th>Filename</th>
                <th>Template</th>
                <th>Ops</th>
              </tr>
            </thead>
            <tbody>
            {% for filename, generator in dataset.generators|dictsort(by="key") %}
              <tr>
                <td><a href="javascript:void(0);" onclick="utils.show_file('{{ generator.filename }}','{{ url("file", generator.digest, generator.filename) }}')">{{ generator.filename }}</a></td>
                <td>
                  {{ generator.input_filename_template }} / {{ generator.output_filename_template }}
                  [<a href="{{ url("dataset", dataset.id, "generator", generator.id, "edit") }}">edit</a>]
                </td>
                <td>
                  <a href="{{ url("dataset", dataset.id, "generator", generator.id, "generate") }}">Generate testcases</a>
{% if admin.permission_all %}
                  | <a onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "generator", generator.id, "delete") }}');">Delete</a>
{% endif %}
                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        {% endif %}
        </div>
      </div>
      <div class="hr"></div>

{% if admin.permission_all %}
      <a href="{{ url("dataset", dataset.id, "testcases", "add") }}">Add a testcase</a>
      <a href="{{ url("dataset", dataset.id, "testcases", "add_multiple") }}">Add multiple testcases</a>
{% endif %}
      <a href="{{ url("dataset", dataset.id, "testcases", "download") }}">Download all testcases</a>
{% if admin.permission_all %}
      <a href="javascript:void(0);" id="toggle_multi_delete_{{ dataset.id }}" onclick="toggleMultipleDeleteMode({{ dataset.id }});">Delete multiple testcases</a>
{% endif %}
      <table class="bordered" style="text-align:center">
        <thead>
          <tr>
            <th class="multi_delete_col_{{ dataset.id }}" style="display:none;">
              <input type="checkbox" id="multi_delete_master_{{ dataset.id }}" class="multi_delete_master multi_delete_master_{{ dataset.id }}" onclick="toggleSelectAllTestcases({{ dataset.id }}, this)">
            </th>
            <th>#</th>
            <th>Codename</th>
            <th>Public</th>
            {% if dataset.id in testcase_subtasks %}
            <th>Subtasks</th>
            {% endif %}
            <th>Input</th>
            <th>Output</th>
            <th>Ops</th>
          </tr>
        </thead>
        <tbody>
          {% for codename, testcase in dataset.testcases|dictsort(by="key") %}
          <tr>
            <td class="multi_delete_col_{{ dataset.id }}" style="display:none;">
              <input type="checkbox" class="multi_delete_checkbox_{{ dataset.id }}" value="{{ testcase.id }}">
            </td>
            <td style="font-weight:bold;">{{ loop.index }}</td>
            <td>{{ codename }}</td>
            <td style="font-weight:bold;">
              <input type="checkbox" name="testcase_{{ testcase.id }}_public" {% if testcase.public %}checked{% endif %} />
            </td>
            {% if dataset.id in testcase_subtasks %}
            <td>
              {% if codename in testcase_subtasks[dataset.id] %}
                {% set subtask_indices = testcase_subtasks[dataset.id][codename] %}
                {% set display_names = [] %}
                {% for idx in subtask_indices %}
                  {% if dataset.id in subtask_names and idx in subtask_names[dataset.id] %}
                    {% set _ = display_names.append(subtask_names[dataset.id][idx]) %}
                  {% else %}
                    {% set _ = display_names.append(idx) %}
                  {% endif %}
                {% endfor %}
                {{ display_names|join(", ") }}
              {% else %}
                -
              {% endif %}
            </td>
            {% endif %}
            <td>
              <a href="javascript:void(0);" onclick="utils.show_file('input_{{ testcase.codename }}','{{ url("file", testcase.input, "input_%s"|format(testcase.codename)) }}')">Show input</a>
            </td>
            <td>
              <a href="javascript:void(0);" onclick="utils.show_file('output_{{ testcase.codename }}','{{ url("file", testcase.output, "output_%s"|format(testcase.codename)) }}')">Show output</a>
            </td>
            <td>
              <a onclick="CMS.AWSUtils.ajax_delete('{{ url("dataset", dataset.id, "testcase", testcase.id, "delete") }}');">Delete</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
{% if admin.permission_all %}
      <div class="multi_delete_actions" id="multi_delete_actions_{{ dataset.id }}" style="display:none; text-align:left; margin-top:18px;">
        <a href="javascript:void(0);" id="cancel_multi_delete_{{ dataset.id }}" class="button-link button-link-secondary" style="display:none;" onclick="toggleMultipleDeleteMode({{ dataset.id }});">Cancel</a>
        <a href="javascript:void(0);" id="delete_selected_{{ dataset.id }}" class="button-link button-link-danger" style="display:none;" onclick="deleteSelectedTestcases({{ dataset.id }}, '{{ url("dataset", dataset.id, "testcases", "delete_selected") }}');">Delete testcases</a>
      </div>
{% endif %}
      <div class="hr"></div>
    </div>
  </div>
  {% endfor %}
  </div>
  <input type="submit"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="Update" />
  <input type="reset" value="Reset" />
  <a href="{{ url("task", task.id, "export") }}"> ⇩ Export </a>
</form>

{# Validator upload forms - placed outside the main task form to avoid nested form issues #}
{% if admin.permission_all %}
{% for dataset in task.datasets %}
{% if subtask_info.get(dataset.id) %}
{% for subtask in subtask_info[dataset.id] %}
<form id="validator_form_{{ dataset.id }}_{{ subtask.idx }}" method="POST" action="{{ url("dataset", dataset.id, "subtask", subtask.idx|string, "validator", "add") }}" enctype="multipart/form-data" style="display: none;">
  {{ xsrf_form_html|safe }}
</form>
{% endfor %}
<form id="rerun_validators_form_{{ dataset.id }}" method="POST" action="{{ url("dataset", dataset.id, "validators", "rerun") }}" style="display: none;">
  {{ xsrf_form_html|safe }}
</form>
{% endif %}
{% endfor %}
{% endif %}

<form action="{{ url("tasks") }}" method="POST" style="display:inline;">
    {{ xsrf_form_html|safe }}
    <input type="hidden" name="task_id" value="{{ task.id }}"/>
    <input type="submit"
         name="operation"
         value="Remove" style="float: right;"
{% if not admin.permission_all %}
         disabled
{% endif %}
         />
</form>
{% endblock core %}
