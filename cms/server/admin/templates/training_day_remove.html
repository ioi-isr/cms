{% extends "base.html" %}

{% block core %}
<div class="core_title">
  <h1>Remove Training Day</h1>
</div>

{% if admin.permission_all %}
<p>
  Are you sure you want to remove the training day
  <strong>{{ training_day.contest.name }}</strong>
  from training program
  <a href="{{ url("training_program", training_program.id) }}">{{ training_program.name }}</a>?
</p>

<p>
  <strong>Warning:</strong> This will remove {{ participation_count }} participation(s) and {{ submission_count }} submission(s)
  from the training day contest, regardless of the option you choose below.
  <br>
  This operation cannot be undone.
</p>

{% if task_count > 0 %}
<p>
  The training day has {{ task_count }} task(s) assigned. Please choose what to do with them:
</p>

<div style="margin: 20px 0;">
  <label style="display: block; margin-bottom: 10px;">
    <input type="radio" name="action" value="move" id="action_move">
    Move all tasks to another training day:
    <select name="target_training_day_id" id="target_training_day_select" style="margin-left: 10px;">
      <option value="">Select a training day</option>
      {% for td in other_training_days %}
      <option value="{{ td.id }}">{{ td.contest.name }}</option>
      {% endfor %}
    </select>
  </label>
  
  <label style="display: block; margin-bottom: 10px;">
    <input type="radio" name="action" value="detach">
    Remove tasks from training day but keep them in the training program (tasks will not belong to any training day)
  </label>
  
  <label style="display: block; margin-bottom: 10px; color: red; font-weight: bold;">
    <input type="radio" name="action" value="delete_all">
    Delete all tasks from the system
  </label>
</div>
{% endif %}

<br>
<a onclick="removeTrainingDay();" class="button-link">Yes, remove training day</a>
<a href="{{ url("training_program", training_program.id, "training_days") }}" class="button-link">No, cancel</a>

<script>
  {% if task_count > 0 %}
  // Enable/disable the target training day dropdown based on the selected action
  document.querySelectorAll('input[name="action"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      var targetSelect = document.getElementById('target_training_day_select');
      if (document.getElementById('action_move').checked) {
        targetSelect.disabled = false;
      } else {
        targetSelect.disabled = true;
      }
    });
  });
  
  // Initialize the dropdown state
  document.getElementById('target_training_day_select').disabled = true;
  {% endif %}
  
  function removeTrainingDay() {
    var url = '{{ url("training_program", training_program.id, "training_day", training_day.id, "remove") }}';
    
    {% if task_count > 0 %}
    var actionRadios = document.querySelectorAll('input[name="action"]');
    var selectedAction = null;
    for (var i = 0; i < actionRadios.length; i++) {
      if (actionRadios[i].checked) {
        selectedAction = actionRadios[i].value;
        break;
      }
    }
    
    if (!selectedAction) {
      alert('Please select an option for handling tasks.');
      return;
    }
    
    url += '?action=' + encodeURIComponent(selectedAction);
    
    if (selectedAction === 'move') {
      var targetId = document.getElementById('target_training_day_select').value;
      if (!targetId) {
        alert('Please select a target training day.');
        return;
      }
      url += '&target_training_day_id=' + encodeURIComponent(targetId);
    }
    {% endif %}
    
    CMS.AWSUtils.ajax_delete(url);
  }
</script>

{% else %}
You do not have permission to remove a training day.
{% endif %}

{% endblock core %}
