{% extends "base.html" %}

{% block core %}
<div class="core_title">
  <h1>Training Program</h1>
</div>

<!-- We use "multipart/form-data" to have Tornado distinguish between missing and empty values. -->
<form enctype="multipart/form-data" action="{{ url("training_program", training_program.id) }}" method="POST" name="edit_training_program" style="display:inline;">
  {{ xsrf_form_html|safe }}
  <table class="sub_table">
    <tr><td colspan=2><h2>Training Program Information</h2></td></tr>
    <tr>
      <td>
        <span class="info" title="A short name for the training program, preferably using only letters, numbers and underscores."></span>
        Name
      </td>
      <td><input type="text" name="name" value="{{ training_program.name }}"/></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The name of the training program as seen by users."></span>
        Description
      </td>
      <td><textarea name="description">{{ training_program.description }}</textarea></td>
    </tr>

    <tr><td colspan=2><h2>Contest Settings</h2></td></tr>
    <tr>
      <td>
        <span class="info" title="Programming languages that students can use to solve the tasks."></span>
        Allowed programming languages
      </td>
      <td class="wrapping-options">
        {% for lang in LANGUAGES %}
          <label><input type="checkbox" name="languages" value="{{ lang.name }}" {{ "checked" if lang.name in training_program.managing_contest.languages else "" }}>{{ lang.name }}</label>
        {% endfor %}
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Whether students can download their own submissions."></span>
        <label for="submissions_download_allowed">Submissions download allowed</label>
      </td>
      <td>
        <input type="checkbox" id="submissions_download_allowed" name="submissions_download_allowed" {{ "checked" if training_program.managing_contest.submissions_download_allowed else "" }}/>
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Whether students can submit questions."></span>
        <label for="allow_questions">Allow questions</label>
      </td>
      <td>
        <input type="checkbox" id="allow_questions" name="allow_questions" {{ "checked" if training_program.managing_contest.allow_questions else "" }}/>
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Whether students can submit user tests."></span>
        <label for="allow_user_tests">Allow user tests</label>
      </td>
      <td>
        <input type="checkbox" id="allow_user_tests" name="allow_user_tests" {{ "checked" if training_program.managing_contest.allow_user_tests else "" }}/>
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The number of decimal places the scores will be rounded to."></span>
        Score decimal places
      </td>
      <td><input type="text" name="score_precision" value="{{ training_program.managing_contest.score_precision }}" size="3"></td>
    </tr>

    <tr><td colspan=2><h2>Times</h2></td></tr>
    <tr>
      <td>
        <span class="info" title="When the training program starts."></span>
        Start time
      </td>
      <td><input type="datetime-local" name="start" value="{{ training_program.managing_contest.start.strftime('%Y-%m-%dT%H:%M') }}"/></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="When the training program ends. Must be after start time."></span>
        End time
      </td>
      <td><input type="datetime-local" name="stop" value="{{ training_program.managing_contest.stop.strftime('%Y-%m-%dT%H:%M') }}"/></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Timezone of the server, used to display times to students."></span>
        Timezone
      </td>
      <td><input type="text" name="timezone" value="{{ training_program.managing_contest.timezone if training_program.managing_contest.timezone is not none else "" }}"></td>
    </tr>

    <tr><td colspan=2><h2>Limits</h2></td></tr>
    <tr>
      <td>
        <span class="info" title="Maximum number of submissions each student can submit, for the whole training program. Leave empty for no limits."></span>
        Maximum number of submissions
      </td>
      <td><input type="text" name="max_submission_number" value="{{ training_program.managing_contest.max_submission_number if training_program.managing_contest.max_submission_number is not none else "" }}" size="5"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Maximum number of user tests each student can submit. Leave empty for no limits."></span>
        Maximum number of user tests
      </td>
      <td><input type="text" name="max_user_test_number" value="{{ training_program.managing_contest.max_user_test_number if training_program.managing_contest.max_user_test_number is not none else "" }}" size="5"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The minimum amount of time (in seconds) that a student needs to wait after a submission before being able to submit another. Leave empty for no limits."></span>
        Minimum interval between submissions
      </td>
      <td><input type="text" name="min_submission_interval" value="{{ training_program.managing_contest.min_submission_interval.total_seconds()|int if training_program.managing_contest.min_submission_interval is not none else "" }}" size="5"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The minimum amount of time (in seconds) that a student needs to wait after a user test before being able to send another. Leave empty for no limits."></span>
        Minimum interval between user tests
      </td>
      <td><input type="text" name="min_user_test_interval" value="{{ training_program.managing_contest.min_user_test_interval.total_seconds()|int if training_program.managing_contest.min_user_test_interval is not none else "" }}" size="5"></td>
    </tr>

    <tr><td colspan=2><h2>Tokens parameters</h2></td></tr>
    <tr>
      <td>
        <span class="info" title="Select 'disabled' to remove tokens completely, 'infinite' for allowing any number of tokens, or 'finite' to specify the amount with the following parameters."></span>
        Token mode
      </td>
      <td>
        <select name="token_mode">
          <option value="{{ TOKEN_MODE_DISABLED }}" {{ "selected" if training_program.managing_contest.token_mode == TOKEN_MODE_DISABLED else "" }}>Disabled</option>
          <option value="{{ TOKEN_MODE_FINITE }}" {{ "selected" if training_program.managing_contest.token_mode == TOKEN_MODE_FINITE else "" }}>Finite</option>
          <option value="{{ TOKEN_MODE_INFINITE }}" {{ "selected" if training_program.managing_contest.token_mode == TOKEN_MODE_INFINITE else "" }}>Infinite</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The maximum number of tokens a student can use in the whole training program. It is used only if tokens are finite."></span>
        Maximum number of tokens
      </td>
      <td><input type="text" name="token_max_number" value="{{ training_program.managing_contest.token_max_number if training_program.managing_contest.token_max_number is not none else "" }}" size="3"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The minimum amount of time (in seconds) that a student needs to wait after using a token before being able to use another. It is used only if tokens are finite."></span>
        Minimum interval between tokens
      </td>
      <td><input type="text" name="token_min_interval" value="{{ training_program.managing_contest.token_min_interval.total_seconds()|int }}" size="3"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The number of tokens that a student has available when they start. It is used only if tokens are finite."></span>
        Initial number of tokens
      </td>
      <td><input type="text" name="token_gen_initial" value="{{ training_program.managing_contest.token_gen_initial }}" size="3"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The number of tokens that are generated periodically. It is used only if tokens are finite."></span>
        Token generation number
      </td>
      <td><input type="text" name="token_gen_number" value="{{ training_program.managing_contest.token_gen_number }}" size="3"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="The amount of time (in minutes) between two token generation events. It is used only if tokens are finite."></span>
        Token generation period
      </td>
      <td><input type="text" name="token_gen_interval" value="{{ training_program.managing_contest.token_gen_interval.total_seconds()|int // 60 }}" size="3"></td>
    </tr>
    <tr>
      <td>
        <span class="info" title="Maximum number of tokens available to a student at any given time. It is used only if tokens are finite."></span>
        Maximum accumulated tokens
      </td>
      <td><input type="text" name="token_gen_max" value="{{ training_program.managing_contest.token_gen_max if training_program.managing_contest.token_gen_max is not none else "" }}" size="3"></td>
    </tr>
  </table>
  <input type="submit" value="Update"{% if not admin.permission_all %} disabled{% endif %}/>
  <input type="reset" value="Reset">
</form>

<script>
CMS.AWSUtils.initDateTimeValidation(
  'form[name="edit_training_program"]',
  'input[name="start"]',
  'input[name="stop"]'
);
</script>

<form action="{{ url("training_programs") }}" method="POST" style="display:inline;">
  {{ xsrf_form_html|safe }}
  <input type="hidden" name="training_program_id" value="{{ training_program.id }}"/>
  <input type="submit" name="operation" value="Remove" style="float: right;"/>
</form>


<h3>Students ({{ training_program.students|length }})</h3>
<ul>
  {% if training_program.students|length == 0 %}
    <li>(no students yet)</li>
  {% else %}
    {% for student in training_program.students[:10] %}
      {% set u = student.participation.user %}
      <li><a href="{{ url("training_program", training_program.id, "student", u.id, "edit") }}">{{ u.username }}</a> - {{ u.first_name }} {{ u.last_name }}</li>
    {% endfor %}
    {% if training_program.students|length > 10 %}
      <li>... and {{ training_program.students|length - 10 }} more</li>
    {% endif %}
  {% endif %}
</ul>

<h3>Tasks ({{ training_program.managing_contest.tasks|length }})</h3>
<ul>
  {% if training_program.managing_contest.tasks|length == 0 %}
    <li>(no tasks yet)</li>
  {% else %}
    {% for t in training_program.managing_contest.tasks[:10] %}
      <li><a href="{{ url("task", t.id) }}">{{ t.name }}</a> - {{ t.title }}</li>
    {% endfor %}
    {% if training_program.managing_contest.tasks|length > 10 %}
      <li>... and {{ training_program.managing_contest.tasks|length - 10 }} more</li>
    {% endif %}
  {% endif %}
</ul>

{% endblock core %}
