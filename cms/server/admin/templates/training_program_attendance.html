{% extends "base.html" %}

{% block core %}
<style>
/* Status badge styles for attendance tracking */
.attendance-badge {
  display: inline-block;
  padding: 2px 8px;
  font-size: 11px;
  font-weight: bold;
  border-radius: 3px;
  color: white;
  white-space: nowrap;
}

.attendance-icon {
  margin-right: 4px;
}

/* Status colors */
.badge-on-time {
  background-color: #28a745; /* Green */
}

.badge-delayed {
  background-color: #ffc107; /* Yellow/amber */
  color: #333;
}

.badge-missed {
  background-color: #dc3545; /* Red */
}

/* Location colors */
.badge-class {
  background-color: #17a2b8; /* Blue */
}

.badge-home {
  background-color: #6f42c1; /* Purple */
}

.badge-both {
  background-color: #fd7e14; /* Orange */
}

.badge-unknown {
  background-color: #6c757d; /* Gray */
}

/* Column coloring for training days */
.col-status {
  background-color: rgba(40, 167, 69, 0.08); /* Light green tint */
}

.col-location {
  background-color: rgba(23, 162, 184, 0.08); /* Light blue tint */
}

.col-reasons {
  background-color: rgba(108, 117, 125, 0.08); /* Light gray tint */
}

/* Header styling for training days */
.training-day-header {
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

.training-day-date {
  font-size: 11px;
  font-weight: normal;
  color: #6c757d;
}
</style>

<div class="core_title">
  <h1>Attendance for <a href="{{ url("training_program", training_program.id) }}">{{ training_program.name }}</a></h1>
</div>

<h2>Filter by Date</h2>
<form action="{{ url("training_program", training_program.id, "attendance") }}" method="GET">
  <label for="start_date">From:</label>
  <input type="date" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') if start_date else '' }}" />
  <label for="end_date">To:</label>
  <input type="date" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') if end_date else '' }}" />
  <input type="submit" value="Filter" />
  {% if start_date or end_date %}
  <a href="{{ url("training_program", training_program.id, "attendance") }}" class="btn btn-small">Clear</a>
  {% endif %}
</form>

<h2>Attendance Table</h2>

{% if archived_training_days %}
<div style="overflow-x: auto;">
<table class="bordered" id="attendance_table">
  <thead>
    <tr>
      <th rowspan="2">Student</th>
      {% for td in archived_training_days %}
      <th colspan="3" class="training-day-header">
        {{ td.description or td.name or "(no name)" }}
        {% if td.start_time %}
        <br><span class="training-day-date">({{ td.start_time.strftime('%Y-%m-%d') }})</span>
        {% endif %}
      </th>
      {% endfor %}
    </tr>
    <tr>
      {% for td in archived_training_days %}
      <th class="col-status">Status</th>
      <th class="col-location">Location</th>
      <th class="col-reasons">Reasons</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for student in sorted_students %}
    <tr>
      <td>
        {% if student.participation %}
          <a href="{{ url("training_program", training_program.id, "student", student.participation.user.id) }}">
            {{ student.participation.user.username }}
          </a>
        {% else %}
          (unknown)
        {% endif %}
      </td>
      {% for td in archived_training_days %}
        {% set att = attendance_data.get(student.id, {}).get(td.id) %}
        {% if att %}
          <td class="col-status">
            {% if att.status == "missed" %}
              <span class="attendance-badge badge-missed">
                <span class="attendance-icon">&#x26D4;</span>Missed
              </span>
            {% elif att.delay_time %}
              <span class="attendance-badge badge-delayed">
                <span class="attendance-icon">&#x23F1;</span>Delayed ({{ "%.1f"|format(att.delay_time.total_seconds() / 3600) }}h)
              </span>
            {% else %}
              <span class="attendance-badge badge-on-time">
                <span class="attendance-icon">&#x2713;</span>On Time
              </span>
            {% endif %}
          </td>
          <td class="col-location">
            {% if att.location == "class" %}
              <span class="attendance-badge badge-class">
                <span class="attendance-icon">&#x1F3EB;</span>Class
              </span>
            {% elif att.location == "home" %}
              <span class="attendance-badge badge-home">
                <span class="attendance-icon">&#x1F3E0;</span>Home
              </span>
            {% elif att.location == "both" %}
              <span class="attendance-badge badge-both">
                <span class="attendance-icon">&#x21C4;</span>Both
              </span>
            {% elif att.location %}
              <span class="attendance-badge badge-unknown">{{ att.location }}</span>
            {% else %}
              <span class="attendance-badge badge-unknown">-</span>
            {% endif %}
          </td>
          <td class="col-reasons">{{ att.delay_reasons or "-" }}</td>
        {% else %}
          <td class="col-status">-</td>
          <td class="col-location">-</td>
          <td class="col-reasons">-</td>
        {% endif %}
      {% endfor %}
    </tr>
    {% else %}
    <tr>
      <td colspan="{{ 1 + archived_training_days|length * 3 }}">(no attendance data)</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
</div>

<script>
  $(document).ready(function() {
    CMS.AWSUtils.init_table_sort($("#attendance_table"), false, 0, false);
  });
</script>
{% else %}
<p><em>No archived training days found{% if start_date or end_date %} matching the selected date range{% endif %}. Archive a training day to see attendance data here.</em></p>
{% endif %}
{% endblock core %}
