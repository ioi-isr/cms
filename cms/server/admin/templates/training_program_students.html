{% extends "base.html" %}

{% block js_init %}
CMS.AWSUtils.initReadOnlyTagify('.student-tags-display');
CMS.AWSUtils.init_table_sort($("#students_table"), false, 1, true);
{% endblock js_init %}

{% block core %}
<div class="core_title">
  <h1>Students list</h1>
</div>

{% include "fragments/overload_warning.html" %}

<p>
  <a href="{{ url("training_program", training_program.id, "bulk_assign_task") }}">Bulk Assign Task by Tag</a>
</p>

<form action="{{ url("training_program", training_program.id, "students", "bulk_add") }}" method="POST" enctype="multipart/form-data">
  {{ xsrf_form_html|safe }}
  Add students from a list:
  <input type="file" name="students_file" accept=".txt"
{% if not admin.permission_all %}
         disabled
{% endif %}
         />
  <input type="submit"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="Upload and add students" />
  <br/>
  <small>Upload a .txt file with whitespace-separated usernames</small>
</form>

{% if bulk_add_results %}
<h2>Bulk Add Results</h2>
<p>{{ students_added }} student(s) successfully added to the training program.</p>
<table class="bordered">
  <thead>
    <tr>
      <th>Username</th>
      <th>Status</th>
      <th>Message</th>
    </tr>
  </thead>
  <tbody>
    {% for result in bulk_add_results %}
    <tr>
      <td>{{ result.username }}</td>
      <td>
        {% if result.status == "success" %}
        <span style="color: green;">Success</span>
        {% elif result.status == "already_exists" %}
        <span style="color: orange;">Already in program</span>
        {% else %}
        <span style="color: red;">Not found</span>
        {% endif %}
      </td>
      <td>{{ result.message }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<form action="{{ url("training_program", training_program.id, "students", "add") }}" method="POST">
  {{ xsrf_form_html|safe }}
  Add a new student:
  <select name="user_id" class="searchable-select">
    <option value="" selected disabled hidden>Select a new user...</option>
    {% for u in unassigned_users %}
    <option value="{{ u.id }}">
      {{ u.username }}
    </option>
    {% endfor %}
  </select>
  <input type="submit"
{% if not admin.permission_all %}
         disabled
{% endif %}
         value="Add student" />
</form>

<form action="{{ url("training_program", training_program.id, "students") }}" method="POST">
  {{ xsrf_form_html|safe }}
  Edit selected student:
  <input type="submit"
         name="operation"
         value="Remove from training program"
{% if not admin.permission_all %}
         disabled
{% endif %}
         />
  <table class="bordered" id="students_table">
    <thead>
      <tr>
        <th class="no-sort"></th>
        <th>Username</th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Student Tags</th>
        <th data-sort-settings="numeric reversed">Task Archive Progress</th>
      </tr>
    </thead>
    <tbody>
      {% for student in training_program.students|sort(attribute="participation.user.username") %}
      {% set u = student.participation.user %}
      {% set progress = student_progress.get(student.id, {}) %}
      <tr>
        <td>
          <input type="radio" name="user_id" value="{{ u.id }}"/>
        </td>
        <td><a href="{{ url("training_program", training_program.id, "student", u.id, "edit") }}">{{ u.username }}</a></td>
        <td>{{ u.first_name }}</td>
        <td>{{ u.last_name }}</td>
        <td>
          {% if student.student_tags %}
          <input type="text" class="student-tags-display" value="{{ student.student_tags|join(", ") }}" readonly/>
          {% else %}
          <span class="no-tags-indicator">No tags</span>
          {% endif %}
        </td>
        <td data-value="{{ progress.percentage|default(0) }}">
          {% if progress.task_count > 0 %}
          {{ "%.1f"|format(progress.percentage) }}% ({{ "%.1f"|format(progress.total_score) }}/{{ "%.1f"|format(progress.max_score) }}) [<a href="{{ url("training_program", training_program.id, "student", u.id, "tasks") }}">details</a>]
          {% else %}
          No tasks [<a href="{{ url("training_program", training_program.id, "student", u.id, "tasks") }}">details</a>]
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</form>

{% endblock core %}
