{% extends "base.html" %}

{% block core %}
<div class="content-constraint" style="max-width: 1400px;">
    <!-- Header -->
    <div class="tp-page-header">
        <div class="page-title">
            <h1>Training Programs</h1>
        </div>
    </div>

    <!-- Stats Cards Row -->
    <div class="tp-stats-row">
        <div class="tp-stat-card">
            <div class="tp-stat-icon tp-stat-icon-purple">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M22 10v6M2 10l10-5 10 5-10 5z"></path>
                    <path d="M6 12v5c3 3 9 3 12 0v-5"></path>
                </svg>
            </div>
            <div class="tp-stat-content">
                <div class="tp-stat-label">Active Programs</div>
                <div class="tp-stat-value">{{ active_programs }}</div>
            </div>
        </div>
        <div class="tp-stat-card">
            <div class="tp-stat-icon tp-stat-icon-green">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </div>
            <div class="tp-stat-content">
                <div class="tp-stat-label">Total Students</div>
                <div class="tp-stat-value">{{ total_students }}</div>
            </div>
        </div>
        <div class="tp-stat-card">
            <div class="tp-stat-icon tp-stat-icon-orange">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
            </div>
            <div class="tp-stat-content">
                <div class="tp-stat-label">Active Training Days</div>
                <div class="tp-stat-value">{{ active_training_days }}</div>
            </div>
        </div>
    </div>

    <!-- Program Cards Grid -->
    <div class="tp-cards-grid">
        {% for tp in training_programs %}
        {% set active_tds = tp.training_days | selectattr("contest") | list %}
        {% set archived_tds = tp.training_days | rejectattr("contest") | list %}
        {% set total_tds = tp.training_days | length %}
        <div class="tp-program-card">
            <!-- Card Header with Menu -->
            <div class="tp-card-header">
                <div class="tp-card-title-section">
                    <a href="{{ url("training_program", tp.id) }}" class="tp-card-title">{{ tp.name }}</a>
                    <div class="tp-card-description">{{ tp.description }}</div>
                </div>
                <div class="tp-card-menu">
                    <button type="button" class="tp-menu-btn" onclick="toggleMenu(this)"
                            title="More options" aria-haspopup="menu" aria-expanded="false">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <circle cx="12" cy="5" r="2"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                            <circle cx="12" cy="19" r="2"></circle>
                        </svg>
                    </button>
                    <div class="tp-menu-dropdown">
                        <a href="{{ url("training_program", tp.id) }}" class="tp-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Edit Program
                        </a>
                        <a href="{{ url("training_program", tp.id, "students") }}" class="tp-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Manage Students
                        </a>
                        <a href="{{ url("training_program", tp.id, "tasks") }}" class="tp-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Manage Tasks
                        </a>
                        <a href="{{ url("training_program", tp.id, "training_days") }}" class="tp-menu-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Training Days
                        </a>
                        {% if admin.permission_all %}
                        <div class="tp-menu-divider"></div>
                        <a href="{{ url("training_programs", tp.id, "remove") }}" class="tp-menu-item tp-menu-item-danger">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Remove
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="tp-card-stats">
                <div class="tp-card-stat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>{{ tp.managing_contest.participations|length }} Students</span>
                </div>
                <div class="tp-card-stat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                    </svg>
                    <span>{{ tp.managing_contest.tasks|length }} Tasks</span>
                </div>
            </div>

            <!-- Date Range -->
            <div class="tp-card-dates">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                {% if tp.managing_contest.start and tp.managing_contest.stop %}
                <span>{{ tp.managing_contest.start.strftime('%Y-%m-%d') }} &mdash; {{ tp.managing_contest.stop.strftime('%Y-%m-%d') }}</span>
                {% else %}
                <span class="text-muted">No dates set</span>
                {% endif %}
            </div>

            <!-- Active Training Days Section -->
            {% if active_tds %}
            <div class="tp-card-training-days">
                <div class="tp-training-days-header">
                    <a href="{{ url("training_program", tp.id, "training_days") }}" class="tp-training-days-label tp-training-days-link">ACTIVE TRAINING DAYS</a>
                </div>
                <div class="tp-training-days-list">
                    {% for td in active_tds[:3] %}
                    {% set td_notif = training_day_notifications.get(td.id, {}) %}
                    <a href="{{ url("contest", td.contest.id) }}" class="tp-training-day-item">
                        <div class="tp-training-day-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="tp-training-day-info">
                            <div class="tp-training-day-name">{{ td.contest.name }}</div>
                            {% if td.contest.start and td.contest.start.year <= tp.managing_contest.stop.year %}
                            <div class="tp-training-day-date">{{ td.contest.start.strftime('%b %d') }}</div>
                            {% else %}
                            <div class="tp-training-day-date">Unscheduled</div>
                            {% endif %}
                        </div>
                        <div class="tp-training-day-indicators">
                            {% if td_notif.get("unanswered_questions", 0) > 0 %}
                            <span class="tp-indicator tp-indicator-question" title="{{ td_notif.unanswered_questions }} unanswered question{{ 's' if td_notif.unanswered_questions != 1 else '' }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                {{ td_notif.unanswered_questions }}
                            </span>
                            {% endif %}
                            {% if td_notif.get("pending_delay_requests", 0) > 0 %}
                            <span class="tp-indicator tp-indicator-delay" title="{{ td_notif.pending_delay_requests }} pending delay request{{ 's' if td_notif.pending_delay_requests != 1 else '' }}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                {{ td_notif.pending_delay_requests }}
                            </span>
                            {% endif %}
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="tp-training-day-arrow">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </a>
                    {% endfor %}
                    {% if active_tds|length > 3 %}
                    <a href="{{ url("training_program", tp.id, "training_days") }}" class="tp-training-day-more">
                        +{{ active_tds|length - 3 }} more
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Archived Training Days Counter -->
            <div class="tp-card-stats tp-card-stats-bottom">
                <div class="tp-card-stat">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 8v13H3V8"></path>
                        <path d="M1 3h22v5H1z"></path>
                        <path d="M10 12h4"></path>
                    </svg>
                    <span>{{ archived_tds|length }} Archived Days</span>
                </div>
            </div>
        </div>
        {% endfor %}

        <!-- Create New Program Card -->
        {% if admin.permission_all %}
        <a href="{{ url("training_programs", "add") }}" class="tp-create-card">
            <div class="tp-create-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </div>
            <div class="tp-create-title">Create New Program</div>
            <div class="tp-create-subtitle">Start a new training season</div>
        </a>
        {% endif %}
    </div>
</div>

<script>
function closeAllMenus() {
    document.querySelectorAll('.tp-menu-dropdown.show').forEach(function(d) {
        d.classList.remove('show');
    });
    document.querySelectorAll('.tp-menu-btn[aria-expanded="true"]').forEach(function(b) {
        b.setAttribute('aria-expanded', 'false');
    });
}

function toggleMenu(btn) {
    var dropdown = btn.nextElementSibling;
    var isOpen = dropdown.classList.contains('show');

    closeAllMenus();

    if (!isOpen) {
        dropdown.classList.add('show');
        btn.setAttribute('aria-expanded', 'true');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.tp-card-menu')) {
        closeAllMenus();
    }
});
</script>

{% endblock core %}
