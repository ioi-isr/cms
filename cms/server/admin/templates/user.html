{% extends "base.html" %}

{% block core %}
<h1>{{ user.first_name }} {{ user.last_name }} ({{ user.username }})</h1>

<h2 id="title_participations" class="toggling_on">Participations</h2>
<div id="participations">

  <form action="{{ url("user", user.id, "add_participation") }}" method="POST">
    {{ xsrf_form_html|safe }}
    Add a new participation:
    <select name="contest_id" class="searchable-select">
      <option value="" selected disabled hidden>Select a contest...</option>
      {% for c in unassigned_contests %}
      <option value="{{ c.id }}">
        {{ c.name }}
      </option>
      {% endfor %}
    </select>
    <input type="checkbox" name="hidden" id="hidden" /><label for="hidden">Hidden</label>
    <input type="checkbox" name="unrestricted" id="unrestricted" /><label for="unrestricted">Unrestricted</label>
    <input type="submit" value="Add participation" />
  </form>

  {% if participations == [] %}
  <p>No participations found.</p>
  {% else %}
  <form action="{{ url("user", user.id, "edit_participation") }}" method="POST">
    {{ xsrf_form_html|safe }}
    Edit selected participation:
    <input type="submit" name="operation" value="Remove" />
    <table class="bordered">
      <thead>
        <tr>
          <th></th>
          <th>Participation</th>
          <th>Hidden?</th>
          <th>Unrestricted?</th>
          <th>Contest</th>
          <th>Contest description</th>
        </tr>
      </thead>
      <tbody>
        {% for p in participations %}
        <tr>
          <td>
            <input type="radio" name="contest_id" value="{{ p.contest.id }}"/>
          </td>
          <td><a href="{{ url("contest", p.contest.id, "user", p.user.id, "edit") }}">{{ p.user.username }}</a></td>
          <td>{{ p.hidden }}</td>
          <td>{{ p.unrestricted }}</td>
          <td><a href="{{ url("contest", p.contest.id) }}">{{ p.contest.name }}</a></td>
          <td>{{ p.contest.description }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
  {% endif %}
  <div class="hr"></div>
</div>


<h2 id="title_password_reset" class="toggling_on">Password Reset</h2>
<div id="password_reset">
  {% if user.password_reset_pending %}
  <div class="panel-warning">
    <strong>Pending Password Reset</strong>
    <p>This user has submitted a password reset request that is awaiting approval.</p>
    <form action="{{ url("user", user.id, "approve_password_reset") }}" method="POST" style="display:inline;" onsubmit="return confirm('Approve password reset for ' + {{ user.username|tojson }} + '?');">
      {{ xsrf_form_html|safe }}
      <input type="submit" value="Approve Reset" class="btn-success" />
    </form>
    <form action="{{ url("user", user.id, "deny_password_reset") }}" method="POST" style="display:inline;" onsubmit="return confirm('Deny password reset for ' + {{ user.username|tojson }} + '?');">
      {{ xsrf_form_html|safe }}
      <input type="submit" value="Deny Reset" class="btn-danger" />
    </form>
  </div>
  {% endif %}

  {% if user.password_reset_token and user.password_reset_token_expires %}
  <div class="panel-info">
    <strong>Active Password Reset Token</strong>
    <p>A password reset link is active for this user. Copy and share the reset URL below if email delivery failed.</p>
    <table>
      <tr>
        <td><strong>Reset URL:</strong></td>
        <td>
          {% if participations|length > 0 %}
          <code style="word-break: break-all;">/{{ participations[0].contest.name }}/password_reset_confirm/{{ user.password_reset_token }}</code>
          <br><small>(Relative path - prepend your CWS server address, e.g., https://your-cws-server.com)
          {% if participations|length > 1 %}
          <br>Note: This user participates in multiple contests. The reset URL works for any contest they're registered in.
          {% endif %}
          </small>
          {% else %}
          <div class="alert alert-warning" style="padding: 5px; margin: 5px 0; background-color: #fcf8e3; border: 1px solid #faebcc; border-radius: 4px;">
            <strong>Note:</strong> This user has no contest participations. Password reset links require a contest context.
            <br>Please add a participation for this user first, then the reset URL will be available.
          </div>
          {% endif %}
        </td>
      </tr>
      <tr>
        <td><strong>Expires:</strong></td>
        <td>{{ user.password_reset_token_expires|format_datetime }}</td>
      </tr>
    </table>
    <p style="margin-top: 10px;">
      <form action="{{ url("user", user.id, "clear_reset_token") }}" method="POST" style="display:inline;">
        {{ xsrf_form_html|safe }}
        <input type="submit" value="Clear Token" class="btn btn-warning" />
      </form>
    </p>
  </div>
  {% elif not user.password_reset_pending %}
  <p>No active password reset token or pending reset for this user.</p>
  {% endif %}
  <div class="hr"></div>
</div>


<h2 id="title_general_info" class="toggling_on">General Information</h2>
<div id="general_info">
  <!-- We use "multipart/form-data" to have Tornado distinguish between missing and empty values. -->
  <form enctype="multipart/form-data" action="{{ url("user", user.id) }}" method="POST" style="display:inline;">
    {{ xsrf_form_html|safe }}
    <table>
      <tr>
        <td>
          <span class="info" title="First name of the contestant."></span>
          First name
        </td>
        <td><input type="text" name="first_name" value="{{ user.first_name }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Last name of the contestant."></span>
          Last name
        </td>
        <td><input type="text" name="last_name" value="{{ user.last_name }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Username of the contestant (used to log in)."></span>
          Username
        </td>
        <td><input type="text" name="username" value="{{ user.username }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Contestant password. Caution: stored in plain text."></span>
          Password
        </td>
        <td>
          {% set hashed_password = user.password %}
          {% include "fragments/hashed_password_form.html" %}
        </td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Contestant e-mail address."></span>
          E-mail
        </td>
        <td><input type="text" name="email" value="{{ user.email if user.email is not none else "" }}"/></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Timezone of the contestant, used to display start, end times and the current server time in local time.
                                    Example: 'Europe/Rome', 'America/New_York', ..."></span>
          Timezone
        </td>
        <td><input type="text" name="timezone" value="{{ user.timezone if user.timezone is not none else "" }}"></td>
      </tr>
      <tr>
        <td>
          <span class="info" title="Comma-separated list of language codes, from the most to the least preferred.
                                    Example: 'en, ja'."></span>
          Preferred languages
        </td>
        <td><input type="text" name="preferred_languages" value="{{ user.preferred_languages|join(", ") }}"></td>
      </tr>
    </table>
    <input type="submit" value="Update" />
    <input type="reset" value="Reset" />
  </form>
  <form action="{{ url("users") }}" method="POST" style="display:inline;">
      {{ xsrf_form_html|safe }}
      <input type="hidden" name="user_id" value="{{ user.id }}"/>
      <input type="submit"
           name="operation"
           value="Remove" style="float: right;"
  {% if not admin.permission_all %}
           disabled
  {% endif %}
           />
  </form>
  <div class="hr"></div>
</div>


{% endblock core %}
