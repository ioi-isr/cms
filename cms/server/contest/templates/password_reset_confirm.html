{% extends "base.html" %}

{% block title %}
    {{ contest.description }} - {% trans %}Password Reset{% endtrans %}
{% endblock title %}

{% block js %}
<script src="{{ url('static', 'js', 'zxcvbn.js') }}"></script>
{% endblock js %}

{% block body %}

<style>
.password-strength-bar {
    height: 5px;
    margin-top: 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
}
.password-strength-bar.strength-0 { background-color: #dc3545; width: 20%; }
.password-strength-bar.strength-1 { background-color: #dc3545; width: 40%; }
.password-strength-bar.strength-2 { background-color: #ffc107; width: 60%; }
.password-strength-bar.strength-3 { background-color: #28a745; width: 80%; }
.password-strength-bar.strength-4 { background-color: #28a745; width: 100%; }
</style>

<script>
$(document).ready(function() {
    const strengthMessages = [
        "{% trans %}Very weak{% endtrans %}",
        "{% trans %}Weak{% endtrans %}",
        "{% trans %}Fair{% endtrans %}",
        "{% trans %}Strong{% endtrans %}",
        "{% trans %}Very strong{% endtrans %}",
    ];

    $("#password").on("input", function() {
        const pwd = $(this).val();
        const $helpBlock = $("#password-input span.help-block");
        const $strengthBar = $("#password-strength-bar");

        if (!pwd) {
            $helpBlock.text("{% trans %}Must be {{ MIN_PASSWORD_LENGTH }} characters or more.{% endtrans %}");
            $strengthBar.removeClass("strength-0 strength-1 strength-2 strength-3 strength-4").hide();
            $("#password-input").removeClass("error");
            return;
        }

        if (typeof zxcvbn === "function") {
            const username = {{ username|tojson }};
            const result = zxcvbn(pwd, [username].filter(Boolean));
            const score = result.score;
            const label = strengthMessages[score] || "";

            $helpBlock.text("{% trans %}Password strength:{% endtrans %} " + label);
            $strengthBar
                .removeClass("strength-0 strength-1 strength-2 strength-3 strength-4")
                .addClass("strength-" + score)
                .show();

            if (score < 3) {
                $("#password-input").addClass("error");
            } else {
                $("#password-input").removeClass("error");
            }
        }
    });
});
</script>

<div class="register_box hero-unit">
    <h1>{% trans %}Reset Password{% endtrans %}</h1>
    <p>{% trans %}Enter a new password for user:{% endtrans %} <strong>{{ username }}</strong></p>

    {% if error_message is defined and error_message %}
    <div class="alert alert-error">
        {{ gettext(error_message) }}
    </div>
    {% endif %}

    <form class="form-horizontal" action="{{ contest_url('password_reset_confirm', token) }}" method="post">
        {{ xsrf_form_html|safe }}
        <fieldset>
            <div id="password-input" class="control-group">
                <label class="control-label" for="password">{% trans %}New Password{% endtrans %}</label>
                <div class="controls">
                    <input required minlength="{{ MIN_PASSWORD_LENGTH }}" type="password" class="input-xlarge" name="password" id="password" autocomplete="new-password">
                    <div id="password-strength-bar" class="password-strength-bar" style="display: none;"></div>
                    <span class="help-block">
                        {% trans min_length=MIN_PASSWORD_LENGTH %}Must be {{ min_length }} characters or more.{% endtrans %}
                    </span>
                </div>
            </div>
            <div id="password-confirm-input" class="control-group">
                <label class="control-label" for="password_confirm">{% trans %}Confirm Password{% endtrans %}</label>
                <div class="controls">
                    <input required minlength="{{ MIN_PASSWORD_LENGTH }}" type="password" class="input-xlarge" name="password_confirm" id="password_confirm" autocomplete="new-password">
                </div>
            </div>
            <div class="control-group">
                <div class="controls">
                    <button type="submit" class="btn btn-primary btn-large">{% trans %}Reset Password{% endtrans %}</button>
                </div>
            </div>
        </fieldset>
    </form>

    <p><a href="{{ contest_url() }}">{% trans %}Back to login{% endtrans %}</a></p>
</div>

{% endblock body %}
