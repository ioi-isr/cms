{% extends "contest.html" %}
{% from "macro/delay_request.html" import delay_request_form, delay_request_list with context %}
{% from "macro/training_day_card.html" import training_day_card with context %}

{% set page = "training_overview" %}

{% block core %}

<div class="span9">

<link rel="stylesheet" href="{{ url("static", "training_day_cards.css") }}">

<div class="page-header">
    <h1>{{ training_program.description if training_program.description else training_program.name }}</h1>
</div>

{% if upcoming_training_days|length > 0 %}
<h2 class="tp-section-heading">{% trans %}Upcoming Training Days{% endtrans %}</h2>

<div class="training-day-list">
{% for td_info in upcoming_training_days %}
    {{ training_day_card(td_info, loop.index, training_program, delay_request_form, delay_request_list, url, xsrf_form_html, timezone, now, next_url_suffix="training_overview", show_ended_status=False) }}
{% endfor %}
</div>
{% endif %}

<h2 style="margin-bottom: 15px;">{% trans %}Statistics{% endtrans %}</h2>

<div class="stats-card">
    {% set clamped_percentage = [percentage, 0]|max %}
    {% set clamped_percentage = [clamped_percentage, 100]|min %}
    <div class="stats-content">
        <div class="stats-percentage">
            <div class="stats-percentage-value">{{ "%.1f"|format(clamped_percentage) }}%</div>
            <div class="stats-percentage-label">{% trans %}Overall Completion Rate{% endtrans %}</div>
        </div>
        <div class="stats-score-section">
            <div class="stats-score-header">
                <div class="stats-score-item">
                    <div class="stats-score-label">{% trans %}YOUR SCORE{% endtrans %}</div>
                    <div class="stats-score-value">{{ "%.1f"|format(total_score) }}</div>
                </div>
                <div class="stats-score-item stats-score-total">
                    <div class="stats-score-label">{% trans %}TOTAL POINTS{% endtrans %}</div>
                    <div class="stats-score-value">{{ "%.1f"|format(max_score) }}</div>
                </div>
            </div>
            <div class="stats-progress-track" role="progressbar" aria-valuenow="{{ clamped_percentage }}" aria-valuemin="0" aria-valuemax="100">
                <div class="stats-progress-fill {% if clamped_percentage >= 80 %}progress-green{% elif clamped_percentage >= 50 %}progress-orange{% else %}progress-red{% endif %}" style="width: {{ clamped_percentage }}%;"></div>
            </div>
        </div>
    </div>
</div>

<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <div style="flex: 1; background: #e8f5e9; border: 2px solid #28a745; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #28a745; line-height: 1;" id="solved-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #2e7d32; margin-top: 5px; opacity: 0.8;">{% trans %}Solved{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #fff8e1; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #f57c00; line-height: 1;" id="partial-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #ef6c00; margin-top: 5px; opacity: 0.8;">{% trans %}Partial{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #1976d2; line-height: 1;" id="attempted-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #1565c0; margin-top: 5px; opacity: 0.8;">{% trans %}Attempted{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #f5f5f5; border: 2px solid #616161; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #616161; line-height: 1;" id="not-attempted-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #424242; margin-top: 5px; opacity: 0.8;">{% trans %}Not Attempted{% endtrans %}</div>
    </div>
</div>

<h2 style="margin-bottom: 15px;">{% trans %}Task Archive{% endtrans %}</h2>

{% if task_scores|length == 0 %}
<p>{% trans %}No tasks available yet.{% endtrans %}</p>
{% else %}

<div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <span style="font-weight: bold; margin-right: 10px;">{% trans %}Filter:{% endtrans %}</span>
    <button class="btn btn-small filter-btn active" data-filter="all" onclick="filterTasks('all')">{% trans %}All{% endtrans %}</button>
    <button class="btn btn-small btn-success filter-btn" data-filter="solved" onclick="filterTasks('solved')">{% trans %}Solved{% endtrans %}</button>
    <button class="btn btn-small btn-warning filter-btn" data-filter="partial" onclick="filterTasks('partial')">{% trans %}Partial{% endtrans %}</button>
    <button class="btn btn-small btn-info filter-btn" data-filter="attempted" onclick="filterTasks('attempted')">{% trans %}Attempted{% endtrans %}</button>
    <button class="btn btn-small filter-btn" data-filter="not-attempted" onclick="filterTasks('not-attempted')" style="background-color: #616161; color: white; background-image: none; text-shadow: none;">{% trans %}Not Attempted{% endtrans %}</button>
</div>

<table class="table table-bordered table-striped" id="task-table">
    <thead>
        <tr>
            <th style="cursor: pointer;" onclick="sortTable(0)">{% trans %}Task{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Name{% endtrans %}</th>
            <th style="cursor: pointer;" onclick="sortTable(2)">{% trans %}Score{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Status{% endtrans %}</th>
            <th style="cursor: pointer;" onclick="sortTable(4)">{% trans %}Assigned{% endtrans %} <span class="sort-icon"></span></th>
            <th style="cursor: pointer;" onclick="sortTable(5)">{% trans %}Source{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Submit{% endtrans %}</th>
        </tr>
    </thead>
    <tbody>
{% for ts in task_scores %}
        <tr data-status="{% if ts.score >= ts.max_score %}solved{% elif ts.score > 0 %}partial{% elif ts.submission_count > 0 %}attempted{% else %}not-attempted{% endif %}" data-score="{{ ts.score }}" data-assigned="{{ ts.assigned_at.timestamp() if ts.assigned_at else 0 }}" data-source="{{ ts.source_training_day.name if ts.source_training_day else '' }}" data-submissions="{{ ts.submission_count }}">
            <td><a href="{{ contest_url("tasks", ts.task.name, "description") }}" style="font-weight: bold;">{{ ts.task.name }}</a></td>
            <td>{{ ts.task.title }}</td>
            <td>
    {% if ts.max_score == 100.0 %}
                <span style="font-weight: bold;">{{ "%.0f"|format(ts.score) }}</span>
    {% else %}
                <span style="font-weight: bold;">{{ "%.1f"|format(ts.score) }}/{{ "%.0f"|format(ts.max_score) }}</span>
    {% endif %}
            </td>
            <td>
    {% if ts.score >= ts.max_score %}
                <span class="label label-success" style="font-size: 12px;">{% trans %}Solved{% endtrans %}</span>
    {% elif ts.score > 0 %}
                <span class="label label-warning" style="font-size: 12px;">{% trans %}Partial{% endtrans %}</span>
    {% elif ts.submission_count > 0 %}
                <span class="label label-info" style="font-size: 12px;">{% trans %}Attempted{% endtrans %}</span>
    {% else %}
                <span class="label" style="font-size: 12px; background-color: #9e9e9e;">{% trans %}Not Attempted{% endtrans %}</span>
    {% endif %}
            </td>
            <td>
    {% if ts.assigned_at %}
                {{ ts.assigned_at.strftime("%Y-%m-%d") }}
    {% else %}
                -
    {% endif %}
            </td>
            <td>
    {% if ts.source_training_day %}
                {{ ts.source_training_day.description or ts.source_training_day.name or "Training" }}
    {% else %}
                <em>{% trans %}Manual{% endtrans %}</em>
    {% endif %}
            </td>
            <td>
                <a href="{{ contest_url("tasks", ts.task.name, "submissions") }}" class="btn btn-small btn-primary"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -1px; margin-right: 4px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>{% trans %}Submit{% endtrans %}</a>
            </td>
        </tr>
{% endfor %}
    </tbody>
</table>
{% endif %}

</div>

<style>
.filter-btn {
    transition: all 0.2s ease;
}
.filter-btn.active {
    box-shadow: 0 0 0 2px #333;
}
.filter-btn:hover {
    opacity: 0.8;
}
#task-table th[onclick]:hover {
    background-color: #e9ecef;
}
.sort-icon::after {
    content: '\2195';
    margin-left: 5px;
    opacity: 0.5;
}
.sort-asc .sort-icon::after {
    content: '\2191';
    opacity: 1;
}
.sort-desc .sort-icon::after {
    content: '\2193';
    opacity: 1;
}
.stats-card {
    background: #1e293b;
    border-radius: 16px;
    padding: 30px 40px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
.stats-content {
    display: flex;
    align-items: center;
    gap: 50px;
    flex-wrap: wrap;
}
.stats-percentage {
    flex: 0 0 auto;
}
.stats-percentage-value {
    font-size: 52px;
    font-weight: 700;
    color: #fff;
    line-height: 1;
}
.stats-percentage-label {
    font-size: 14px;
    color: rgba(255,255,255,0.7);
    margin-top: 10px;
}
.stats-score-section {
    flex: 1;
    min-width: 300px;
}
.stats-score-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
}
.stats-score-item {
    text-align: left;
}
.stats-score-total {
    text-align: right;
}
.stats-score-label {
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
}
.stats-score-value {
    font-size: 28px;
    font-weight: 700;
    color: #fff;
}
.stats-progress-track {
    height: 12px;
    background: #334155;
    border-radius: 6px;
    overflow: hidden;
}
.stats-progress-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease;
}
.stats-progress-fill.progress-red {
    background: linear-gradient(90deg, #ef4444, #f87171);
}
.stats-progress-fill.progress-orange {
    background: linear-gradient(90deg, #f97316, #fb923c);
}
.stats-progress-fill.progress-green {
    background: linear-gradient(90deg, #22c55e, #4ade80);
}
</style>

<script src="{{ url("static", "training_countdown.js") }}"></script>
<script>
// Count task statuses for statistics display
(function() {
    var solvedCount = 0, partialCount = 0, attemptedCount = 0, notAttemptedCount = 0;
    var rows = document.querySelectorAll('#task-table tbody tr');
    rows.forEach(function(row) {
        var status = row.getAttribute('data-status');
        if (status === 'solved') solvedCount++;
        else if (status === 'partial') partialCount++;
        else if (status === 'attempted') attemptedCount++;
        else notAttemptedCount++;
    });
    var solvedEl = document.getElementById('solved-count');
    if (solvedEl) solvedEl.textContent = solvedCount;
    var partialEl = document.getElementById('partial-count');
    if (partialEl) partialEl.textContent = partialCount;
    var attemptedEl = document.getElementById('attempted-count');
    if (attemptedEl) attemptedEl.textContent = attemptedCount;
    var notAttemptedEl = document.getElementById('not-attempted-count');
    if (notAttemptedEl) notAttemptedEl.textContent = notAttemptedCount;
})();

// Initialize countdowns using shared library
TrainingCountdown.initCountdowns({{ server_timestamp.timestamp() * 1000 }}, Date.now());

// Task filtering
function filterTasks(filter) {
    var rows = document.querySelectorAll('#task-table tbody tr');
    rows.forEach(function(row) {
        var status = row.getAttribute('data-status');
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === filter) {
            btn.classList.add('active');
        }
    });
}

// Task table sorting using shared library
var sortDirection = {};
function sortTable(columnIndex) {
    TrainingCountdown.sortTable('task-table', columnIndex, sortDirection, function(row, colIdx) {
        if (colIdx === 2) {
            return parseFloat(row.getAttribute('data-score')) || 0;
        } else if (colIdx === 4) {
            return parseFloat(row.getAttribute('data-assigned')) || 0;
        } else if (colIdx === 5) {
            return row.getAttribute('data-source').toLowerCase();
        } else {
            return row.cells[colIdx].textContent.trim().toLowerCase();
        }
    });
}
</script>

{% endblock core %}

