{% extends "contest.html" %}
{% from "macro/delay_request.html" import delay_request_form, delay_request_list with context %}

{% set page = "training_overview" %}

{% block core %}

<div class="span9">

<div class="page-header">
    <h1>{{ training_program.description if training_program.description else training_program.name }}</h1>
</div>

{% if upcoming_training_days|length > 0 %}
<h2 class="tp-section-heading">{% trans %}Upcoming Training Days{% endtrans %}</h2>

<div class="training-day-list">
{% for td_info in upcoming_training_days %}
    <div class="training-day-card {% if td_info.has_started %}started{% else %}upcoming{% endif %}">
        <div class="training-day-meta">
            <h3 class="training-day-title">{{ td_info.contest.description }}</h3>
            <div class="training-day-detail">
                <strong>{% trans %}Start:{% endtrans %}</strong> {{ td_info.user_start_time|format_datetime_smart }}
            </div>
            <div class="training-day-detail">
                <strong>{% trans %}Duration:{% endtrans %}</strong> {{ (td_info.duration.total_seconds() // 3600)|int }}h{% if (td_info.duration.total_seconds() % 3600) // 60 > 0 %} {{ ((td_info.duration.total_seconds() % 3600) // 60)|int }}m{% endif %}
            </div>
        </div>

        {% if td_info.has_started %}
        <div class="training-day-status">
            <div class="countdown-display live-pill">
                <span class="countdown-running">â¬¤ {% trans %}LIVE{% endtrans %}</span>
            </div>
        </div>
        {% else %}
        <div class="training-day-status">
            <div class="training-day-countdown-label">{% trans %}Starts in:{% endtrans %}</div>
            <div class="countdown training-day-countdown" data-start-time="{{ td_info.user_start_time.timestamp() * 1000 }}">
                <span class="countdown-text training-day-countdown-text">
                    <span class="countdown-days">--</span>d
                    <span class="countdown-hours">--</span>h
                    <span class="countdown-minutes">--</span>m
                    <span class="countdown-seconds">--</span>s
                </span>
            </div>
        </div>
        {% endif %}

        <div class="training-day-actions">
            {% if td_info.has_started or td_info.can_enter_soon %}
            <a href="{{ url[td_info.contest.name]() }}" class="btn {% if td_info.has_started %}btn-success{% else %}btn-primary{% endif %} training-day-btn training-day-enter-btn">{% trans %}Enter Training{% endtrans %} <i class="icon-chevron-right icon-white"></i></a>
            {% endif %}
            {% if td_info.contest.allow_delay_requests %}
            <div class="btn-group training-day-delay-group{% if td_info.participation.delay_requests|length == 0 %} single{% endif %}" role="group" aria-label="{% trans %}Delay request actions{% endtrans %}">
                <button type="button" class="btn btn-warning training-day-btn training-day-delay-btn" data-toggle="modal" data-target="#delay-modal-{{ loop.index }}" aria-label="{% trans %}Request a delay for this training day{% endtrans %}">{% trans %}Request a Delay{% endtrans %} <i class="icon-time icon-white"></i></button>
                {% if td_info.participation.delay_requests|length > 0 %}
                  <button type="button" class="btn btn-info training-day-btn training-day-requests-btn" title="{% trans %}View Requests{% endtrans %}" aria-label="{% trans count=td_info.participation.delay_requests|length %}View {{ count }} delay request(s){% endtrans %}" data-toggle="modal" data-target="#delay-requests-modal-{{ loop.index }}">({{ td_info.participation.delay_requests|length }}) <i class="icon-list icon-white"></i></button>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    {% if td_info.contest.allow_delay_requests %}
    <div id="delay-modal-{{ loop.index }}" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="delay-modal-label-{{ loop.index }}" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="{% trans %}Close{% endtrans %}"><span aria-hidden="true">&times;</span></button>
            <h3 id="delay-modal-label-{{ loop.index }}">{% trans %}Request a Delay{% endtrans %} - {{ td_info.contest.description }}</h3>
        </div>
        <div class="modal-body">
            <p class="text-info" style="margin-bottom: 15px;">
                {% trans %}Current start time:{% endtrans %} <strong>{{ td_info.user_start_time|format_datetime_smart }}</strong>
            </p>
            {{ delay_request_form(url[td_info.contest.name]("delay_request"), xsrf_form_html, timezone, now, form_id="delay-form-" ~ loop.index, inline=True, next_url="/" ~ training_program.name ~ "/training_overview") }}
        </div>
    </div>
    {% endif %}

    {% if td_info.participation.delay_requests|length > 0 %}
    <div id="delay-requests-modal-{{ loop.index }}" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="delay-requests-modal-label-{{ loop.index }}" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="{% trans %}Close{% endtrans %}"><span aria-hidden="true">&times;</span></button>
            <h3 id="delay-requests-modal-label-{{ loop.index }}">{% trans %}Your Delay Requests{% endtrans %} - {{ td_info.contest.description }}</h3>
        </div>
        <div class="modal-body">
            {{ delay_request_list(td_info.participation.delay_requests) }}
        </div>
        <div class="modal-footer">
            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans %}Close{% endtrans %}</button>
        </div>
    </div>
    {% endif %}
{% endfor %}
</div>
{% endif %}

<h2 style="margin-bottom: 15px;">{% trans %}Statistics{% endtrans %}</h2>

<div class="training-program-summary" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 12px; margin-bottom: 25px; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
    <p style="font-size: 16px; opacity: 0.9; margin-bottom: 20px;">{{ training_program.description }}</p>

    <div style="display: flex; gap: 40px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
            <div style="font-size: 48px; font-weight: bold;">
                {{ "%.1f"|format(percentage) }}%
            </div>
            <div style="margin-top: 15px; font-size: 14px; opacity: 0.8;">{% trans %}Completion{% endtrans %}</div>
        </div>
        <div style="flex: 2; min-width: 300px;">
          {% set clamped_percentage = [percentage, 0]|max %}
          {% set clamped_percentage = [clamped_percentage, 100]|min %}
          <div class="progress-track" role="progressbar" aria-valuenow="{{ clamped_percentage }}" aria-valuemin="0" aria-valuemax="100">
              <div class="progress-fill {% if percentage >= 80 %}high{% elif percentage >= 50 %}med{% else %}low{% endif %}"
                  style="width: {{ clamped_percentage }}%;">
              </div>
          </div>
          <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; opacity: 0.8;">
              <span>{{ "%.1f"|format(total_score) }} {% trans %}points{% endtrans %}</span>
              <span>{{ "%.1f"|format(max_score) }} {% trans %}total{% endtrans %}</span>
          </div>
      </div>
    </div>
</div>

<div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
    <div style="flex: 1; background: #e8f5e9; border: 2px solid #28a745; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #28a745; line-height: 1;" id="solved-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #2e7d32; margin-top: 5px; opacity: 0.8;">{% trans %}Solved{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #fff8e1; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #f57c00; line-height: 1;" id="partial-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #ef6c00; margin-top: 5px; opacity: 0.8;">{% trans %}Partial{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #1976d2; line-height: 1;" id="attempted-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #1565c0; margin-top: 5px; opacity: 0.8;">{% trans %}Attempted{% endtrans %}</div>
    </div>
    <div style="flex: 1; background: #f5f5f5; border: 2px solid #9e9e9e; border-radius: 8px; padding: 15px; text-align: center; min-width: 100px;">
        <div style="font-size: 36px; font-weight: 800; color: #616161; line-height: 1;" id="not-attempted-count">0</div>
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #424242; margin-top: 5px; opacity: 0.8;">{% trans %}Not Attempted{% endtrans %}</div>
    </div>
</div>

<h2 style="margin-bottom: 15px;">{% trans %}Task Archive{% endtrans %}</h2>

{% if task_scores|length == 0 %}
<p>{% trans %}No tasks available yet.{% endtrans %}</p>
{% else %}

<div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
    <span style="font-weight: bold; margin-right: 10px;">{% trans %}Filter:{% endtrans %}</span>
    <button class="btn btn-small filter-btn active" data-filter="all" onclick="filterTasks('all')">{% trans %}All{% endtrans %}</button>
    <button class="btn btn-small btn-success filter-btn" data-filter="solved" onclick="filterTasks('solved')">{% trans %}Solved{% endtrans %}</button>
    <button class="btn btn-small btn-warning filter-btn" data-filter="partial" onclick="filterTasks('partial')">{% trans %}Partial{% endtrans %}</button>
    <button class="btn btn-small btn-info filter-btn" data-filter="attempted" onclick="filterTasks('attempted')">{% trans %}Attempted{% endtrans %}</button>
    <button class="btn btn-small filter-btn" data-filter="not-attempted" onclick="filterTasks('not-attempted')" style="background-color: #9e9e9e; color: white;">{% trans %}Not Attempted{% endtrans %}</button>
</div>

<table class="table table-bordered table-striped" id="task-table">
    <thead>
        <tr>
            <th style="cursor: pointer;" onclick="sortTable(0)">{% trans %}Task{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Name{% endtrans %}</th>
            <th style="cursor: pointer;" onclick="sortTable(2)">{% trans %}Score{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Status{% endtrans %}</th>
            <th style="cursor: pointer;" onclick="sortTable(4)">{% trans %}Assigned{% endtrans %} <span class="sort-icon"></span></th>
            <th style="cursor: pointer;" onclick="sortTable(5)">{% trans %}Source{% endtrans %} <span class="sort-icon"></span></th>
            <th>{% trans %}Submit{% endtrans %}</th>
        </tr>
    </thead>
    <tbody>
{% for ts in task_scores %}
        <tr data-status="{% if ts.score >= ts.max_score %}solved{% elif ts.score > 0 %}partial{% elif ts.submission_count > 0 %}attempted{% else %}not-attempted{% endif %}" data-score="{{ ts.score }}" data-assigned="{{ ts.assigned_at.timestamp() if ts.assigned_at else 0 }}" data-source="{{ ts.source_training_day.name if ts.source_training_day else '' }}" data-submissions="{{ ts.submission_count }}">
            <td><a href="{{ contest_url("tasks", ts.task.name, "description") }}" style="font-weight: bold;">{{ ts.task.name }}</a></td>
            <td>{{ ts.task.title }}</td>
            <td>
    {% if ts.max_score == 100.0 %}
                <span style="font-weight: bold;">{{ "%.0f"|format(ts.score) }}</span>
    {% else %}
                <span style="font-weight: bold;">{{ "%.1f"|format(ts.score) }}/{{ "%.0f"|format(ts.max_score) }}</span>
    {% endif %}
            </td>
            <td>
    {% if ts.score >= ts.max_score %}
                <span class="label label-success" style="font-size: 12px;">{% trans %}Solved{% endtrans %}</span>
    {% elif ts.score > 0 %}
                <span class="label label-warning" style="font-size: 12px;">{% trans %}Partial{% endtrans %}</span>
    {% elif ts.submission_count > 0 %}
                <span class="label label-info" style="font-size: 12px;">{% trans %}Attempted{% endtrans %}</span>
    {% else %}
                <span class="label" style="font-size: 12px; background-color: #9e9e9e;">{% trans %}Not Attempted{% endtrans %}</span>
    {% endif %}
            </td>
            <td>
    {% if ts.assigned_at %}
                {{ ts.assigned_at.strftime("%Y-%m-%d") }}
    {% else %}
                -
    {% endif %}
            </td>
            <td>
    {% if ts.source_training_day %}
                {{ ts.source_training_day.description or ts.source_training_day.name or "Training" }}
    {% else %}
                <em>{% trans %}Manual{% endtrans %}</em>
    {% endif %}
            </td>
            <td>
                <a href="{{ contest_url("tasks", ts.task.name, "submissions") }}" class="btn btn-small btn-primary">{% trans %}Submit{% endtrans %}</a>
            </td>
        </tr>
{% endfor %}
    </tbody>
</table>
{% endif %}

</div>

<style>
.tp-section-heading {
    margin-bottom: 20px;
    font-size: 24px;
    font-weight: 600;
    color: #333;
}
.training-day-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
}
.training-day-card {
    background: #fff;
    border-left: 4px solid transparent;
    border-radius: 8px;
    padding: 20px 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    transition: all 0.3s ease;
}
.training-day-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.training-day-card.started { border-left-color: #28a745; }
.training-day-card.upcoming { border-left-color: #0d6efd; }
.training-day-meta { flex: 1; min-width: 250px; }
.training-day-title { margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #333; }
.training-day-detail { font-size: 14px; color: #666; margin-bottom: 4px; }
.training-day-status { text-align: center; flex: 0 0 auto; }
.training-day-status-label { font-size: 13px; color: #28a745; font-weight: 600; margin-bottom: 8px; }
.countdown-display { display: inline-block; border-radius: 8px; padding: 10px 15px; }
.countdown-running { font-size: 16px; font-weight: 700; color: white; letter-spacing: 1px; }
.live-pill { background: #dc3545; border-radius: 20px; padding: 12px 24px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); animation: pulse 2s ease-in-out infinite; }
.training-day-countdown-label { font-size: 13px; color: #666; margin-bottom: 8px; }
.training-day-countdown { display: inline-block; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 15px; }
.training-day-countdown-text { font-size: 16px; font-weight: 600; color: #0d6efd; }
.training-day-btn { font-weight: 600; padding: 9px 16px; font-size: 14px; line-height: 18px; text-align: center; }
.training-day-actions { display: flex; flex-direction: column; gap: 8px; flex: 0 0 auto; align-items: flex-end; }
.training-day-enter-btn { width: 220px; box-sizing: border-box; }
.training-day-delay-group { display: inline-flex; align-items: stretch; width: 220px; flex-shrink: 0; }
.training-day-delay-group > .btn { float: none; margin: 0; }
.training-day-delay-btn { flex: 1 1 auto; min-width: 0; width: 100%; }
.training-day-delay-group.single .training-day-delay-btn { width: 220px; }
.training-day-requests-btn {
    flex: 0 0 44px;
    width: 44px;
    text-align: center;
    padding: 6px 0;
    font-size: 12px;
    line-height: 16px;
}
.filter-btn {
    transition: all 0.2s ease;
}
.filter-btn.active {
    box-shadow: 0 0 0 2px #333;
}
.filter-btn:hover {
    opacity: 0.8;
}
#task-table th[onclick]:hover {
    background-color: #e9ecef;
}
.sort-icon::after {
    content: '\2195';
    margin-left: 5px;
    opacity: 0.5;
}
.sort-asc .sort-icon::after {
    content: '\2191';
    opacity: 1;
}
.sort-desc .sort-icon::after {
    content: '\2193';
    opacity: 1;
}
@keyframes pulse {
    0%, 100% { box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); }
    50% { box-shadow: 0 2px 16px rgba(220, 53, 69, 0.6); }
}
</style>

<script>
(function() {
    var solvedCount = 0, partialCount = 0, attemptedCount = 0, notAttemptedCount = 0;
    var rows = document.querySelectorAll('#task-table tbody tr');
    rows.forEach(function(row) {
        var status = row.getAttribute('data-status');
        if (status === 'solved') solvedCount++;
        else if (status === 'partial') partialCount++;
        else if (status === 'attempted') attemptedCount++;
        else notAttemptedCount++;
    });
    var solvedEl = document.getElementById('solved-count');
    if (solvedEl) solvedEl.textContent = solvedCount;
    var partialEl = document.getElementById('partial-count');
    if (partialEl) partialEl.textContent = partialCount;
    var attemptedEl = document.getElementById('attempted-count');
    if (attemptedEl) attemptedEl.textContent = attemptedCount;
    var notAttemptedEl = document.getElementById('not-attempted-count');
    if (notAttemptedEl) notAttemptedEl.textContent = notAttemptedCount;
})();

// Server timestamp for timezone-correct countdown
var serverTimestamp = {{ server_timestamp.timestamp() * 1000 }};
var clientLoadTime = new Date().getTime();
var reloadScheduled = false;
var reloadBackoffMs = 1000;

async function checkAndMaybeReload(startTimeMs) {
    try {
        const res = await fetch(window.location.href, { method: 'HEAD', cache: 'no-store' });
        const dateHeader = res.headers.get('Date');
        const serverNow = dateHeader ? Date.parse(dateHeader) : NaN;
        if (!Number.isNaN(serverNow) && serverNow < startTimeMs) {
            reloadBackoffMs = Math.min(reloadBackoffMs * 2, 30000);
            setTimeout(function() { checkAndMaybeReload(startTimeMs); }, reloadBackoffMs);
            return;
        }
    } catch (e) {
        // fall through to reload
    }
    window.location.reload();
}

function updateCountdowns() {
    var countdowns = document.querySelectorAll('.countdown');
    var elapsed = new Date().getTime() - clientLoadTime;
    var serverNow = serverTimestamp + elapsed;

    countdowns.forEach(function(el) {
        var startTimeAttr = el.getAttribute('data-start-time');
        if (!startTimeAttr) return;
        var startTime = parseFloat(startTimeAttr);
        if (isNaN(startTime)) return;

        var diff = startTime - serverNow;

        var daysEl = el.querySelector('.countdown-days');
        var hoursEl = el.querySelector('.countdown-hours');
        var minutesEl = el.querySelector('.countdown-minutes');
        var secondsEl = el.querySelector('.countdown-seconds');

        if (diff <= 0) {
            if (daysEl) daysEl.textContent = '0';
            if (hoursEl) hoursEl.textContent = '0';
            if (minutesEl) minutesEl.textContent = '0';
            if (secondsEl) secondsEl.textContent = '0';
            if (!reloadScheduled) {
                reloadScheduled = true;
                checkAndMaybeReload(startTime);
            }
            return;
        }

        var days = Math.floor(diff / (1000 * 60 * 60 * 24));
        var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((diff % (1000 * 60)) / 1000);

        if (daysEl) daysEl.textContent = days;
        if (hoursEl) hoursEl.textContent = hours;
        if (minutesEl) minutesEl.textContent = minutes;
        if (secondsEl) secondsEl.textContent = seconds;
    });
}

updateCountdowns();
setInterval(updateCountdowns, 1000);

function filterTasks(filter) {
    var rows = document.querySelectorAll('#task-table tbody tr');
    rows.forEach(function(row) {
        var status = row.getAttribute('data-status');
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });

    document.querySelectorAll('.filter-btn').forEach(function(btn) {
        btn.classList.remove('active');
        if (btn.getAttribute('data-filter') === filter) {
            btn.classList.add('active');
        }
    });
}

var sortDirection = {};
function sortTable(columnIndex) {
    var table = document.getElementById('task-table');
    var tbody = table.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    var headers = table.querySelectorAll('th');

    sortDirection[columnIndex] = !sortDirection[columnIndex];
    var ascending = sortDirection[columnIndex];

    headers.forEach(function(h, i) {
        h.classList.remove('sort-asc', 'sort-desc');
        if (i === columnIndex) {
            h.classList.add(ascending ? 'sort-asc' : 'sort-desc');
        }
    });

    rows.sort(function(a, b) {
        var aVal, bVal;
        if (columnIndex === 2) {
            aVal = parseFloat(a.getAttribute('data-score')) || 0;
            bVal = parseFloat(b.getAttribute('data-score')) || 0;
        } else if (columnIndex === 4) {
            aVal = parseFloat(a.getAttribute('data-assigned')) || 0;
            bVal = parseFloat(b.getAttribute('data-assigned')) || 0;
        } else if (columnIndex === 5) {
            aVal = a.getAttribute('data-source').toLowerCase();
            bVal = b.getAttribute('data-source').toLowerCase();
        } else {
            aVal = a.cells[columnIndex].textContent.trim().toLowerCase();
            bVal = b.cells[columnIndex].textContent.trim().toLowerCase();
        }

        if (aVal < bVal) return ascending ? -1 : 1;
        if (aVal > bVal) return ascending ? 1 : -1;
        return 0;
    });

    rows.forEach(function(row) {
        tbody.appendChild(row);
    });
}
</script>

{% endblock core %}
